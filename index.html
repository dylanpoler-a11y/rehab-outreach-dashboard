<!DOCTYPE html>
<!-- v2026.02.14 -->
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Behavioral Health Outreach Hub</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-primary: #0a0e1a;
  --bg-secondary: #111827;
  --bg-card: rgba(17, 24, 39, 0.8);
  --bg-glass: rgba(255, 255, 255, 0.03);
  --border: rgba(255, 255, 255, 0.06);
  --border-bright: rgba(255, 255, 255, 0.12);
  --text-primary: #f1f5f9;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --accent-blue: #3b82f6;
  --accent-cyan: #06b6d4;
  --accent-purple: #8b5cf6;
  --accent-green: #10b981;
  --accent-orange: #f59e0b;
  --accent-red: #ef4444;
  --accent-pink: #ec4899;
  --glow-blue: rgba(59, 130, 246, 0.3);
}

body {
  font-family: 'Inter', -apple-system, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background:
    radial-gradient(ellipse 80% 50% at 20% 20%, rgba(59, 130, 246, 0.06), transparent),
    radial-gradient(ellipse 60% 40% at 80% 80%, rgba(139, 92, 246, 0.05), transparent),
    radial-gradient(ellipse 50% 50% at 50% 50%, rgba(6, 182, 212, 0.03), transparent);
  pointer-events: none;
  z-index: 0;
}

.app { position: relative; z-index: 1; }

/* Header */
.header {
  padding: 16px 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
  backdrop-filter: blur(20px);
  background: rgba(10, 14, 26, 0.9);
  position: sticky;
  top: 0;
  z-index: 1000;
}

.header-left { display: flex; align-items: center; gap: 16px; }

.logo {
  width: 40px; height: 40px;
  background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-weight: 900; font-size: 18px;
  box-shadow: 0 0 20px var(--glow-blue);
}

.header h1 {
  font-size: 20px; font-weight: 700;
  background: linear-gradient(135deg, #fff, #94a3b8);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  letter-spacing: -0.5px;
}

.header-subtitle { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
.header-right { display: flex; align-items: center; gap: 12px; }


.refresh-group { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
.refresh-btn {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 20px; background: var(--bg-glass);
  border: 1px solid var(--border-bright); border-radius: 10px;
  color: var(--text-secondary); font-weight: 600; font-size: 13px;
  cursor: pointer; transition: all 0.3s; font-family: inherit;
}
.refresh-btn:hover { color: var(--text-primary); border-color: var(--accent-blue); background: rgba(59,130,246,0.1); transform: translateY(-1px); }
.refresh-btn.refreshing svg { animation: spin 1s linear infinite; }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
.refresh-meta { display: flex; align-items: center; gap: 8px; font-size: 10px; color: var(--text-muted); }
.refresh-timestamp { opacity: 0.7; }
.refresh-auto-badge {
  display: flex; align-items: center; gap: 4px;
  padding: 2px 7px; border-radius: 6px;
  background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.25);
  color: #10b981; font-weight: 600; font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px;
}
.auto-dot {
  width: 5px; height: 5px; border-radius: 50%;
  background: #10b981; animation: pulse-dot 2s ease-in-out infinite;
}
@keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

.live-badge {
  display: flex; align-items: center; gap: 6px;
  padding: 6px 14px;
  background: rgba(16, 185, 129, 0.1);
  border: 1px solid rgba(16, 185, 129, 0.2);
  border-radius: 20px; font-size: 12px;
  color: var(--accent-green); font-weight: 500;
}

.live-dot {
  width: 6px; height: 6px; background: var(--accent-green);
  border-radius: 50%; animation: pulse-dot 2s infinite;
}

@keyframes pulse-dot {
  0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
  50% { opacity: 0.7; box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
}

/* KPI Row */
.kpi-row { display: grid; grid-template-columns: repeat(7, 1fr); gap: 12px; padding: 20px 32px; }

.kpi-card {
  background: var(--bg-glass); border: 1px solid var(--border);
  border-radius: 14px; padding: 16px; backdrop-filter: blur(10px);
  transition: all 0.3s; position: relative; overflow: hidden;
}
.kpi-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0;
  height: 2px; background: var(--kpi-color, var(--accent-blue)); opacity: 0.6;
}
.kpi-card { cursor: pointer; }
.kpi-card:hover { border-color: var(--border-bright); transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0,0,0,0.3); }
.kpi-card.selected { border-color: var(--kpi-color, var(--accent-blue)); box-shadow: 0 0 20px color-mix(in srgb, var(--kpi-color, var(--accent-blue)) 35%, transparent), 0 4px 20px rgba(0,0,0,0.3); transform: translateY(-3px); }
.kpi-card.selected::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: var(--kpi-color, var(--accent-blue)); opacity: 0.8; }
.kpi-card:not(.selected).dimmed { opacity: 0.4; }
.kpi-label { font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
.kpi-value { font-size: 28px; font-weight: 800; letter-spacing: -1px; }
.kpi-sub { font-size: 11px; color: var(--text-secondary); margin-top: 4px; }

/* Main layout */
.main-content { display: grid; grid-template-columns: 260px 1fr; gap: 0; min-height: calc(100vh - 200px); }

/* Sidebar */
.sidebar {
  border-right: 1px solid var(--border);
  padding: 20px 16px; background: rgba(10, 14, 26, 0.5);
  backdrop-filter: blur(10px); overflow-y: auto;
  max-height: calc(100vh - 180px); position: sticky; top: 72px;
}

.filter-section { margin-bottom: 24px; }

.filter-title {
  font-size: 10px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 1.5px; color: var(--text-muted); margin-bottom: 10px;
  display: flex; align-items: center; gap: 8px;
}
.filter-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.color-mode-btn {
  background: none; border: 1px solid var(--border); color: var(--text-muted);
  font-size: 9px; padding: 2px 7px; border-radius: 6px; cursor: pointer;
  font-family: inherit; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase;
  transition: all 0.2s; white-space: nowrap; flex-shrink: 0;
}
.color-mode-btn:hover { border-color: var(--accent-cyan); color: var(--accent-cyan); }
.color-mode-btn.active { background: rgba(6,182,212,0.12); border-color: rgba(6,182,212,0.4); color: var(--accent-cyan); }

.filter-btn {
  display: flex; align-items: center; gap: 10px; width: 100%;
  padding: 8px 10px; background: transparent; border: 1px solid transparent;
  border-radius: 8px; color: var(--text-secondary); font-size: 12px;
  font-weight: 500; cursor: pointer; transition: all 0.2s;
  font-family: inherit; text-align: left; user-select: none;
}
.filter-btn:hover { background: var(--bg-glass); border-color: var(--border); color: var(--text-primary); }
.filter-btn.active { background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3); color: var(--accent-blue); }

.filter-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

/* Drag-and-drop reorder for filter priority */
.sortable-filter .filter-btn { cursor: grab; }
.sortable-filter .filter-btn:active { cursor: grabbing; }
.filter-btn.sortable-ghost { opacity: 0.2; border: 1px dashed var(--accent-cyan); }
.filter-btn.sortable-drag { opacity: 1; background: rgba(6,182,212,0.12); border-color: var(--accent-cyan); box-shadow: 0 8px 24px rgba(0,0,0,0.4); z-index: 9999; cursor: grabbing; }
.filter-btn.sortable-chosen { cursor: grabbing; }

.filter-count {
  margin-left: auto; font-size: 10px; font-weight: 600;
  color: var(--text-muted); background: rgba(255,255,255,0.05);
  padding: 2px 7px; border-radius: 6px;
}
.filter-btn.active .filter-count { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); }

/* Solo-highlighted filter (clicked for map isolation) */
.filter-btn.solo {
  background: rgba(255,255,255,0.08); border-color: var(--solo-color, var(--accent-cyan));
  box-shadow: 0 0 12px color-mix(in srgb, var(--solo-color, var(--accent-cyan)) 30%, transparent);
  color: var(--text-primary);
}
.filter-btn.solo .filter-count { background: rgba(255,255,255,0.12); color: var(--text-primary); }

/* Dim non-solo filters when a solo is active */
.filter-section.has-solo .filter-btn:not(.solo) { opacity: 0.35; }
.filter-section.has-solo .filter-btn:not(.solo):hover { opacity: 0.6; }


.search-wrap { position: relative; margin-bottom: 20px; }

.search-input {
  width: 100%; padding: 10px 12px 10px 36px;
  background: var(--bg-glass); border: 1px solid var(--border);
  border-radius: 10px; color: var(--text-primary); font-size: 13px;
  font-family: inherit; outline: none; transition: border-color 0.2s;
}
.search-input:focus { border-color: var(--accent-blue); }
.search-input::placeholder { color: var(--text-muted); }

.search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); width: 14px; height: 14px; }

/* Map */
.map-area { display: flex; flex-direction: column; }

.map-controls {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 24px; border-bottom: 1px solid var(--border);
  background: rgba(10, 14, 26, 0.5);
}

.map-controls-left { display: flex; align-items: center; gap: 8px; }

.view-toggle { display: flex; background: var(--bg-glass); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }

.view-btn {
  padding: 8px 16px; background: transparent; border: none;
  color: var(--text-muted); font-size: 12px; font-weight: 600;
  cursor: pointer; font-family: inherit; transition: all 0.2s;
}
.view-btn.active { background: var(--accent-blue); color: white; }

.map-legend { display: flex; align-items: center; gap: 16px; font-size: 11px; color: var(--text-secondary); }
.legend-item { display: flex; align-items: center; gap: 6px; }
.legend-dot { width: 10px; height: 10px; border-radius: 50%; border: 2px solid; }

#mapWrapper { flex: 1; min-height: 520px; }
#map { height: 100%; min-height: 520px; background: var(--bg-secondary); }

.leaflet-container { background: var(--bg-secondary) !important; font-family: 'Inter', sans-serif !important; }

.custom-marker { border-radius: 50%; transition: transform 0.2s; cursor: pointer; }
.custom-marker:hover { transform: scale(1.3); }
.secondary-marker { opacity: 0.7; }
.secondary-marker:hover { opacity: 1; }

/* Bradford Facility — star marker */
.bradford-marker { transition: transform 0.2s; cursor: pointer; }
.bradford-marker:hover { transform: scale(1.3); }
.bradford-marker.bf-gold { filter: drop-shadow(0 0 6px rgba(251,191,36,0.6)); }
.bradford-marker.bf-gold:hover { filter: drop-shadow(0 0 10px rgba(251,191,36,0.8)); }
.bradford-marker.bf-purple { filter: drop-shadow(0 0 6px rgba(168,85,247,0.6)); }
.bradford-marker.bf-purple:hover { filter: drop-shadow(0 0 10px rgba(168,85,247,0.8)); }
.bradford-ring { animation: bradford-pulse 2.5s ease-in-out infinite; border-radius: 50%; pointer-events: none; position: absolute; }
@keyframes bradford-pulse {
  0%, 100% { opacity: 0.4; transform: scale(1); }
  50% { opacity: 0.8; transform: scale(1.2); }
}

.ghost-marker { border-radius: 50%; cursor: pointer; animation: ghost-pulse 2s ease-in-out infinite; }
@keyframes ghost-pulse {
  0%, 100% { opacity: 0.7; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.2); }
}

.ghost-line { stroke-dasharray: 6 4; animation: ghost-dash 1s linear infinite; }
@keyframes ghost-dash { to { stroke-dashoffset: -10; } }

.state-label {
  background: none !important; border: none !important; box-shadow: none !important;
  color: rgba(255,255,255,0.35); font-size: 10px; font-weight: 700; font-family: 'Inter', sans-serif;
  letter-spacing: 0.5px; text-align: center; white-space: nowrap; pointer-events: none;
}
.state-label-active {
  color: rgba(59,130,246,0.8) !important; font-size: 11px;
}

.custom-popup .leaflet-popup-content-wrapper {
  background: var(--bg-secondary) !important; color: var(--text-primary) !important;
  border: 1px solid var(--border-bright) !important; border-radius: 14px !important;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5) !important; padding: 0 !important;
}
.custom-popup .leaflet-popup-tip { background: var(--bg-secondary) !important; border: 1px solid var(--border-bright) !important; }
.custom-popup .leaflet-popup-close-btn { color: var(--text-muted) !important; font-size: 18px !important; top: 8px !important; right: 8px !important; }

.popup-content { padding: 16px; min-width: 280px; max-width: 340px; }
.popup-name { font-size: 15px; font-weight: 700; color: var(--text-primary); line-height: 1.3; cursor: grab; user-select: none; }
.popup-name:active { cursor: grabbing; }
.popup-badge { display: inline-block; padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }
.popup-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid var(--border); font-size: 12px; }
.popup-row:last-child { border-bottom: none; }
.popup-label { color: var(--text-muted); }
.popup-val { color: var(--text-primary); font-weight: 600; max-width: 180px; text-align: right; }

.popup-link {
  display: inline-block; margin-top: 10px; padding: 6px 14px;
  background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 8px; color: var(--accent-blue); font-size: 12px;
  font-weight: 600; text-decoration: none; transition: all 0.2s;
}
.popup-link:hover { background: rgba(59, 130, 246, 0.25); }

/* Charts section */
.charts-section { padding: 24px 32px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

.chart-card {
  background: var(--bg-glass); border: 1px solid var(--border);
  border-radius: 16px; padding: 24px; backdrop-filter: blur(10px);
}
.chart-card.full-width { grid-column: 1 / -1; }

.chart-title { font-size: 14px; font-weight: 700; margin-bottom: 16px; color: var(--text-primary); }
.chart-subtitle { font-size: 11px; color: var(--text-muted); margin-top: -12px; margin-bottom: 16px; }

/* Bar chart */
.bar-chart { display: flex; flex-direction: column; gap: 8px; }
.bar-row { display: flex; align-items: center; gap: 12px; }
.bar-label { width: 120px; font-size: 12px; color: var(--text-secondary); text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.bar-track { flex: 1; height: 26px; background: rgba(255,255,255,0.03); border-radius: 6px; overflow: hidden; }
.bar-fill { height: 100%; border-radius: 6px; transition: width 1s ease; display: flex; align-items: center; padding-left: 10px; font-size: 11px; font-weight: 700; color: white; min-width: 30px; }
.bar-value { font-size: 12px; font-weight: 700; color: var(--text-primary); width: 40px; text-align: right; }

/* State filter pills (removed — now click states on the map) */

/* Clickable bar rows */
.bar-row.clickable { cursor: pointer; border-radius: 6px; padding: 2px 0; transition: background 0.2s; }
.bar-row.clickable:hover { background: rgba(255,255,255,0.04); }
.bar-row.clickable.active { background: rgba(59, 130, 246, 0.1); }
.bar-row.clickable.active .bar-label { color: var(--accent-blue); font-weight: 700; }

.state-filter-badge {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 4px 12px; border-radius: 8px; font-size: 12px; font-weight: 600;
  background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3);
  color: var(--accent-blue); cursor: pointer; transition: all 0.2s;
}
.state-filter-badge:hover { background: rgba(59, 130, 246, 0.25); }
.state-filter-badge svg { width: 12px; height: 12px; }

.chart-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; gap: 8px; }
.chart-header .chart-title { margin-bottom: 0; }

/* Donut */
.donut-container { display: flex; align-items: center; gap: 32px; }
.donut-svg { width: 160px; height: 160px; }
.donut-legend { display: flex; flex-direction: column; gap: 8px; }
.donut-legend-item { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-secondary); transition: opacity 0.2s; }
.donut-legend-item.dimmed { opacity: 0.3; }
.donut-legend-dot { width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0; }
.donut-legend-value { margin-left: auto; font-weight: 700; color: var(--text-primary); }

/* Funnel */
.funnel { display: flex; flex-direction: column; gap: 4px; align-items: center; }
.funnel-step { width: 100%; display: flex; align-items: center; gap: 12px; padding: 8px 0; }
.funnel-bar { height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 800; color: white; transition: width 1s ease; min-width: 50px; cursor: pointer; }
.funnel-bar:hover { filter: brightness(1.2); }
.funnel-step.selected .funnel-bar { box-shadow: 0 0 12px rgba(255,255,255,0.3); filter: brightness(1.15); }
.funnel-step.dimmed .funnel-bar { opacity: 0.3; }
.funnel-step.dimmed .funnel-info { opacity: 0.3; }
.funnel-info { display: flex; flex-direction: column; gap: 2px; }
.funnel-label { font-size: 13px; font-weight: 600; color: var(--text-primary); }
.funnel-pct { font-size: 11px; color: var(--text-muted); }

/* Pipeline section */
.pipeline-section { padding: 20px 32px 24px; }

.pipeline-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 20px;
}

.pipeline-header h2 {
  font-size: 18px; font-weight: 800;
  background: linear-gradient(135deg, var(--accent-orange), var(--accent-pink));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}

.pipeline-stats { display: flex; gap: 16px; }

.pipeline-stat {
  padding: 6px 14px; border-radius: 10px;
  background: var(--bg-glass); border: 1px solid var(--border);
  font-size: 12px; color: var(--text-secondary);
}
.pipeline-stat strong { color: var(--text-primary); font-weight: 700; }

.pipeline-board {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 16px;
}

.pipeline-col {
  background: var(--bg-glass); border: 1px solid var(--border);
  border-radius: 14px; padding: 16px; min-height: 200px;
}

.pipeline-col-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 14px; padding-bottom: 10px; border-bottom: 1px solid var(--border);
}

.pipeline-col-title { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
.pipeline-col-count {
  width: 24px; height: 24px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 800;
}

.pipeline-card {
  background: rgba(255,255,255,0.03); border: 1px solid var(--border);
  border-radius: 10px; padding: 12px; margin-bottom: 10px;
  transition: all 0.2s; cursor: grab; position: relative;
}
.pipeline-card:active { cursor: grabbing; }
.pipeline-card.sortable-ghost {
  opacity: 0.3; background: rgba(59,130,246,0.08);
  border: 1px dashed var(--accent-blue); border-radius: 10px;
}
.pipeline-card.sortable-drag {
  opacity: 1; box-shadow: 0 12px 40px rgba(0,0,0,0.5);
  transform: rotate(1.5deg); z-index: 9999; cursor: grabbing;
}
.pipeline-card.sortable-chosen { cursor: grabbing; }
.pipeline-col-cards { min-height: 40px; }
.pipeline-card:hover { border-color: var(--border-bright); transform: translateY(-1px); }

/* Selected pipeline card */
.pipeline-card.selected {
  border-color: var(--accent-cyan);
  background: rgba(6, 182, 212, 0.08);
  box-shadow: 0 0 12px rgba(6, 182, 212, 0.25), inset 0 0 0 1px rgba(6, 182, 212, 0.15);
  transform: translateY(-1px);
}
.pipeline-card.selected::after {
  content: '✓'; position: absolute; top: 6px; right: 34px;
  width: 16px; height: 16px; font-size: 10px; line-height: 16px; text-align: center;
  background: var(--accent-cyan); color: #0a0e1a; border-radius: 50%;
  font-weight: 800; box-shadow: 0 0 8px rgba(6,182,212,0.5);
}

/* Map highlight pulse for selected companies */
.highlight-marker { border-radius: 50%; animation: highlight-pulse 2s ease-in-out infinite; pointer-events: none; }
@keyframes highlight-pulse {
  0%, 100% { opacity: 0.6; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.15); }
}
.highlight-tooltip {
  background: rgba(6, 182, 212, 0.9) !important; border: none !important;
  border-radius: 6px !important; color: white !important;
  font-weight: 600 !important; font-size: 11px !important;
  padding: 4px 8px !important; box-shadow: 0 2px 10px rgba(0,0,0,0.3) !important;
}
.highlight-tooltip::before { border-top-color: rgba(6, 182, 212, 0.9) !important; }
.pipeline-card-name { font-size: 13px; font-weight: 700; color: var(--text-primary); margin-bottom: 6px; }
.pipeline-card-detail { font-size: 11px; color: var(--text-muted); margin-bottom: 3px; }
.pipeline-card-detail strong { color: var(--text-secondary); }

.pipeline-card-priority {
  display: inline-block; padding: 2px 8px; border-radius: 4px;
  font-size: 9px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.5px; margin-top: 4px;
}
.pipeline-card-badges { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
.pipeline-card-badge {
  display: inline-flex; align-items: center; gap: 3px; padding: 2px 6px;
  border-radius: 4px; font-size: 9px; font-weight: 600;
  background: rgba(255,255,255,0.04); color: var(--text-secondary);
  border: 1px solid var(--border);
}
.pipeline-card-badge.nda-signed { background: rgba(16,185,129,0.1); color: #10b981; border-color: rgba(16,185,129,0.2); }
.pipeline-card-badge.nda-sent { background: rgba(245,158,11,0.1); color: #f59e0b; border-color: rgba(245,158,11,0.2); }
.pipeline-card-badge.nda-loi { background: rgba(139,92,246,0.1); color: #8b5cf6; border-color: rgba(139,92,246,0.2); }
.pipeline-card-badge.data-room { background: rgba(6,182,212,0.1); color: #06b6d4; border-color: rgba(6,182,212,0.2); }
.pipeline-card-badge.site-visited { background: rgba(59,130,246,0.1); color: #3b82f6; border-color: rgba(59,130,246,0.2); }
.pipeline-card-notes {
  font-size: 10px; color: var(--text-muted); margin-top: 6px;
  padding-top: 6px; border-top: 1px solid var(--border);
  line-height: 1.4; max-height: 0; overflow: hidden; transition: max-height 0.3s;
}
.pipeline-card:hover .pipeline-card-notes { max-height: 120px; }
.pipeline-card-meta {
  display: flex; justify-content: space-between; align-items: center;
  margin-top: 6px; font-size: 9px; color: var(--text-muted);
}

/* Three-dots edit button on pipeline cards */
.pipeline-card-edit-btn {
  position: absolute; top: 8px; right: 8px;
  width: 24px; height: 24px;
  display: flex; align-items: center; justify-content: center;
  background: transparent; border: 1px solid transparent; border-radius: 6px;
  color: var(--text-muted); font-size: 18px; cursor: pointer;
  opacity: 0; transition: all 0.2s; z-index: 2;
  line-height: 1; padding: 0; font-family: inherit;
}
.pipeline-card:hover .pipeline-card-edit-btn,
.pipeline-card.selected .pipeline-card-edit-btn { opacity: 1; }
.pipeline-card-edit-btn:hover {
  background: rgba(255,255,255,0.1); border-color: var(--border-bright); color: var(--text-primary);
}

/* Deal Edit Popover */
.deal-edit-backdrop { position: fixed; inset: 0; z-index: 1499; display: none; }
.deal-edit-backdrop.open { display: block; }
.deal-edit-popover {
  position: fixed; z-index: 1500; width: 380px; max-height: 80vh; overflow-y: auto;
  background: var(--bg-secondary); border: 1px solid var(--border-bright);
  border-radius: 16px; padding: 20px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.05);
  backdrop-filter: blur(20px); display: none; font-family: 'Inter', sans-serif;
}
.deal-edit-popover.open { display: block; animation: popover-in 0.2s ease; }
@keyframes popover-in {
  from { opacity: 0; transform: translateY(8px) scale(0.97); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}
.deal-edit-popover::-webkit-scrollbar { width: 6px; }
.deal-edit-popover::-webkit-scrollbar-track { background: transparent; }
.deal-edit-popover::-webkit-scrollbar-thumb { background: var(--border-bright); border-radius: 3px; }
.deal-edit-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);
  cursor: grab; user-select: none;
}
.deal-edit-header:active { cursor: grabbing; }
.deal-edit-title {
  font-size: 15px; font-weight: 700; color: var(--text-primary);
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 300px;
}
.deal-edit-close {
  width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
  background: transparent; border: 1px solid var(--border); border-radius: 8px;
  color: var(--text-muted); cursor: pointer; font-size: 16px; transition: all 0.2s;
  flex-shrink: 0;
}
.deal-edit-close:hover { background: rgba(239,68,68,0.1); border-color: rgba(239,68,68,0.3); color: var(--accent-red); }
.deal-edit-field { margin-bottom: 14px; }
.deal-edit-label {
  font-size: 10px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 1px; color: var(--text-muted); margin-bottom: 6px;
}
.deal-edit-input {
  width: 100%; padding: 8px 12px; background: var(--bg-glass);
  border: 1px solid var(--border); border-radius: 8px;
  color: var(--text-primary); font-size: 13px; font-family: inherit;
  outline: none; transition: border-color 0.2s;
}
.deal-edit-input:focus { border-color: var(--accent-blue); }
.deal-edit-date { cursor: pointer; color-scheme: dark; }
.deal-edit-date::-webkit-calendar-picker-indicator { filter: invert(0.7); cursor: pointer; }
.deal-edit-textarea { resize: vertical; min-height: 60px; }
.deal-edit-chips { display: flex; flex-wrap: wrap; gap: 6px; }
.deal-edit-chip {
  padding: 5px 12px; border-radius: 6px; font-size: 11px; font-weight: 600;
  cursor: pointer; border: 1px solid var(--border); background: var(--bg-glass);
  color: var(--text-secondary); transition: all 0.15s; user-select: none;
}
.deal-edit-chip:hover { border-color: var(--border-bright); color: var(--text-primary); background: rgba(255,255,255,0.06); }
.deal-edit-chip.selected { background: rgba(59,130,246,0.15); border-color: rgba(59,130,246,0.4); color: var(--accent-blue); }
.deal-edit-chip.chip-high.selected { background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.4); color: #ef4444; }
.deal-edit-chip.chip-medium.selected { background: rgba(245,158,11,0.15); border-color: rgba(245,158,11,0.4); color: #f59e0b; }
.deal-edit-chip.chip-low.selected { background: rgba(100,116,139,0.15); border-color: rgba(100,116,139,0.4); color: #94a3b8; }
.deal-edit-chip.chip-signed.selected { background: rgba(16,185,129,0.1); border-color: rgba(16,185,129,0.3); color: #10b981; }
.deal-edit-chip.chip-sent.selected { background: rgba(245,158,11,0.1); border-color: rgba(245,158,11,0.3); color: #f59e0b; }
.deal-edit-chip.chip-loi.selected { background: rgba(139,92,246,0.1); border-color: rgba(139,92,246,0.3); color: #8b5cf6; }
.deal-edit-chip.chip-active.selected { background: rgba(16,185,129,0.1); border-color: rgba(16,185,129,0.3); color: var(--accent-green); }
.deal-edit-chip.chip-new-lead.selected { background: rgba(6,182,212,0.1); border-color: rgba(6,182,212,0.3); color: var(--accent-cyan); }
.deal-edit-chip.chip-stand-by.selected { background: rgba(245,158,11,0.1); border-color: rgba(245,158,11,0.3); color: var(--accent-orange); }
.deal-edit-chip.chip-stalled.selected { background: rgba(239,68,68,0.1); border-color: rgba(239,68,68,0.3); color: var(--accent-red); }
.deal-edit-chip.chip-due-diligence.selected { background: rgba(139,92,246,0.1); border-color: rgba(139,92,246,0.3); color: var(--accent-purple); }
/* Search-select dropdown */
.search-select-wrapper { position: relative; }
.search-select-dropdown {
  position: absolute; top: 100%; left: 0; right: 0; max-height: 200px;
  overflow-y: auto; background: var(--bg-secondary); border: 1px solid var(--border-bright);
  border-top: none; border-radius: 0 0 8px 8px; z-index: 1600; display: none;
  box-shadow: 0 8px 24px rgba(0,0,0,0.4);
}
.search-select-dropdown.visible { display: block; }
.search-select-dropdown::-webkit-scrollbar { width: 6px; }
.search-select-dropdown::-webkit-scrollbar-track { background: transparent; }
.search-select-dropdown::-webkit-scrollbar-thumb { background: var(--border-bright); border-radius: 3px; }
.search-select-option {
  padding: 8px 12px; font-size: 13px; color: var(--text-secondary);
  cursor: pointer; transition: background 0.1s;
}
.search-select-option:hover { background: rgba(59,130,246,0.1); color: var(--text-primary); }
.search-select-option strong { color: var(--accent-blue); font-weight: 700; }
.search-select-no-results { padding: 12px; font-size: 12px; color: var(--text-muted); text-align: center; font-style: italic; }
/* Linked action items in deal edit popover */
.linked-actions-list { display: flex; flex-direction: column; gap: 6px; }
.linked-action-item {
  display: flex; align-items: flex-start; gap: 8px; padding: 8px 10px;
  background: var(--bg-glass); border: 1px solid var(--border); border-radius: 8px;
  transition: all 0.2s; position: relative;
}
.linked-action-item:hover { border-color: var(--border-bright); }
.linked-action-item.is-done { opacity: 0.4; }
.linked-action-item.is-done .linked-action-text { text-decoration: line-through; }
.linked-action-done-btn {
  width: 18px; height: 18px; border-radius: 5px; border: 1.5px solid var(--border-bright);
  background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center;
  color: transparent; font-size: 11px; transition: all 0.15s; flex-shrink: 0; margin-top: 1px;
}
.linked-action-done-btn:hover { border-color: #10b981; color: #10b981; }
.linked-action-done-btn.checked { background: rgba(16,185,129,0.15); border-color: #10b981; color: #10b981; }
.linked-action-priority {
  font-size: 9px; font-weight: 700; padding: 2px 6px; border-radius: 4px;
  text-transform: uppercase; letter-spacing: 0.5px; flex-shrink: 0; margin-top: 1px;
}
.linked-action-priority.urgent { background: rgba(239,68,68,0.15); color: #ef4444; }
.linked-action-priority.high { background: rgba(245,158,11,0.15); color: #f59e0b; }
.linked-action-priority.medium { background: rgba(59,130,246,0.15); color: #3b82f6; }
.linked-action-priority.low { background: rgba(100,116,139,0.15); color: #94a3b8; }
.linked-action-body { flex: 1; min-width: 0; }
.linked-action-text { font-size: 12px; color: var(--text-primary); line-height: 1.4; }
.linked-action-meta { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
.linked-action-edit-btn {
  width: 20px; height: 20px; border: none; background: transparent; cursor: pointer;
  color: var(--text-muted); font-size: 14px; opacity: 0; transition: opacity 0.15s;
  display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.linked-action-item:hover .linked-action-edit-btn { opacity: 1; }
.linked-action-edit-btn:hover { color: var(--text-primary); }
.linked-actions-empty {
  padding: 12px; text-align: center; font-size: 12px; color: var(--text-muted);
  font-style: italic; background: var(--bg-glass); border-radius: 8px;
  border: 1px dashed var(--border);
}
.deal-edit-actions {
  display: flex; gap: 8px; margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border);
}
.deal-edit-save {
  flex: 1; padding: 10px; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
  border: none; border-radius: 10px; color: white; font-weight: 600;
  font-size: 13px; cursor: pointer; font-family: inherit; transition: all 0.3s;
}
.deal-edit-save:hover { transform: translateY(-1px); box-shadow: 0 4px 20px var(--glow-blue); }
.deal-edit-save:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
.deal-edit-cancel {
  padding: 10px 20px; background: var(--bg-glass); border: 1px solid var(--border);
  border-radius: 10px; color: var(--text-secondary); font-weight: 600;
  font-size: 13px; cursor: pointer; font-family: inherit;
}
.deal-edit-cancel:hover { border-color: var(--border-bright); color: var(--text-primary); }

/* Section Tabs */
.section-tabs {
  display: flex; gap: 4px; padding: 0 32px; margin-top: 8px;
}
.section-tab {
  display: flex; align-items: center; gap: 8px;
  padding: 12px 24px; border-radius: 12px 12px 0 0;
  font-size: 14px; font-weight: 700; cursor: pointer;
  border: 1px solid var(--border); border-bottom: none;
  background: var(--bg-glass); backdrop-filter: blur(10px);
  transition: all 0.3s ease; position: relative;
  color: var(--text-muted); letter-spacing: 0.3px;
  font-family: 'Inter', sans-serif;
}
.section-tab:hover { background: rgba(255,255,255,0.05); color: var(--text-secondary); }
.section-tab.active { background: rgba(255,255,255,0.06); border-color: var(--border-bright); }
.section-tab.active::after {
  content: ''; position: absolute; bottom: -1px; left: 0; right: 0;
  height: 2px; border-radius: 2px 2px 0 0;
}

.section-tab[data-tab="pipeline"] .tab-label {
  background: linear-gradient(135deg, var(--accent-orange), var(--accent-pink));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.section-tab[data-tab="pipeline"].active::after {
  background: linear-gradient(90deg, var(--accent-orange), var(--accent-pink));
}

.section-tab[data-tab="actions"] .tab-label {
  background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.section-tab[data-tab="actions"].active::after {
  background: linear-gradient(90deg, var(--accent-cyan), var(--accent-blue));
}

.section-tab[data-tab="reporting"] .tab-label {
  background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.section-tab[data-tab="reporting"].active::after {
  background: linear-gradient(90deg, var(--accent-purple), var(--accent-blue));
}

.section-tab .tab-icon { display: flex; align-items: center; }
.section-tab .tab-count {
  font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 6px;
  background: rgba(255,255,255,0.06); color: var(--text-muted);
}

.section-tab[data-tab="pipeline"].active .tab-count { background: rgba(245,158,11,0.12); color: var(--accent-orange); }
.section-tab[data-tab="actions"].active .tab-count { background: rgba(6,182,212,0.12); color: var(--accent-cyan); }
.section-tab[data-tab="reporting"].active .tab-count { background: rgba(139,92,246,0.12); color: var(--accent-purple); }

.tab-panel { display: none; }
.tab-panel.active { display: block; }

.section-tabs-border {
  margin: 0 32px; border-top: 1px solid var(--border-bright);
}

/* Action Items Section */
.action-items-section {
  margin: 20px 32px 24px; background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 16px; padding: 20px;
}
.action-items-title {
  font-size: 18px; font-weight: 800; color: var(--text-primary);
  margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
}
/* Action Items Toolbar */
.action-toolbar {
  display: flex; align-items: center; gap: 8px; margin-bottom: 14px;
  flex-wrap: wrap; padding-bottom: 12px; border-bottom: 1px solid var(--border);
}
.action-toolbar-group { display: flex; align-items: center; gap: 6px; }
.action-toolbar-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); }
.action-toolbar-select {
  padding: 5px 10px; background: var(--bg-glass); border: 1px solid var(--border);
  border-radius: 6px; color: var(--text-secondary); font-size: 11px;
  font-family: inherit; cursor: pointer; outline: none; appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%2394a3b8' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 8px center;
  padding-right: 24px;
}
.action-toolbar-select:focus { border-color: var(--accent-blue); }
.action-toolbar-sep { width: 1px; height: 20px; background: var(--border); margin: 0 4px; }
.action-show-done {
  display: flex; align-items: center; gap: 6px; cursor: pointer;
  font-size: 11px; color: var(--text-muted); user-select: none;
  padding: 4px 10px; border-radius: 6px; border: 1px solid var(--border);
  background: var(--bg-glass); transition: all 0.2s;
}
.action-show-done:hover { border-color: var(--border-bright); color: var(--text-secondary); }
.action-show-done.active { border-color: rgba(16,185,129,0.3); color: #10b981; background: rgba(16,185,129,0.08); }
.action-show-done-check { width: 14px; height: 14px; border-radius: 4px; border: 1.5px solid var(--border-bright); display: flex; align-items: center; justify-content: center; font-size: 10px; transition: all 0.2s; }
.action-show-done.active .action-show-done-check { background: #10b981; border-color: #10b981; color: #0a0e1a; }
.action-new-btn {
  padding: 5px 14px; border-radius: 8px; font-size: 12px; font-weight: 600;
  cursor: pointer; border: 1px solid rgba(59,130,246,0.3); background: rgba(59,130,246,0.1);
  color: var(--accent-blue); font-family: inherit; transition: all 0.2s; white-space: nowrap;
}
.action-new-btn:hover { background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.5); }

/* Action Items Grid + Column Header */
.action-items-grid { display: grid; gap: 6px; }
.action-items-header {
  display: grid; grid-template-columns: 32px 80px 1fr 140px 100px 90px 80px 28px;
  gap: 12px; padding: 6px 12px; font-size: 10px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted);
}
.action-items-header span { cursor: pointer; user-select: none; transition: color 0.2s; }
.action-items-header span:hover { color: var(--text-secondary); }
.action-items-header span.sorted { color: var(--accent-cyan); }

/* Group headers */
.action-group-header {
  padding: 8px 12px; margin-top: 8px; font-size: 11px; font-weight: 700;
  color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;
  border-bottom: 1px solid var(--border);
}

/* Updated row with checkbox + edit column */
.action-item-row {
  display: grid; grid-template-columns: 32px 80px 1fr 140px 100px 90px 80px 28px;
  gap: 12px; align-items: center; padding: 10px 12px;
  background: rgba(255,255,255,0.02); border: 1px solid var(--border);
  border-radius: 8px; font-size: 12px; transition: all 0.3s;
}
.action-item-row:hover { border-color: var(--border-bright); background: rgba(255,255,255,0.04); }
.action-item-row.done {
  opacity: 0.4; text-decoration: line-through; text-decoration-color: var(--text-muted);
}
.action-item-row.done:hover { opacity: 0.7; }
.action-item-row.hiding { opacity: 0; transform: translateX(-20px); max-height: 0; padding: 0 12px; margin: 0; overflow: hidden; }

/* Done checkbox */
.action-done-btn {
  width: 22px; height: 22px; border-radius: 6px;
  border: 2px solid var(--border-bright); background: transparent;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all 0.2s; color: transparent; font-size: 12px;
}
.action-done-btn:hover { border-color: #10b981; background: rgba(16,185,129,0.1); color: rgba(16,185,129,0.5); }
.action-item-row.done .action-done-btn { border-color: #10b981; background: #10b981; color: #0a0e1a; }

/* Edit button on action item */
.action-edit-btn {
  width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
  background: transparent; border: 1px solid transparent; border-radius: 6px;
  color: var(--text-muted); font-size: 16px; cursor: pointer;
  opacity: 0; transition: all 0.2s;
}
.action-item-row:hover .action-edit-btn { opacity: 1; }
.action-edit-btn:hover { background: rgba(255,255,255,0.1); border-color: var(--border-bright); color: var(--text-primary); }
.action-priority-badge {
  padding: 3px 8px; border-radius: 4px; font-size: 10px;
  font-weight: 700; text-align: center; text-transform: uppercase;
}
.action-priority-badge.urgent { background: rgba(239,68,68,0.15); color: #ef4444; }
.action-priority-badge.high { background: rgba(245,158,11,0.15); color: #f59e0b; }
.action-priority-badge.medium { background: rgba(59,130,246,0.15); color: #3b82f6; }
.action-priority-badge.low { background: rgba(100,116,139,0.15); color: #94a3b8; }
.action-status-badge {
  padding: 3px 8px; border-radius: 4px; font-size: 10px;
  font-weight: 600; text-align: center;
}
.action-status-badge.overdue { background: rgba(239,68,68,0.15); color: #ef4444; }
.action-status-badge.pending { background: rgba(245,158,11,0.15); color: #f59e0b; }
.action-status-badge.scheduled { background: rgba(16,185,129,0.15); color: #10b981; }
.action-status-badge.planning { background: rgba(139,92,246,0.15); color: #8b5cf6; }
.action-status-badge.stalled { background: rgba(100,116,139,0.15); color: #94a3b8; }

/* Toast notifications */
.toast {
  position: fixed; bottom: 24px; right: 24px; padding: 12px 20px;
  border-radius: 10px; font-size: 13px; font-weight: 500; z-index: 10000;
  opacity: 0; transform: translateY(10px); transition: all 0.3s ease;
  font-family: 'Inter', sans-serif; pointer-events: none;
}
.toast.show { opacity: 1; transform: translateY(0); }
.toast.success { background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.3); color: #10b981; }
.toast.error { background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.3); color: #ef4444; }
.toast.pending { background: rgba(59,130,246,0.15); border: 1px solid rgba(59,130,246,0.3); color: #3b82f6; }

/* Monthly activity chart */
.activity-chart { position: relative; height: 180px; }
.activity-bars { display: flex; align-items: flex-end; gap: 3px; height: 150px; padding: 0 4px; }
.activity-bar-wrap { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; height: 100%; justify-content: flex-end; }
.activity-bar {
  width: 100%; border-radius: 4px 4px 0 0;
  background: linear-gradient(180deg, var(--accent-blue), var(--accent-cyan));
  transition: height 0.8s ease; min-height: 2px; position: relative;
}
.activity-bar:hover { opacity: 0.8; }
.activity-bar-label { font-size: 8px; color: var(--text-muted); transform: rotate(-45deg); white-space: nowrap; }
.activity-bar-val { font-size: 9px; color: var(--text-secondary); font-weight: 600; }

/* Daily outreach chart */
.daily-outreach-controls { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
.daily-outreach-filters { display: flex; gap: 4px; flex-wrap: wrap; }
.daily-filter-btn {
  padding: 4px 12px; border-radius: 6px; font-size: 11px; font-weight: 600;
  border: 1px solid var(--border); background: transparent; color: var(--text-muted);
  cursor: pointer; transition: all 0.2s; font-family: inherit;
}
.daily-filter-btn:hover { border-color: var(--accent-blue); color: var(--text-secondary); }
.daily-filter-btn.active { background: rgba(59,130,246,0.15); border-color: var(--accent-blue); color: var(--accent-blue); }
.daily-date-range {
  display: flex; align-items: center; gap: 4px;
}
.daily-date-input {
  background: var(--bg-glass); border: 1px solid var(--border); border-radius: 6px;
  color: var(--text-secondary); font-size: 11px; padding: 4px 8px; font-family: inherit;
  color-scheme: dark; cursor: pointer; width: 120px;
}
.daily-date-input:focus { border-color: var(--accent-blue); outline: none; }
.daily-date-input.active { border-color: var(--accent-blue); background: rgba(59,130,246,0.08); }
.daily-date-sep { color: var(--text-muted); font-size: 11px; }
.daily-date-clear {
  background: none; border: 1px solid var(--border); border-radius: 4px;
  color: var(--text-muted); font-size: 10px; padding: 3px 6px; cursor: pointer;
  font-family: inherit; display: none;
}
.daily-date-clear:hover { color: var(--text-primary); border-color: var(--text-muted); }
.daily-date-clear.visible { display: inline-block; }
.daily-filter-btn.channel-btn { font-size: 10px; padding: 3px 10px; }
.daily-filter-btn.channel-btn.active { background: rgba(16,185,129,0.15); border-color: #10b981; color: #10b981; }
.daily-outreach-summary {
  display: flex; gap: 24px; margin-bottom: 16px; flex-wrap: wrap;
}
.daily-summary-stat {
  display: flex; flex-direction: column; gap: 2px;
}
.daily-summary-val { font-size: 20px; font-weight: 800; color: var(--text-primary); }
.daily-summary-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
.daily-outreach-chart { position: relative; height: 220px; }
.daily-chart-bars { display: flex; align-items: flex-end; gap: 2px; height: 180px; padding: 0 4px; }
.daily-chart-bar-wrap {
  flex: 1; display: flex; flex-direction: column; align-items: center;
  min-width: 0; justify-content: flex-end;
}
.daily-chart-bar {
  width: 100%; border-radius: 3px 3px 0 0; min-height: 2px;
  background: linear-gradient(180deg, var(--accent-blue), var(--accent-cyan));
  transition: height 0.3s ease, opacity 0.2s;
}
.daily-chart-bar:hover { opacity: 0.8; }
.daily-chart-bar-label {
  font-size: 8px; color: var(--text-muted); white-space: nowrap;
  overflow: hidden; text-overflow: ellipsis; max-width: 100%; text-align: center;
}
.daily-chart-bar-val { font-size: 8px; color: var(--text-secondary); font-weight: 600; min-height: 12px; line-height: 12px; }
.daily-chart-empty { display: flex; align-items: center; justify-content: center; height: 180px; color: var(--text-muted); font-size: 13px; }
.daily-chart-bar-wrap { cursor: pointer; }
.daily-chart-bar-wrap.selected .daily-chart-bar {
  background: linear-gradient(180deg, #f59e0b, #f97316);
  box-shadow: 0 0 8px rgba(245,158,11,0.4);
}
.chart-map-indicator {
  display: flex; align-items: center; gap: 8px; margin-top: 8px;
  padding: 6px 12px; background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3);
  border-radius: 8px; font-size: 11px; color: #fbbf24; font-weight: 600;
}
.chart-map-indicator .map-dot { width: 6px; height: 6px; border-radius: 50%; background: #f59e0b; animation: pulse 1.5s infinite; }
.chart-map-clear {
  margin-left: auto; background: none; border: 1px solid rgba(245,158,11,0.4);
  color: #fbbf24; font-size: 10px; padding: 2px 10px; border-radius: 4px;
  cursor: pointer; font-family: inherit; font-weight: 600;
}
.chart-map-clear:hover { background: rgba(245,158,11,0.15); }

/* Drill-down panel */
.drilldown-panel {
  margin-top: 12px; background: rgba(15,23,42,0.6); border: 1px solid var(--border);
  border-radius: 10px; overflow: hidden; animation: fadeIn 0.2s ease;
}
.drilldown-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 16px; border-bottom: 1px solid var(--border);
}
.drilldown-title { font-size: 12px; font-weight: 700; color: var(--text-secondary); }
.drilldown-close {
  background: none; border: none; color: var(--text-muted); cursor: pointer;
  font-size: 14px; padding: 2px 6px; border-radius: 4px; font-family: inherit;
}
.drilldown-close:hover { color: var(--text-primary); background: rgba(255,255,255,0.05); }
.drilldown-table { width: 100%; border-collapse: collapse; font-size: 11px; }
.drilldown-table th {
  padding: 8px 12px; text-align: left; font-size: 9px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted);
  border-bottom: 1px solid var(--border); position: sticky; top: 0;
  background: rgba(15,23,42,0.95); cursor: pointer; user-select: none; white-space: nowrap;
}
.drilldown-table th:hover { color: var(--text-secondary); }
.drilldown-table th .sort-arrow { margin-left: 4px; font-size: 8px; opacity: 0.3; }
.drilldown-table th.sort-active .sort-arrow { opacity: 1; color: var(--accent-blue); }
.drilldown-table th.sort-active { color: var(--accent-blue); }
.drilldown-table td {
  padding: 6px 12px; border-bottom: 1px solid rgba(148,163,184,0.06);
  color: var(--text-secondary);
}
.drilldown-table tr:hover td { background: rgba(255,255,255,0.02); }
.drilldown-table-wrap { max-height: 240px; overflow-y: auto; }
.drilldown-medium {
  padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;
  display: inline-block;
}
.drilldown-medium-call { background: rgba(59,130,246,0.15); color: #60a5fa; }
.drilldown-medium-text { background: rgba(16,185,129,0.15); color: #34d399; }
.drilldown-medium-vm { background: rgba(168,85,247,0.15); color: #c084fc; }
.drilldown-medium-linkedin { background: rgba(59,130,246,0.15); color: #93c5fd; }
.drilldown-medium-email { background: rgba(245,158,11,0.15); color: #fbbf24; }
.drilldown-medium-default { background: rgba(148,163,184,0.1); color: var(--text-muted); }
.drilldown-count { font-size: 11px; color: var(--text-muted); margin-left: 8px; }

/* Table view */
.table-container { display: none; padding: 0 24px 24px; overflow-x: auto; }

.data-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.data-table th {
  padding: 10px 12px; text-align: left; font-size: 10px;
  font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
  color: var(--text-muted); border-bottom: 1px solid var(--border);
  background: rgba(255,255,255,0.02); position: sticky; top: 0; cursor: pointer;
}
.data-table th:hover { color: var(--text-primary); }
.data-table th .sort-arrow { font-size: 10px; margin-left: 4px; opacity: 0.3; }
.data-table th.sorted .sort-arrow { opacity: 1; color: var(--accent-blue); }
.data-table th.sorted { color: var(--accent-blue); }
.data-table td { padding: 10px 12px; border-bottom: 1px solid var(--border); color: var(--text-secondary); }
.data-table tr:hover td { background: rgba(59, 130, 246, 0.05); color: var(--text-primary); }

.status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }

/* Upload modal */

/* Section dividers */
.section-divider {
  padding: 32px 32px 0;
  display: flex; align-items: center; gap: 16px;
}
.section-divider h2 {
  font-size: 16px; font-weight: 800; white-space: nowrap;
}
.section-divider::after {
  content: ''; flex: 1; height: 1px;
  background: linear-gradient(90deg, var(--border-bright), transparent);
}

/* Responsive */
@media (max-width: 1400px) { .kpi-row { grid-template-columns: repeat(4, 1fr); } .pipeline-board { grid-template-columns: repeat(3, 1fr); } }
@media (max-width: 1200px) { .charts-section { grid-template-columns: 1fr; } }
@media (max-width: 900px) { .main-content { grid-template-columns: 1fr; } .sidebar { position: static; max-height: none; border-right: none; border-bottom: 1px solid var(--border); } .kpi-row { grid-template-columns: repeat(2, 1fr); } .pipeline-board { grid-template-columns: 1fr; } }

@keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
.animate-in { animation: fadeUp 0.5s ease forwards; opacity: 0; }

::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border-bright); border-radius: 3px; }
</style>
</head>
<body>

<!-- Password Gate -->
<div id="loginScreen" style="position:fixed;inset:0;z-index:99999;background:var(--bg-primary);display:flex;align-items:center;justify-content:center;">
  <div style="text-align:center;max-width:380px;padding:40px;">
    <div style="width:64px;height:64px;border-radius:16px;background:linear-gradient(135deg,var(--accent-blue),var(--accent-purple));display:flex;align-items:center;justify-content:center;margin:0 auto 24px;font-size:28px;font-weight:800;color:#fff;letter-spacing:-1px;">RC</div>
    <h1 style="font-size:24px;font-weight:700;color:var(--text-primary);margin-bottom:8px;">Behavioral Health Outreach Hub</h1>
    <p style="color:var(--text-secondary);margin-bottom:32px;font-size:14px;">Enter password to access the dashboard</p>
    <div style="position:relative;">
      <input id="loginPassword" type="password" placeholder="Password" autofocus
        style="width:100%;padding:14px 18px;border-radius:12px;border:1px solid var(--border-bright);background:var(--bg-card);color:var(--text-primary);font-size:15px;font-family:Inter,sans-serif;outline:none;transition:border 0.2s;"
        onfocus="this.style.borderColor='var(--accent-blue)'" onblur="this.style.borderColor='var(--border-bright)'" />
    </div>
    <div id="loginError" style="color:var(--accent-red);font-size:13px;margin-top:12px;height:18px;"></div>
    <button id="loginBtn" onclick="tryLogin()"
      style="width:100%;margin-top:8px;padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--accent-blue),var(--accent-purple));color:#fff;font-size:15px;font-weight:600;font-family:Inter,sans-serif;cursor:pointer;transition:opacity 0.2s;"
      onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">Enter</button>
  </div>
</div>

<script>
const _PH = '649b6bded590b8adc12ee23d71757e8e3915418d7379d427a4f52bd2f04e9f42';
async function _hash(s) {
  const d = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(s));
  return Array.from(new Uint8Array(d)).map(b => b.toString(16).padStart(2, '0')).join('');
}
async function tryLogin() {
  const pw = document.getElementById('loginPassword').value;
  const h = await _hash(pw);
  if (h === _PH) {
    sessionStorage.setItem('_auth', '1');
    document.getElementById('loginScreen').style.display = 'none';
  } else {
    document.getElementById('loginError').textContent = 'Incorrect password';
    document.getElementById('loginPassword').value = '';
    document.getElementById('loginPassword').focus();
  }
}
document.addEventListener('DOMContentLoaded', () => {
  if (sessionStorage.getItem('_auth') === '1') {
    document.getElementById('loginScreen').style.display = 'none';
  }
  document.getElementById('loginPassword').addEventListener('keydown', e => {
    if (e.key === 'Enter') tryLogin();
  });
});
</script>

<div class="app">
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <div class="logo">RC</div>
      <div>
        <h1>Behavioral Health Outreach Hub</h1>
        <div class="header-subtitle">Cold outreach analytics & acquisition pipeline</div>
      </div>
    </div>
    <div class="header-right">
      <div class="live-badge">
        <div class="live-dot"></div>
        <span id="companyCount">0</span> Companies &middot; <span id="messageCount">0</span> Messages
      </div>
      <div class="refresh-group">
        <button class="refresh-btn" id="refreshBtn" onclick="refreshData()" title="Refresh data from Google Sheet">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
          Refresh
        </button>
        <div class="refresh-meta">
          <span class="refresh-timestamp">Updated <span id="lastRefreshTime">just now</span></span>
          <span class="refresh-auto-badge" id="autoRefreshBadge" title="Auto-refreshes every 5 min">
            <span class="auto-dot"></span> Auto
          </span>
        </div>
      </div>
    </div>
  </header>

  <!-- KPI Row -->
  <div class="kpi-row" id="kpiRow"></div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="search-wrap">
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
        <input type="text" class="search-input" id="searchInput" placeholder="Search companies...">
      </div>
      <div class="filter-section"><div class="filter-title">Pipeline Stage <button class="color-mode-btn" data-color-mode="pipeline" onclick="setMapColorMode('pipeline')">🎨 Map</button></div><div id="pipelineFilters"></div></div>
      <div class="filter-section"><div class="filter-title">Outreach Status <button class="color-mode-btn" data-color-mode="status" onclick="setMapColorMode('status')">🎨 Map</button></div><div id="outreachFilters"></div></div>
      <div class="filter-section"><div class="filter-title">Ownership <button class="color-mode-btn active" data-color-mode="ownership" onclick="setMapColorMode('ownership')">🎨 Map</button></div><div id="ownershipFilters"></div></div>
      <div class="filter-section"><div class="filter-title">Outreach Channel</div><div id="mediumFilters"></div></div>
      <div class="filter-section"><div class="filter-title">Sent By</div><div id="accountFilters"></div></div>
    </aside>

    <!-- Map + Charts -->
    <div class="map-area">
      <div class="map-controls">
        <div class="map-controls-left">
          <div class="view-toggle">
            <button class="view-btn active" onclick="setView('map')">Map</button>
            <button class="view-btn" onclick="setView('table')">Table</button>
          </div>
        </div>
        <div class="map-legend" id="mapLegend"></div>
      </div>

      <!-- Map with floating state filter badge -->
      <div id="mapWrapper" style="position:relative">
        <div id="map"></div>
        <div id="stateFilterOverlay" style="position:absolute;top:12px;left:50%;transform:translateX(-50%);z-index:999;pointer-events:auto;display:none">
          <div style="display:flex;align-items:center;gap:8px;padding:8px 16px;background:rgba(10,14,26,0.9);border:1px solid rgba(59,130,246,0.4);border-radius:12px;backdrop-filter:blur(10px)">
            <span id="stateFilterLabel" style="font-size:12px;font-weight:600;color:var(--accent-blue)"></span>
            <button onclick="clearStateFilter()" style="background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);color:#ef4444;font-size:11px;font-weight:600;padding:3px 10px;border-radius:8px;cursor:pointer;font-family:inherit">Clear</button>
          </div>
        </div>
      </div>
      <div class="table-container" id="tableContainer"></div>

      <!-- Section Tabs -->
      <div class="section-tabs" id="sectionTabs">
        <div class="section-tab active" data-tab="pipeline" onclick="switchTab('pipeline')">
          <span class="tab-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></span>
          <span class="tab-label">Acquisition Pipeline</span>
          <span class="tab-count" id="tabPipelineCount">0</span>
        </div>
        <div class="section-tab" data-tab="actions" onclick="switchTab('actions')">
          <span class="tab-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg></span>
          <span class="tab-label">Action Items</span>
          <span class="tab-count" id="tabActionsCount">0</span>
        </div>
        <div class="section-tab" data-tab="reporting" onclick="switchTab('reporting')">
          <span class="tab-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg></span>
          <span class="tab-label">Reporting</span>
        </div>
      </div>
      <div class="section-tabs-border"></div>

      <!-- Pipeline Tab Panel -->
      <div class="tab-panel active" id="panelPipeline" data-panel="pipeline">
        <div class="pipeline-section" id="pipelineSection">
          <div class="pipeline-header">
            <h2>Acquisition Pipeline</h2>
            <div class="pipeline-stats" id="pipelineStats"></div>
          </div>
          <div class="pipeline-board" id="pipelineBoard"></div>
        </div>
      </div>

      <!-- Action Items Tab Panel -->
      <div class="tab-panel" id="panelActions" data-panel="actions">
        <div class="action-items-section" id="actionItemsSection">
          <div class="action-items-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent-cyan)" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
            Action Items
            <span id="actionItemCount" style="font-size:12px;font-weight:500;color:var(--text-muted);margin-left:4px"></span>
          </div>
          <div class="action-toolbar" id="actionToolbar">
            <div class="action-toolbar-group">
              <span class="action-toolbar-label">Filter:</span>
              <select class="action-toolbar-select" id="actionFilterPriority"><option value="">All Priorities</option><option>URGENT</option><option>HIGH</option><option>MEDIUM</option><option>LOW</option></select>
              <select class="action-toolbar-select" id="actionFilterStatus"><option value="">All Statuses</option><option>Overdue</option><option>Pending</option><option>Scheduled</option><option>Planning</option><option>Waiting</option><option>Not Started</option><option>Stalled</option></select>
              <select class="action-toolbar-select" id="actionFilterOwner"></select>
              <select class="action-toolbar-select" id="actionFilterFacility"></select>
            </div>
            <div class="action-toolbar-sep"></div>
            <div class="action-toolbar-group">
              <span class="action-toolbar-label">Sort:</span>
              <select class="action-toolbar-select" id="actionSort"><option value="priority">Priority</option><option value="status">Status</option><option value="owner">Owner</option><option value="facility">Facility</option><option value="deadline">Deadline</option></select>
            </div>
            <div class="action-toolbar-sep"></div>
            <div class="action-toolbar-group">
              <span class="action-toolbar-label">Group:</span>
              <select class="action-toolbar-select" id="actionGroupBy"><option value="">None</option><option value="priority">Priority</option><option value="status">Status</option><option value="owner">Owner</option><option value="facility">Facility</option></select>
            </div>
            <div class="action-toolbar-sep"></div>
            <div class="action-show-done" id="actionShowDone" title="Show completed items">
              <span class="action-show-done-check">&#10003;</span> Show Done
            </div>
            <div class="action-toolbar-sep"></div>
            <button class="action-new-btn" id="actionNewBtn" title="Create new action item">+ New</button>
          </div>
          <div class="action-items-grid" id="actionItemsGrid"></div>
        </div>
      </div>

      <!-- Reporting Tab Panel -->
      <div class="tab-panel" id="panelReporting" data-panel="reporting">
        <div class="charts-section" id="chartsSection">
        <div class="chart-card full-width animate-in" id="dailyOutreachCard">
          <div class="chart-header">
            <div class="chart-title">Cold Outreach Volume</div>
            <div class="daily-outreach-controls">
              <div class="daily-outreach-filters" id="dailyRangeFilters">
                <button class="daily-filter-btn" data-range="daily">Daily</button>
                <button class="daily-filter-btn" data-range="weekly">Weekly</button>
                <button class="daily-filter-btn active" data-range="monthly">Monthly</button>
                <button class="daily-filter-btn" data-range="quarterly">Quarterly</button>
              </div>
              <div class="daily-date-range" id="dailyDateRange">
                <input type="date" class="daily-date-input" id="dailyDateFrom" title="From date">
                <span class="daily-date-sep">–</span>
                <input type="date" class="daily-date-input" id="dailyDateTo" title="To date">
                <button class="daily-date-clear" id="dailyDateClear" title="Clear custom range">✕</button>
              </div>
              <div class="daily-outreach-filters" id="dailyChannelFilters"></div>
            </div>
          </div>
          <div class="daily-outreach-summary" id="dailyOutreachSummary"></div>
          <div class="daily-outreach-chart" id="dailyOutreachChart"></div>
          <div id="chartMapIndicator"></div>
          <div id="dailyDrilldown"></div>
        </div>
        <div class="chart-card animate-in">
          <div class="chart-header">
            <div class="chart-title">Outreach Funnel</div>
            <div class="daily-date-range" id="funnelDateRange">
              <input type="date" class="daily-date-input" id="funnelDateFrom" title="From date">
              <span class="daily-date-sep">–</span>
              <input type="date" class="daily-date-input" id="funnelDateTo" title="To date">
              <button class="daily-date-clear" id="funnelDateClear" title="Clear date range">✕</button>
            </div>
          </div>
          <div class="funnel" id="funnelChart"></div>
          <div id="funnelDrilldown"></div>
        </div>
        <div class="chart-card animate-in">
          <div class="chart-title">Ownership Breakdown</div>
          <div class="donut-container" id="ownershipDonut"></div>
        </div>
        <div class="chart-card animate-in">
          <div class="chart-header">
            <div class="chart-title">Top States</div>
            <div id="stateFilterBadge"></div>
          </div>
          <div class="bar-chart" id="stateBarChart"></div>
          <div id="stateDrilldown"></div>
        </div>
        <div class="chart-card animate-in">
          <div class="chart-header">
            <div class="chart-title">Messages by Channel</div>
            <div class="daily-date-range" id="channelDateRange">
              <input type="date" class="daily-date-input" id="channelDateFrom" title="From date">
              <span class="daily-date-sep">–</span>
              <input type="date" class="daily-date-input" id="channelDateTo" title="To date">
              <button class="daily-date-clear" id="channelDateClear" title="Clear date range">✕</button>
            </div>
          </div>
          <div class="bar-chart" id="mediumBarChart"></div>
        </div>
        <div class="chart-card full-width animate-in">
          <div class="chart-title">Monthly Outreach Activity</div>
          <div class="activity-chart" id="activityChart"></div>
        </div>
        <div class="chart-card animate-in">
          <div class="chart-title">Messages by Team Member</div>
          <div class="bar-chart" id="accountBarChart"></div>
        </div>
        <div class="chart-card animate-in">
          <div class="chart-title">State Tier Distribution</div>
          <div class="donut-container" id="tierDonut"></div>
        </div>
      </div>
      </div>
    </div>
  </div>
</div>

<!-- Upload Modal -->

<!-- Deal Edit Popover (singleton, repositioned per card) -->
<div class="deal-edit-backdrop" id="dealEditBackdrop"></div>
<div class="deal-edit-popover" id="dealEditPopover">
  <div class="deal-edit-header" id="dealEditHeader">
    <div class="deal-edit-title" id="dealEditTitle"></div>
    <button class="deal-edit-close" id="dealEditClose">&times;</button>
  </div>
  <div id="dealEditFields"></div>
  <div class="deal-edit-actions">
    <button class="deal-edit-cancel" id="dealEditCancel">Cancel</button>
    <button class="deal-edit-save" id="dealEditSave">Save Changes</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
<script>
// ============================================================
// DATA & STATE
// ============================================================
let DATA = { companies: [], pipeline: [], actions: [], meta: {} };
let filteredData = [];
let map, markersLayer, ghostLayer, statesLayer;
let activeGhostCompany = null;
let stateGeoData = null;
let filterDefs = {}; // { 'type:key': { fn, type, key } } — registry for dynamic count updates
let activeKPI = null; // currently selected KPI key (or null)
let mapColorMode = 'ownership'; // 'ownership' | 'status' | 'pipeline'
let soloFilter = null; // { type: 'status'|'pipeline'|'ownership', key: string, color: string, fn: function } — single filter highlighting

// Multi-select pipeline card state
let selectedCards = new Set();
let selectedColumn = null;
let highlightLayer = null;
let isDragging = 0; // timestamp of last drag end

const activeFilters = { search: '', pipeline: new Set(), status: new Set(), state: new Set(), ownership: new Set(), medium: new Set(), account: new Set() };

const OWNERSHIP_COLORS = { "Mom 'n Pop": '#10b981', 'Private Equity': '#8b5cf6', 'Publicly Traded': '#3b82f6', 'Non-Profit': '#f59e0b', 'CLOSED': '#ef4444', 'GOV': '#64748b' };
function getStatusColor(c) {
  // Use DOM order from outreachFilters for priority (top button wins)
  const container = document.getElementById('outreachFilters');
  if (container) {
    const buttons = container.querySelectorAll('.filter-btn[data-filter-type="status"]');
    for (const btn of buttons) {
      const def = filterDefs['status:' + btn.dataset.filterKey];
      if (def && def.fn(c)) return btn.dataset.filterColor || def.color || '#64748b';
    }
  }
  // Fallback: not contacted
  if (c.msgsSent > 0) return '#f59e0b';
  return '#64748b';
}
function getPipelineColor(c) {
  if (!c.inPipeline || !c.pipelineStatus) return '#64748b';
  // Use DOM order from pipelineFilters for priority
  const container = document.getElementById('pipelineFilters');
  if (container) {
    const buttons = container.querySelectorAll('.filter-btn[data-filter-type="pipeline"]');
    for (const btn of buttons) {
      const def = filterDefs['pipeline:' + btn.dataset.filterKey];
      if (def && def.fn(c)) return btn.dataset.filterColor || def.color || '#64748b';
    }
  }
  return '#64748b';
}
function getOwnershipColor(c) {
  // Use DOM order from ownershipFilters for priority
  const container = document.getElementById('ownershipFilters');
  if (container) {
    const buttons = container.querySelectorAll('.filter-btn[data-filter-type="ownership"]');
    for (const btn of buttons) {
      const def = filterDefs['ownership:' + btn.dataset.filterKey];
      if (def && def.fn(c)) return btn.dataset.filterColor || def.color || '#64748b';
    }
  }
  return OWNERSHIP_COLORS[c.ownership] || '#64748b';
}
function getMarkerColor(c) {
  if (mapColorMode === 'status') return getStatusColor(c);
  if (mapColorMode === 'pipeline') return getPipelineColor(c);
  return getOwnershipColor(c);
}
const PIPELINE_COLUMNS = [
  { key: 'Active', match: s => s.startsWith('Active'), color: 'var(--accent-green)', bg: 'rgba(16,185,129,0.1)' },
  { key: 'New Lead', match: s => s === 'New Lead', color: 'var(--accent-cyan)', bg: 'rgba(6,182,212,0.1)' },
  { key: 'Stand By', match: s => s === 'Stand By', color: 'var(--accent-orange)', bg: 'rgba(245,158,11,0.1)' },
  { key: 'Stalled', match: s => s === 'Stalled', color: 'var(--accent-red)', bg: 'rgba(239,68,68,0.1)' },
  { key: 'Due Diligence', match: s => s.includes('Due Diligence') || s.includes('Placing Bid'), color: 'var(--accent-purple)', bg: 'rgba(139,92,246,0.1)' },
];
const PRIORITY_COLORS = { '1 - High': { bg: 'rgba(239,68,68,0.15)', color: '#ef4444' }, '2 - Medium': { bg: 'rgba(245,158,11,0.15)', color: '#f59e0b' }, '3 - Low': { bg: 'rgba(100,116,139,0.15)', color: '#94a3b8' } };

// ============================================================
// INIT
// ============================================================
async function init() {
  try { const resp = await fetch('data.json'); DATA = await resp.json(); } catch (e) { DATA = { companies: [], pipeline: [], actions: [], meta: {} }; }
  initMap();
  buildFilters();
  applyFilters();
  renderPipeline();
  initDealEditPopover();
}

async function refreshData(silent = false) {
  const btn = document.getElementById('refreshBtn');
  btn.classList.add('refreshing');
  btn.disabled = true;
  if (!silent) showToast('Refreshing from Google Sheets...', 'pending');

  try {
    // Fetch pipeline + action items live from Google Sheets CSV export
    const [pipeCSV, actCSV] = await Promise.all([
      fetchGoogleSheetCSV(PIPELINE_GID),
      fetchGoogleSheetCSV(ACTIONS_GID),
    ]);

    const newPipeline = parsePipelineCSV(pipeCSV);
    const newActions = parseActionsCSV(actCSV);

    // Merge: preserve company/map data from data.json, update pipeline + actions
    DATA.pipeline = newPipeline;
    DATA.actions = newActions;

    // Re-apply done statuses from localStorage
    actionDoneSet.forEach(idx => {
      if (DATA.actions[idx] && DATA.actions[idx].status !== 'Done') {
        if (!actionPrevStatusMap.has(idx)) {
          actionPrevStatusMap.set(idx, DATA.actions[idx].status || 'Pending');
        }
        DATA.actions[idx].status = 'Done';
      }
    });

    // Re-render everything
    buildFilters();
    applyFilters();
    renderPipeline();
    renderActionItems();
    refreshPipelineCardActions();

    // Update last refresh timestamp
    lastRefreshTime = Date.now();
    updateRefreshTimestamp();

    if (!silent) showToast(`Refreshed: ${newPipeline.length} deals, ${newActions.length} action items`, 'success');
  } catch (err) {
    console.error('Refresh error:', err);
    if (!silent) showToast('Refresh failed: ' + err.message, 'error');
  }

  btn.classList.remove('refreshing');
  btn.disabled = false;
}

// ============================================================
// AUTO-REFRESH SCHEDULER
// ============================================================
let autoRefreshInterval = 5 * 60 * 1000; // 5 minutes default
let autoRefreshTimer = null;
let lastRefreshTime = Date.now();

function updateRefreshTimestamp() {
  const el = document.getElementById('lastRefreshTime');
  if (!el) return;
  const ago = Math.round((Date.now() - lastRefreshTime) / 1000);
  if (ago < 5) el.textContent = 'just now';
  else if (ago < 60) el.textContent = `${ago}s ago`;
  else el.textContent = `${Math.floor(ago / 60)}m ago`;
}

function startAutoRefresh() {
  stopAutoRefresh();
  autoRefreshTimer = setInterval(() => {
    refreshData(true); // silent auto-refresh
  }, autoRefreshInterval);
  // Also update the "last refreshed" display every 15s
  setInterval(updateRefreshTimestamp, 15000);
}

function stopAutoRefresh() {
  if (autoRefreshTimer) { clearInterval(autoRefreshTimer); autoRefreshTimer = null; }
}

// ============================================================
// MAP
// ============================================================
function initMap() {
  map = L.map('map', { center: [36, -96], zoom: 4, attributionControl: false, minZoom: 3 });
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
  statesLayer = L.layerGroup().addTo(map);
  markersLayer = L.layerGroup().addTo(map);
  ghostLayer = L.layerGroup().addTo(map);
  highlightLayer = L.layerGroup().addTo(map);
  map.on('popupclose', () => clearGhostMarkers());

  // Make map popups draggable by their header
  map.on('popupopen', function(e) {
    const popupEl = e.popup.getElement();
    if (!popupEl) return;
    const nameEl = popupEl.querySelector('.popup-name');
    if (!nameEl) return;
    nameEl.style.cursor = 'grab';
    nameEl.style.userSelect = 'none';

    let dragX = 0, dragY = 0, dragging = false;
    let startLeft = 0, startTop = 0;

    function onMouseDown(ev) {
      dragging = true;
      dragX = ev.clientX;
      dragY = ev.clientY;
      const style = window.getComputedStyle(popupEl);
      startLeft = parseInt(style.left) || 0;
      startTop = parseInt(style.top) || 0;
      nameEl.style.cursor = 'grabbing';
      map.dragging.disable();
      ev.preventDefault();
      ev.stopPropagation();
    }
    function onMouseMove(ev) {
      if (!dragging) return;
      const dx = ev.clientX - dragX;
      const dy = ev.clientY - dragY;
      popupEl.style.left = (startLeft + dx) + 'px';
      popupEl.style.top = (startTop + dy) + 'px';
      // Disable Leaflet's auto-repositioning
      popupEl.style.transition = 'none';
    }
    function onMouseUp() {
      if (!dragging) return;
      dragging = false;
      nameEl.style.cursor = 'grab';
      map.dragging.enable();
    }

    nameEl.addEventListener('mousedown', onMouseDown);
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);

    // Clean up listeners when popup closes
    e.popup.once('remove', () => {
      nameEl.removeEventListener('mousedown', onMouseDown);
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
    });
  });

  map.on('click', () => {
    if (selectedCards.size > 0) { clearCardSelection(); updateMapHighlights(); }
    if (activeKPI) { activeKPI = null; applyKPIHighlight(); updateTable(); document.querySelectorAll('.kpi-card[data-kpi]').forEach(c => c.classList.remove('selected','dimmed')); }
  });

  // Load US state boundaries GeoJSON
  fetch('https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json')
    .then(r => r.json())
    .then(geo => {
      stateGeoData = geo;
      renderStateBoundaries();
    })
    .catch(() => console.log('Could not load state boundaries'));
}

let _stateGeoLayer = null;
function renderStateBoundaries() {
  if (!stateGeoData) return;

  if (!_stateGeoLayer) {
    // First call: create the layer once
    _stateGeoLayer = L.geoJSON(stateGeoData, {
      style: feature => getStateStyle(feature.properties.name),
      onEachFeature: (feature, layer) => {
        const name = feature.properties.name;
        layer._stateName = name;
        layer.on({
          mouseover: e => {
            if (!activeFilters.state.has(name)) {
              e.target.setStyle({ fillColor: 'rgba(59, 130, 246, 0.12)', color: 'rgba(59, 130, 246, 0.3)', weight: 1.5 });
            }
          },
          mouseout: e => {
            if (!activeFilters.state.has(name)) {
              e.target.setStyle(getStateStyle(name));
            }
          },
          click: e => {
            L.DomEvent.stopPropagation(e);
            toggleStateFilter(name);
          }
        });
      }
    });
    statesLayer.addLayer(_stateGeoLayer);
  } else {
    // Subsequent calls: just update styles in place
    _stateGeoLayer.eachLayer(layer => {
      if (layer._stateName) layer.setStyle(getStateStyle(layer._stateName));
    });
  }
}

function getStateStyle(name) {
  const isActive = activeFilters.state.has(name);
  return {
    fillColor: isActive ? 'rgba(59, 130, 246, 0.25)' : 'rgba(255, 255, 255, 0.02)',
    fillOpacity: 1,
    color: isActive ? 'rgba(59, 130, 246, 0.6)' : 'rgba(255, 255, 255, 0.08)',
    weight: isActive ? 2 : 0.5,
  };
}

function updateStateFilterOverlay() {
  const overlay = document.getElementById('stateFilterOverlay');
  const label = document.getElementById('stateFilterLabel');
  if (activeFilters.state.size > 0) {
    const names = Array.from(activeFilters.state);
    const abbrs = names.map(n => STATE_NAME_TO_ABBR[n] || n);
    label.textContent = 'Filtered: ' + abbrs.join(', ');
    overlay.style.display = 'block';
  } else {
    overlay.style.display = 'none';
  }
}

function updateMap() {
  markersLayer.clearLayers();
  if (ghostLayer) ghostLayer.clearLayers();
  activeGhostCompany = null;

  // Pre-compute KPI matching set for dimming
  let kpiMatchNames = null, kpiMatchIds = null;
  if (activeKPI) {
    const kpiDef = KPI_DEFS.find(k => k.key === activeKPI);
    if (kpiDef) {
      kpiMatchNames = new Set();
      kpiMatchIds = new Set();
      filteredData.forEach(c => {
        if (kpiDef.fn(c)) {
          kpiMatchNames.add(c.name);
          if (c.airtableId) kpiMatchIds.add(c.airtableId);
        }
      });
    }
  }

  filteredData.forEach(c => {
    if (!c.lat || !c.lng) return;
    let color = getMarkerColor(c);
    const size = c.inPipeline ? 16 : c.assistedMeeting ? 14 : c.scheduledIntro ? 12 : c.responded ? 10 : 7;
    const glow = c.inPipeline ? 16 : c.assistedMeeting ? 12 : 6;

    // Determine if this marker should be dimmed by KPI filter
    let markerOpacity = 1;
    if (kpiMatchNames) {
      const isKPIMatch = (c.airtableId && kpiMatchIds.has(c.airtableId)) || kpiMatchNames.has(c.name);
      markerOpacity = isKPIMatch ? 1 : 0.1;
    }

    // Solo filter: if active, highlight matching companies in solo color, dim others
    if (soloFilter) {
      if (soloFilter.fn(c)) {
        color = soloFilter.color;
        markerOpacity = 1;
      } else {
        markerOpacity = 0.1;
        color = '#64748b';
      }
    }

    // Chart highlight: dim non-matching, scale matching by msg count
    let chartSize = null; // null = use default size
    if (chartHighlightCompanies) {
      const msgCount = chartHighlightCompanies.get(c.name) || 0;
      if (msgCount === 0) {
        markerOpacity = 0.08;
        color = '#64748b';
      } else {
        markerOpacity = 1;
        // Scale size: min 8px, max 28px based on count relative to max
        const ratio = chartHighlightMax > 1 ? msgCount / chartHighlightMax : 1;
        chartSize = Math.round(8 + ratio * 20);
      }
    }

    const finalSize = chartSize || size;
    const finalGlow = chartSize ? Math.round(finalSize * 0.8) : glow;

    let icon;
    if (c.bradfordFacility) {
      // Bradford: gold star for Facility, purple star for OP Office
      const isOP = c.bradfordFacility === 'Bradford OP Office';
      const bfSize = chartSize || (isOP ? 16 : 20);
      const bfColor = isOP ? '#a855f7' : '#fbbf24';
      const bfClass = isOP ? 'bf-purple' : 'bf-gold';
      icon = L.divIcon({
        className: `bradford-marker ${bfClass}`,
        html: `<div style="position:relative;width:${bfSize}px;height:${bfSize}px;opacity:${markerOpacity};">
          <div class="bradford-ring" style="position:absolute;top:-5px;left:-5px;width:${bfSize+10}px;height:${bfSize+10}px;border:2px solid ${bfColor}55;background:${bfColor}11;"></div>
          <svg viewBox="0 0 24 24" width="${bfSize}" height="${bfSize}" style="position:relative;z-index:1;">
            <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"
              fill="${bfColor}" stroke="rgba(255,255,255,0.9)" stroke-width="1.5" stroke-linejoin="round"/>
          </svg>
        </div>`,
        iconSize: [bfSize, bfSize], iconAnchor: [bfSize/2, bfSize/2]
      });
    } else {
      icon = L.divIcon({
        className: 'custom-marker',
        html: `<div style="width:${finalSize}px;height:${finalSize}px;background:${color};border-radius:50%;border:2px solid rgba(255,255,255,${c.inPipeline ? 0.8 : 0.4});box-shadow:0 0 ${finalGlow}px ${color}80;transition:all 0.3s;opacity:${markerOpacity};"></div>`,
        iconSize: [finalSize, finalSize], iconAnchor: [finalSize/2, finalSize/2]
      });
    }

    const marker = L.marker([c.lat, c.lng], { icon }).addTo(markersLayer);
    marker._companyName = c.name;
    marker._airtableId = c.airtableId || '';
    marker._companyColor = color;

    let statusBadge = '';
    if (c.inPipeline) statusBadge = `<span class="popup-badge" style="background:rgba(236,72,153,0.15);color:#ec4899">In Pipeline</span>`;
    else if (c.notInterested) statusBadge = `<span class="popup-badge" style="background:rgba(239,68,68,0.15);color:#ef4444">Not Interested</span>`;
    else if (c.assistedMeeting) statusBadge = `<span class="popup-badge" style="background:rgba(16,185,129,0.15);color:#10b981">Assisted Meeting</span>`;
    else if (c.scheduledIntro) statusBadge = `<span class="popup-badge" style="background:rgba(139,92,246,0.15);color:#8b5cf6">Intro Scheduled</span>`;
    else if (c.responded) statusBadge = `<span class="popup-badge" style="background:rgba(59,130,246,0.15);color:#3b82f6">Responded</span>`;
    else if (c.msgsSent > 0) statusBadge = `<span class="popup-badge" style="background:rgba(245,158,11,0.15);color:#f59e0b">Contacted</span>`;
    else statusBadge = `<span class="popup-badge" style="background:rgba(100,116,139,0.15);color:#94a3b8">Not Contacted</span>`;

    const ownershipBadge = c.ownership ? `<span class="popup-badge" style="background:${color}22;color:${color}">${c.ownership}</span>` : '';
    const bradfordBadge = c.bradfordFacility === 'Bradford OP Office'
      ? `<span class="popup-badge" style="background:rgba(168,85,247,0.15);color:#a855f7">⭐ Bradford OP Office</span>`
      : c.bradfordFacility ? `<span class="popup-badge" style="background:rgba(251,191,36,0.15);color:#fbbf24">⭐ Bradford Facility</span>` : '';

    const mediums = c.byMedium ? Object.entries(c.byMedium).map(([k,v]) => `${k}: ${v}`).join(', ') : '';

    const popup = L.popup({ className: 'custom-popup', maxWidth: 360 }).setContent(`
      <div class="popup-content">
        <div style="margin-bottom:10px">
          <div class="popup-name">${c.name}</div>
          <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">${bradfordBadge}${ownershipBadge} ${statusBadge}</div>
        </div>
        ${c.address ? `<div class="popup-row"><span class="popup-label">Address</span><span class="popup-val">${c.address}</span></div>` : ''}
        <div class="popup-row"><span class="popup-label">HQ State</span><span class="popup-val">${c.fullState || c.state || 'N/A'}</span></div>
        ${c.allStates && c.allStates.includes(',') ? `<div class="popup-row"><span class="popup-label">Operating In</span><span class="popup-val" style="font-size:11px">${c.allStates}</span></div>` : ''}
        <div class="popup-row"><span class="popup-label">Messages Sent</span><span class="popup-val">${c.msgsSent}</span></div>
        ${mediums ? `<div class="popup-row"><span class="popup-label">Channels</span><span class="popup-val">${mediums}</span></div>` : ''}
        <div class="popup-row"><span class="popup-label">Contacts Reached</span><span class="popup-val">${c.contactCount}</span></div>
        <div class="popup-row"><span class="popup-label">Responded</span><span class="popup-val">${c.responded ? 'Yes (' + c.respondedCount + ')' : 'No'}</span></div>
        <div class="popup-row"><span class="popup-label">Intro Call</span><span class="popup-val">${c.scheduledIntro ? 'Scheduled' : 'No'}</span></div>
        <div class="popup-row"><span class="popup-label">Assisted Meeting</span><span class="popup-val">${c.assistedMeeting ? 'Yes' : 'No'}</span></div>
        ${c.firstMsg ? `<div class="popup-row"><span class="popup-label">First Outreach</span><span class="popup-val">${c.firstMsg}</span></div>` : ''}
        ${c.lastMsg ? `<div class="popup-row"><span class="popup-label">Last Outreach</span><span class="popup-val">${c.lastMsg}</span></div>` : ''}
        ${c.pipelineStatus ? `<div class="popup-row"><span class="popup-label">Pipeline</span><span class="popup-val">${c.pipelineStatus}</span></div>` : ''}
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          ${c.website ? `<a class="popup-link" href="${c.website}" target="_blank">Visit Website &rarr;</a>` : ''}
          ${c.airtableId ? `<a class="popup-link" href="https://airtable.com/appsXvuuRisy7GiSH/tblO0w9kI3pE64B0B/${c.airtableId}" target="_blank" style="background:rgba(252,196,25,0.15);border-color:rgba(252,196,25,0.3);color:#fcc419">Airtable &rarr;</a>` : ''}
        </div>
      </div>
    `);
    marker.bindPopup(popup);
    marker.on('click', () => showOperatingStates(c, color));

    // Add secondary dots for non-HQ operating states
    if (c.allStates && c.allStates.includes(',')) {
      // Determine which state the actual HQ dot is plotted in (prefer address over fullState)
      // Handles mismatches like Warriors Heart: fullState="Virginia" but address="Bandera, TX"
      const skipAbbrs = new Set();
      const addrMatch = (c.address || '').match(/,\s*([A-Z]{2})\s+\d{5}/);
      if (addrMatch) {
        skipAbbrs.add(addrMatch[1]);
      } else {
        // Fallback when address doesn't have clear state abbr
        if (c.state) skipAbbrs.add(c.state.toUpperCase());
        if (c.fullState) { const a = STATE_ABBREV_JS[c.fullState]; if (a) skipAbbrs.add(a); }
      }

      const states = c.allStates.split(',').map(s => s.trim()).filter(s => s);
      states.forEach(stateName => {
        let abbr = stateName.length > 2 ? (STATE_ABBREV_JS[stateName] || stateName) : stateName.toUpperCase();
        if (abbr.length > 2) return; // couldn't resolve
        if (skipAbbrs.has(abbr)) return; // skip states where HQ dot already is
        const coords = getCoords(abbr, c.name + '_' + abbr); // offset to avoid overlap
        if (!coords[0]) return;

        const secSize = Math.max(size - 2, 5);
        const secIcon = L.divIcon({
          className: 'custom-marker secondary-marker',
          html: `<div style="width:${secSize}px;height:${secSize}px;background:${color}88;border-radius:50%;border:1.5px dashed rgba(255,255,255,0.5);box-shadow:0 0 ${glow}px ${color}40;transition:opacity 0.3s;opacity:${markerOpacity * 0.7};"></div>`,
          iconSize: [secSize, secSize], iconAnchor: [secSize/2, secSize/2]
        });

        const secMarker = L.marker(coords, { icon: secIcon }).addTo(markersLayer);
        secMarker._companyName = c.name;
        secMarker._airtableId = c.airtableId || '';
        secMarker._companyColor = color;
        secMarker._isSecondary = true;

        // Same popup as HQ marker
        secMarker.bindPopup(L.popup({ className: 'custom-popup', maxWidth: 360 }).setContent(`
          <div class="popup-content">
            <div style="margin-bottom:10px">
              <div class="popup-name">${c.name}</div>
              <div style="margin-top:4px;font-size:10px;color:var(--text-muted)">📍 Operating in ${stateName} (HQ: ${c.fullState || c.state})</div>
              <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">${ownershipBadge} ${statusBadge}</div>
            </div>
            ${c.address ? `<div class="popup-row"><span class="popup-label">HQ Address</span><span class="popup-val">${c.address}</span></div>` : ''}
            <div class="popup-row"><span class="popup-label">All States</span><span class="popup-val" style="font-size:11px">${c.allStates}</span></div>
            <div class="popup-row"><span class="popup-label">Messages Sent</span><span class="popup-val">${c.msgsSent}</span></div>
            <div class="popup-row"><span class="popup-label">Responded</span><span class="popup-val">${c.responded ? 'Yes (' + c.respondedCount + ')' : 'No'}</span></div>
            <div class="popup-row"><span class="popup-label">Intro Call</span><span class="popup-val">${c.scheduledIntro ? 'Scheduled' : 'No'}</span></div>
            <div class="popup-row"><span class="popup-label">Assisted Meeting</span><span class="popup-val">${c.assistedMeeting ? 'Yes' : 'No'}</span></div>
            ${c.pipelineStatus ? `<div class="popup-row"><span class="popup-label">Pipeline</span><span class="popup-val">${c.pipelineStatus}</span></div>` : ''}
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              ${c.website ? `<a class="popup-link" href="${c.website}" target="_blank">Visit Website &rarr;</a>` : ''}
              ${c.airtableId ? `<a class="popup-link" href="https://airtable.com/appsXvuuRisy7GiSH/tblO0w9kI3pE64B0B/${c.airtableId}" target="_blank" style="background:rgba(252,196,25,0.15);border-color:rgba(252,196,25,0.3);color:#fcc419">Airtable &rarr;</a>` : ''}
            </div>
          </div>
        `));
        secMarker.on('click', () => showOperatingStates(c, color));
      });
    }
  });
}

function clearGhostMarkers() {
  ghostLayer.clearLayers();
  activeGhostCompany = null;
}

function showOperatingStates(company, hqColor) {
  clearGhostMarkers();
  if (!company.allStates || !company.allStates.includes(',')) return;
  if (!company.lat || !company.lng) return;

  activeGhostCompany = company.name;
  const states = company.allStates.split(',').map(s => s.trim()).filter(s => s);

  // Determine which state the marker is actually plotted in
  // Prefer address-derived state (handles mismatches like Warriors Heart: fullState=Virginia but address in TX)
  const addrMatch = (company.address || '').match(/,\s*([A-Z]{2})\s+\d{5}/);
  const markerStateAbbr = addrMatch ? addrMatch[1] : (company.state || (STATE_ABBREV_JS[company.fullState] || '')).toUpperCase();

  // Build reverse lookup: abbreviation -> full name
  const ABBREV_TO_FULL = {};
  Object.entries(STATE_ABBREV_JS).forEach(([full, ab]) => { ABBREV_TO_FULL[ab] = full; });

  states.forEach(stateName => {
    // Resolve to abbreviation to get coords (handle both full names and abbreviations)
    let abbr = stateName;
    let displayName = stateName;
    if (stateName.length > 2) {
      abbr = STATE_ABBREV_JS[stateName] || stateName;
      displayName = stateName;
    } else {
      abbr = stateName.toUpperCase();
      displayName = ABBREV_TO_FULL[abbr] || stateName;
    }
    if (abbr.length > 2) return; // couldn't resolve
    // Skip the state where the marker is actually plotted
    if (abbr === markerStateAbbr) return;
    const coords = STATE_COORDS_JS[abbr];
    if (!coords) return;

    // Draw a dashed line from HQ to the state center
    const line = L.polyline(
      [[company.lat, company.lng], coords],
      { color: hqColor, weight: 1.5, opacity: 0.4, dashArray: '6 4', className: 'ghost-line' }
    );
    ghostLayer.addLayer(line);

    // Place a ghost marker at state center
    const ghostIcon = L.divIcon({
      className: 'ghost-marker',
      html: `<div style="width:14px;height:14px;background:${hqColor};border-radius:50%;border:2px dashed rgba(255,255,255,0.6);box-shadow:0 0 12px ${hqColor}60;display:flex;align-items:center;justify-content:center"><div style="width:4px;height:4px;background:white;border-radius:50%"></div></div>`,
      iconSize: [14, 14], iconAnchor: [7, 7]
    });

    const ghostMarker = L.marker(coords, { icon: ghostIcon }).addTo(ghostLayer);
    ghostMarker.bindPopup(L.popup({ className: 'custom-popup', maxWidth: 260 }).setContent(`
      <div class="popup-content" style="padding:12px;min-width:200px">
        <div class="popup-name" style="font-size:13px">${company.name}</div>
        <div style="font-size:11px;color:var(--text-muted);margin-top:4px">Also operates in <strong style="color:var(--text-primary)">${displayName}</strong></div>
        <div style="font-size:11px;color:var(--text-muted);margin-top:2px">HQ: ${company.fullState || company.state}</div>
      </div>
    `));
  });
}

// ============================================================
// FILTERS
// ============================================================
function buildFilters() {
  const companies = DATA.companies;

  // Pipeline stage filters — counts from DATA.pipeline (the Kanban source), not companies
  const pipe = DATA.pipeline || [];
  const pipelineStages = [
    { key: 'active', label: 'Active', color: '#10b981', count: pipe.filter(p => p.status.startsWith('Active')).length },
    { key: 'new_lead', label: 'New Lead', color: '#06b6d4', count: pipe.filter(p => p.status === 'New Lead').length },
    { key: 'stand_by', label: 'Stand By', color: '#f59e0b', count: pipe.filter(p => p.status === 'Stand By').length },
    { key: 'stalled', label: 'Stalled', color: '#ef4444', count: pipe.filter(p => p.status === 'Stalled').length },
    { key: 'due_diligence', label: 'Due Diligence', color: '#8b5cf6', count: pipe.filter(p => p.status.includes('Due Diligence') || p.status.includes('Placing Bid')).length },
  ];
  const pipeEl = document.getElementById('pipelineFilters');
  const pipelineFns = {
    'active': c => c.inPipeline && c.pipelineStatus && c.pipelineStatus.startsWith('Active'),
    'new_lead': c => c.inPipeline && c.pipelineStatus === 'New Lead',
    'stand_by': c => c.inPipeline && c.pipelineStatus === 'Stand By',
    'stalled': c => c.inPipeline && c.pipelineStatus === 'Stalled',
    'due_diligence': c => c.inPipeline && c.pipelineStatus && (c.pipelineStatus.includes('Due Diligence') || c.pipelineStatus.includes('Placing Bid')),
  };
  pipelineStages.forEach(item => {
    const fn = pipelineFns[item.key] || (() => false);
    filterDefs['pipeline:' + item.key] = { fn, type: 'pipeline', key: item.key, color: item.color };
    const btn = document.createElement('div');
    btn.className = 'filter-btn';
    btn.dataset.filterType = 'pipeline';
    btn.dataset.filterKey = item.key;
    btn.dataset.filterColor = item.color;
    btn.innerHTML = `<span class="filter-dot" style="background:${item.color}"></span>${item.label}<span class="filter-count">${item.count}</span>`;
    btn.addEventListener('click', () => {
      if (activeFilters.pipeline.has(item.key)) {
        activeFilters.pipeline.delete(item.key);
        btn.classList.remove('active');
      } else {
        activeFilters.pipeline.add(item.key);
        btn.classList.add('active');
      }
      updateSoloFilter('pipeline');
      applyFilters();
    });
    pipeEl.appendChild(btn);
  });

  // Make pipeline filters drag-and-drop for color priority
  pipeEl.classList.add('sortable-filter');
  new Sortable(pipeEl, {
    animation: 200,
    ghostClass: 'sortable-ghost',
    chosenClass: 'sortable-chosen',
    dragClass: 'sortable-drag',
    forceFallback: true,
    fallbackClass: 'sortable-drag',
    delay: 120,
    delayOnTouchOnly: false,
    onEnd: function() {
      if (mapColorMode === 'pipeline') { updateMap(); updateLegend(); }
    }
  });

  // Outreach status filters (inclusive — a company with a meeting also counts as intro scheduled)
  const statuses = [
    { key: 'assisted', label: 'Assisted Meeting', color: '#10b981', fn: c => c.assistedMeeting },
    { key: 'scheduled', label: 'Intro Scheduled', color: '#8b5cf6', fn: c => c.scheduledIntro },
    { key: 'responded', label: 'Responded', color: '#3b82f6', fn: c => c.responded },
    { key: 'contacted', label: 'Contacted (No Reply)', color: '#f59e0b', fn: c => c.msgsSent > 0 && !c.responded },
    { key: 'not_interested', label: 'Not Interested', color: '#ef4444', fn: c => c.notInterested },
    { key: 'follow_up', label: 'Follow Up Later', color: '#f97316', fn: c => c.followUpLater },
    { key: 'overridden', label: 'Overridden (Bad Fit)', color: '#6b7280', fn: c => c.override },
    { key: 'not_overridden', label: 'Not Overridden', color: '#22d3ee', fn: c => !c.override },
  ];
  renderFilterGroup('outreachFilters', statuses, 'status', companies);

  // Ownership — prepend Bradford filters (Facility + OP Office)
  const bradfordFacilityFilter = { key: 'bradford_facility', label: 'Bradford Facility', color: '#fbbf24', fn: c => c.bradfordFacility === 'Bradford Facility', starIcon: true };
  const bradfordOPFilter = { key: 'bradford_op', label: 'Bradford OP Office', color: '#a855f7', fn: c => c.bradfordFacility === 'Bradford OP Office', starIcon: true };
  const ownerships = [
    ...(companies.some(bradfordFacilityFilter.fn) ? [bradfordFacilityFilter] : []),
    ...(companies.some(bradfordOPFilter.fn) ? [bradfordOPFilter] : []),
    ...Object.keys(OWNERSHIP_COLORS).map(k => ({
      key: k, label: k, color: OWNERSHIP_COLORS[k], fn: c => c.ownership === k
    })).filter(o => companies.some(o.fn))
  ];
  renderFilterGroup('ownershipFilters', ownerships, 'ownership', companies);

  // Medium
  const mediums = Object.entries(DATA.meta.mediumCounts || {}).sort((a,b) => b[1]-a[1]).map(([k]) => ({
    key: k, label: k, color: 'var(--accent-cyan)', fn: c => c.byMedium && c.byMedium[k] > 0
  }));
  renderFilterGroup('mediumFilters', mediums, 'medium', companies);

  // Account
  const accounts = Object.entries(DATA.meta.accountCounts || {}).sort((a,b) => b[1]-a[1]).map(([k]) => ({
    key: k, label: k, color: 'var(--accent-purple)', fn: c => c.byAccount && c.byAccount[k] > 0
  }));
  renderFilterGroup('accountFilters', accounts, 'account', companies);

  document.getElementById('searchInput').addEventListener('input', e => {
    activeFilters.search = e.target.value.toLowerCase();
    applyFilters();
  });
}

function renderFilterGroup(containerId, items, filterType, companies) {
  const el = document.getElementById(containerId);
  const isSortable = { outreachFilters: 'status', pipelineFilters: 'pipeline', ownershipFilters: 'ownership' }[containerId];

  items.forEach(item => {
    const count = companies.filter(item.fn).length;
    filterDefs[filterType + ':' + item.key] = { fn: item.fn, type: filterType, key: item.key, color: item.color };
    const btn = document.createElement('div');
    btn.className = 'filter-btn';
    btn.dataset.filterType = filterType;
    btn.dataset.filterKey = item.key;
    btn.dataset.filterColor = item.color;
    const bullet = item.starIcon
      ? `<svg viewBox="0 0 24 24" width="14" height="14" style="flex-shrink:0"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26" fill="${item.color}" stroke="rgba(255,255,255,0.7)" stroke-width="1.5" stroke-linejoin="round"/></svg>`
      : `<span class="filter-dot" style="background:${item.color}"></span>`;
    btn.innerHTML = `${bullet}${item.label}<span class="filter-count">${count}</span>`;
    btn.addEventListener('click', () => {
      if (activeFilters[filterType].has(item.key)) {
        activeFilters[filterType].delete(item.key);
        btn.classList.remove('active');
      } else {
        activeFilters[filterType].add(item.key);
        btn.classList.add('active');
      }
      updateSoloFilter(filterType);
      applyFilters();
    });
    el.appendChild(btn);
  });

  // Make colorable sections drag-and-drop for priority reorder
  if (isSortable) {
    el.classList.add('sortable-filter');
    new Sortable(el, {
      animation: 200,
      ghostClass: 'sortable-ghost',
      chosenClass: 'sortable-chosen',
      dragClass: 'sortable-drag',
      forceFallback: true,
      fallbackClass: 'sortable-drag',
      delay: 120,
      delayOnTouchOnly: false,
      onEnd: function() {
        if (mapColorMode === isSortable) { updateMap(); updateLegend(); }
      }
    });
  }
}

// Determine solo filter state based on active filters in the current color-mode section
// Sets state + CSS classes only; does NOT trigger re-render (caller should call applyFilters or updateMap)
function updateSoloFilter(changedFilterType) {
  // Map filter types to color modes
  const typeToMode = { status: 'status', pipeline: 'pipeline', ownership: 'ownership' };
  const mode = typeToMode[changedFilterType];

  // Clear previous solo CSS
  document.querySelectorAll('.filter-section.has-solo').forEach(s => s.classList.remove('has-solo'));
  document.querySelectorAll('.filter-btn.solo').forEach(b => b.classList.remove('solo'));

  // Only activate solo if this section controls map colors
  if (mode && mapColorMode === mode) {
    const activeInSection = [...activeFilters[changedFilterType]];
    if (activeInSection.length === 1) {
      const key = activeInSection[0];
      const def = filterDefs[changedFilterType + ':' + key];
      if (def) {
        soloFilter = { type: changedFilterType, key: key, color: def.color, fn: def.fn };
        // Add solo class and section flag
        const section = document.getElementById(getSectionContainerId(changedFilterType)).closest('.filter-section');
        if (section) section.classList.add('has-solo');
        document.querySelectorAll(`.filter-btn[data-filter-type="${changedFilterType}"]`).forEach(btn => {
          btn.classList.toggle('solo', btn.dataset.filterKey === key);
          if (btn.dataset.filterKey === key) btn.style.setProperty('--solo-color', def.color);
        });
        return;
      }
    }
  }

  // Clear solo state
  soloFilter = null;
}

function getSectionContainerId(filterType) {
  const m = { status: 'outreachFilters', pipeline: 'pipelineFilters', ownership: 'ownershipFilters' };
  return m[filterType] || filterType + 'Filters';
}

function clearSoloFilter() {
  if (!soloFilter) return;
  soloFilter = null;
  document.querySelectorAll('.filter-section.has-solo').forEach(s => s.classList.remove('has-solo'));
  document.querySelectorAll('.filter-btn.solo').forEach(b => b.classList.remove('solo'));
}

function applyFilters() {
  filteredData = DATA.companies.filter(c => {
    if (activeFilters.search && !c.name.toLowerCase().includes(activeFilters.search) &&
        !(c.address || '').toLowerCase().includes(activeFilters.search) &&
        !(c.fullState || '').toLowerCase().includes(activeFilters.search) &&
        !(c.allStates || '').toLowerCase().includes(activeFilters.search)) return false;

    if (activeFilters.pipeline.size > 0) {
      let m = false;
      if (activeFilters.pipeline.has('active') && c.inPipeline && c.pipelineStatus.startsWith('Active')) m = true;
      if (activeFilters.pipeline.has('new_lead') && c.inPipeline && c.pipelineStatus === 'New Lead') m = true;
      if (activeFilters.pipeline.has('stand_by') && c.inPipeline && c.pipelineStatus === 'Stand By') m = true;
      if (activeFilters.pipeline.has('stalled') && c.inPipeline && c.pipelineStatus === 'Stalled') m = true;
      if (activeFilters.pipeline.has('due_diligence') && c.inPipeline && (c.pipelineStatus.includes('Due Diligence') || c.pipelineStatus.includes('Placing Bid'))) m = true;
      if (!m) return false;
    }

    if (activeFilters.status.size > 0) {
      let m = false;
      if (activeFilters.status.has('assisted') && c.assistedMeeting) m = true;
      if (activeFilters.status.has('scheduled') && c.scheduledIntro) m = true;
      if (activeFilters.status.has('responded') && c.responded) m = true;
      if (activeFilters.status.has('contacted') && c.msgsSent > 0 && !c.responded) m = true;
      if (activeFilters.status.has('not_interested') && c.notInterested) m = true;
      if (activeFilters.status.has('follow_up') && c.followUpLater) m = true;
      if (activeFilters.status.has('overridden') && c.override) m = true;
      if (activeFilters.status.has('not_overridden') && !c.override) m = true;
      if (!m) return false;
    }

    if (activeFilters.state.size > 0 && !activeFilters.state.has(c.fullState || c.state)) return false;

    if (activeFilters.ownership.size > 0) {
      let ownershipMatch = activeFilters.ownership.has(c.ownership);
      if (!ownershipMatch && activeFilters.ownership.has('bradford_facility') && c.bradfordFacility === 'Bradford Facility') ownershipMatch = true;
      if (!ownershipMatch && activeFilters.ownership.has('bradford_op') && c.bradfordFacility === 'Bradford OP Office') ownershipMatch = true;
      if (!ownershipMatch) return false;
    }

    if (activeFilters.medium.size > 0) {
      let m = false;
      for (const med of activeFilters.medium) { if (c.byMedium && c.byMedium[med] > 0) { m = true; break; } }
      if (!m) return false;
    }

    if (activeFilters.account.size > 0) {
      let m = false;
      for (const acct of activeFilters.account) { if (c.byAccount && c.byAccount[acct] > 0) { m = true; break; } }
      if (!m) return false;
    }

    return true;
  });

  updateAll();
}

function updateAll() {
  document.getElementById('companyCount').textContent = filteredData.length;
  document.getElementById('messageCount').textContent = filteredData.reduce((s, c) => s + c.msgsSent, 0).toLocaleString();
  updateFilterCounts();
  updateKPIs();
  updateMap();
  updateCharts();
  updateTable();
  updateLegend();
}

function updateFilterCounts() {
  document.querySelectorAll('.filter-btn[data-filter-type][data-filter-key]').forEach(btn => {
    const def = filterDefs[btn.dataset.filterType + ':' + btn.dataset.filterKey];
    if (!def) return;
    const countEl = btn.querySelector('.filter-count');
    if (!countEl) return;
    const newCount = filteredData.filter(def.fn).length;
    countEl.textContent = newCount;
  });
}

// ============================================================
// KPIs
// ============================================================
// KPI definitions with filter functions for map highlighting
const KPI_DEFS = [
  { key: 'reached',   label: 'Companies Reached',  color: 'var(--accent-blue)',   fn: c => true },
  { key: 'messages',  label: 'Total Messages',      color: 'var(--accent-cyan)',   fn: c => c.msgsSent > 0 },
  { key: 'responses', label: 'Responses',           color: '#3b82f6',             fn: c => c.responded },
  { key: 'intros',    label: 'Intros Scheduled',    color: 'var(--accent-purple)', fn: c => c.scheduledIntro },
  { key: 'meetings',  label: 'Assisted Meetings',   color: 'var(--accent-green)',  fn: c => c.assistedMeeting },
  { key: 'pipeline',  label: 'In Pipeline',         color: 'var(--accent-pink)',   fn: c => c.inPipeline },
  { key: 'not_interested', label: 'Not Interested',  color: 'var(--accent-red)',   fn: c => c.notInterested },
];

function updateKPIs() {
  const d = filteredData;
  const totalMsgs = d.reduce((s, c) => s + c.msgsSent, 0);
  const contacted = d.filter(c => c.msgsSent > 0).length;
  // Inclusive/cumulative counts (a company with an assisted meeting also counts as intro scheduled)
  const responded = d.filter(c => c.responded).length;
  const scheduledIntro = d.filter(c => c.scheduledIntro).length;
  const assistedMeeting = d.filter(c => c.assistedMeeting).length;
  const inPipeline = d.filter(c => c.inPipeline).length;
  const respRate = contacted > 0 ? ((responded / contacted) * 100).toFixed(1) : '0';

  const kpiValues = {
    reached: { value: d.length, sub: `${contacted} contacted` },
    messages: { value: totalMsgs, sub: `Across ${contacted} companies` },
    responses: { value: responded, sub: `${respRate}% response rate` },
    intros: { value: scheduledIntro, sub: `${d.length > 0 ? ((scheduledIntro/d.length)*100).toFixed(1) : '0'}% of companies reached` },
    meetings: { value: assistedMeeting, sub: `${scheduledIntro > 0 ? ((assistedMeeting/scheduledIntro)*100).toFixed(0) : 0}% of intros` },
    pipeline: { value: inPipeline, sub: `Active deals` },
    not_interested: { value: d.filter(c => c.notInterested).length, sub: `${d.filter(c => c.followUpLater).length} follow up later` },
  };

  document.getElementById('kpiRow').innerHTML = KPI_DEFS.map((k, i) => {
    const v = kpiValues[k.key];
    const sel = activeKPI === k.key ? 'selected' : (activeKPI ? 'dimmed' : '');
    return `
    <div class="kpi-card animate-in ${sel}" data-kpi="${k.key}" style="--kpi-color:${k.color};animation-delay:${i*0.04}s">
      <div class="kpi-label">${k.label}</div>
      <div class="kpi-value" style="color:${k.color}">${v.value.toLocaleString()}</div>
      <div class="kpi-sub">${v.sub}</div>
    </div>
  `;}).join('');

  // Attach click handlers (more reliable than inline onclick)
  document.querySelectorAll('.kpi-card[data-kpi]').forEach(card => {
    card.addEventListener('click', () => toggleKPI(card.dataset.kpi));
  });
}

function toggleKPI(key) {
  // Clear pipeline card selection when using KPI highlight
  if (selectedCards.size > 0) { clearCardSelection(); if (highlightLayer) highlightLayer.clearLayers(); }

  if (activeKPI === key) {
    activeKPI = null; // deselect
  } else {
    activeKPI = key;
  }

  // Update KPI card visual states (without full re-render to avoid flicker)
  document.querySelectorAll('.kpi-card[data-kpi]').forEach(card => {
    card.classList.remove('selected', 'dimmed');
    if (activeKPI === card.dataset.kpi) card.classList.add('selected');
    else if (activeKPI) card.classList.add('dimmed');
  });

  applyKPIHighlight();
  updateTable();
}

function applyKPIHighlight() {
  // Re-render map — updateMap() reads activeKPI and bakes dimming into marker icons
  updateMap();
}

// ============================================================
// PIPELINE BOARD
// ============================================================
function renderPipeline() {
  const pipe = DATA.pipeline;

  // Clear any card selection (board is being re-rendered)
  clearCardSelection();
  if (highlightLayer) highlightLayer.clearLayers();

  // Update tab counts
  document.getElementById('tabPipelineCount').textContent = pipe ? pipe.length : 0;
  document.getElementById('tabActionsCount').textContent = DATA.actions ? DATA.actions.length : 0;

  if (!pipe || pipe.length === 0) { document.getElementById('pipelineSection').style.display = 'none'; return; }

  const active = pipe.filter(p => p.status.startsWith('Active')).length;
  const standby = pipe.filter(p => p.status === 'Stand By').length;
  const stalled = pipe.filter(p => p.status === 'Stalled').length;
  const newLeads = pipe.filter(p => p.status === 'New Lead').length;

  document.getElementById('pipelineStats').innerHTML = `
    <div class="pipeline-stat"><strong>${pipe.length}</strong> Total Deals</div>
    <div class="pipeline-stat"><strong>${active}</strong> Active</div>
    <div class="pipeline-stat"><strong>${standby}</strong> Stand By</div>
    <div class="pipeline-stat"><strong>${newLeads}</strong> New Leads</div>
    <div class="pipeline-stat"><strong>${stalled}</strong> Stalled</div>
  `;

  document.getElementById('pipelineBoard').innerHTML = PIPELINE_COLUMNS.map(col => {
    const deals = pipe.filter(p => col.match(p.status));
    return `
      <div class="pipeline-col" data-status="${col.key}">
        <div class="pipeline-col-header">
          <div class="pipeline-col-title" style="color:${col.color}">${col.key}</div>
          <div class="pipeline-col-count" style="background:${col.bg};color:${col.color}">${deals.length}</div>
        </div>
        <div class="pipeline-col-cards" data-status="${col.key}">
          ${deals.map(d => {
            const pc = PRIORITY_COLORS[d.priority] || PRIORITY_COLORS['3 - Low'];
            const ndaCls = (d.ndaStatus||'').toLowerCase().includes('signed') ? 'nda-signed' : (d.ndaStatus||'').toLowerCase().includes('sent') ? 'nda-sent' : (d.ndaStatus||'').toLowerCase().includes('loi') ? 'nda-loi' : '';
            const hasDR = d.dataRoom && d.dataRoom !== 'No' && d.dataRoom !== 'N/A';
            const hasSV = d.siteVisit && d.siteVisit !== 'Visit TBD' && d.siteVisit !== 'N/A';
            return `
              <div class="pipeline-card" data-deal-name="${d.name}" data-original-status="${d.status}" data-airtable-id="${d.airtableId || ''}">
                <button class="pipeline-card-edit-btn" title="Edit deal">&#8942;</button>
                <div class="pipeline-card-name">${d.name}</div>
                <div class="pipeline-card-detail"><strong>${d.states || '—'}</strong> · ${d.type || 'TBD'}</div>
                ${d.keyContact ? `<div class="pipeline-card-detail">👤 ${d.keyContact}</div>` : ''}
                ${d.ebitda && d.ebitda !== 'TBD' ? `<div class="pipeline-card-detail" style="color:var(--accent-green)">💰 ${d.ebitda}</div>` : ''}
                ${(() => { const la = getNextActionForDeal(d.name); if (la) { const pc2 = la.priority === 'URGENT' ? 'var(--accent-red)' : la.priority === 'HIGH' ? 'var(--accent-orange)' : 'var(--text-secondary)'; const at = la.action.substring(0,100) + (la.action.length > 100 ? '...' : ''); return `<div class="pipeline-card-detail" style="color:${pc2};margin-top:4px">→ ${at}</div>`; } return ''; })()}
                <div class="pipeline-card-badges">
                  <span class="pipeline-card-priority" style="background:${pc.bg};color:${pc.color}">${d.priority || '—'}</span>
                  ${d.status !== col.key ? `<span class="pipeline-card-priority" style="background:${col.bg};color:${col.color}">${d.status}</span>` : ''}
                  ${ndaCls ? `<span class="pipeline-card-badge ${ndaCls}">NDA: ${d.ndaStatus}</span>` : ''}
                  ${hasDR ? `<span class="pipeline-card-badge data-room">📁 ${d.dataRoom}</span>` : ''}
                  ${hasSV ? `<span class="pipeline-card-badge site-visited">📍 ${d.siteVisit}</span>` : ''}
                </div>
                ${d.actionOwner || d.deadline ? `<div class="pipeline-card-meta"><span>${d.actionOwner ? '🎯 ' + d.actionOwner : ''}</span><span>${d.deadline && d.deadline !== 'TBD' ? '📅 ' + d.deadline : ''}</span></div>` : ''}
                ${d.notes ? `<div class="pipeline-card-notes">${d.notes}</div>` : ''}
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `;
  }).join('');

  // Initialize drag-and-drop, card selection, and edit buttons after rendering
  initSortable();
  initCardSelection();
  wireAllEditButtons();

  // Migrate manual nextAction text into proper action items
  migrateManualNextActions();

  // Initialize date range pickers for funnel and channel charts
  initFunnelDateRange();
  initChannelDateRange();

  // Initialize action items system
  initActionItems();
  renderActionItems();

  // Start auto-refresh from Google Sheets (every 5 min)
  startAutoRefresh();
}

// ============================================================
// ACTION ITEMS SYSTEM
// ============================================================
let actionDoneSet = new Set(); // indices of completed actions
const actionPrevStatusMap = new Map(); // idx -> previous status before marking done
let actionShowDone = false;

// Convert various date text formats to YYYY-MM-DD for <input type="date">
function toDateInputValue(text) {
  if (!text) return '';
  // Already YYYY-MM-DD
  if (/^\d{4}-\d{2}-\d{2}$/.test(text)) return text;
  // MM/DD/YYYY or M/D/YYYY
  const mdy = text.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (mdy) return `${mdy[3]}-${mdy[1].padStart(2,'0')}-${mdy[2].padStart(2,'0')}`;
  // Try native Date parsing as fallback
  const d = new Date(text);
  if (!isNaN(d.getTime())) {
    return d.toISOString().split('T')[0];
  }
  return '';
}

// Convert YYYY-MM-DD back to display format MM/DD/YYYY
function fromDateInputValue(isoDate) {
  if (!isoDate) return '';
  const parts = isoDate.split('-');
  if (parts.length === 3) return `${parseInt(parts[1])}/${parseInt(parts[2])}/${parts[0]}`;
  return isoDate;
}

function matchesDeal(dealName, facility) {
  const dealLower = dealName.toLowerCase();
  const facLower = (facility || '').toLowerCase();
  if (!facLower) return false;
  return dealLower === facLower || dealLower.includes(facLower) || facLower.includes(dealLower);
}

function getAllActionsForDeal(dealName) {
  if (!DATA.actions || DATA.actions.length === 0) return [];
  const priorityOrder = { 'URGENT': 0, 'HIGH': 1, 'MEDIUM': 2, 'LOW': 3 };
  return DATA.actions
    .map((a, i) => ({ ...a, _idx: i }))
    .filter(a => matchesDeal(dealName, a.facility))
    .sort((a, b) => {
      const doneA = actionDoneSet.has(a._idx) ? 1 : 0;
      const doneB = actionDoneSet.has(b._idx) ? 1 : 0;
      if (doneA !== doneB) return doneA - doneB;
      return (priorityOrder[a.priority] ?? 9) - (priorityOrder[b.priority] ?? 9);
    });
}

function getNextActionForDeal(dealName) {
  const all = getAllActionsForDeal(dealName);
  const pending = all.filter(a => !actionDoneSet.has(a._idx));
  return pending.length > 0 ? pending[0] : null;
}

// ============================================================
// MIGRATE: Convert manual nextAction text → proper action items
// Runs once on init. Checks localStorage to avoid duplicating.
// ============================================================
function migrateManualNextActions() {
  if (!DATA.pipeline || !DATA.actions) return;

  // Track which deals already have linked action items
  const dealsWithActions = new Set();
  DATA.actions.forEach(a => {
    DATA.pipeline.forEach(d => {
      if (matchesDeal(d.name, a.facility)) dealsWithActions.add(d.name);
    });
  });

  // Check localStorage for already-migrated deals
  let migratedDeals = new Set();
  try {
    const saved = localStorage.getItem('migratedNextActions');
    if (saved) migratedDeals = new Set(JSON.parse(saved));
  } catch(e) {}

  const toMigrate = [];
  DATA.pipeline.forEach(d => {
    if (!d.nextAction || !d.nextAction.trim()) return;
    if (dealsWithActions.has(d.name)) return; // already has action items
    if (migratedDeals.has(d.name)) return; // already migrated previously

    toMigrate.push(d);
  });

  if (toMigrate.length === 0) return;

  console.log(`Migrating ${toMigrate.length} manual nextActions to action items...`);

  toMigrate.forEach(d => {
    const newAction = {
      priority: 'MEDIUM',
      action: d.nextAction.trim(),
      facility: d.name,
      owner: d.actionOwner || '',
      deadline: d.deadline || '',
      status: 'Pending',
      notes: '',
      pipelineStatus: d.status || '',
    };

    DATA.actions.push(newAction);
    migratedDeals.add(d.name);

    // Write to Google Sheet
    writeNewActionToSheet(newAction);
  });

  // Save migrated set to localStorage so we don't re-migrate on reload
  try { localStorage.setItem('migratedNextActions', JSON.stringify([...migratedDeals])); } catch(e) {}

  console.log(`Migrated ${toMigrate.length} action items successfully`);
}

function initActionItems() {
  // Load done state from localStorage
  try {
    const saved = localStorage.getItem('actionDoneSet');
    if (saved) actionDoneSet = new Set(JSON.parse(saved));
  } catch(e) {}
  // Load previous status map and apply Done status to done items
  try {
    const savedMap = localStorage.getItem('actionPrevStatusMap');
    if (savedMap) {
      const entries = JSON.parse(savedMap);
      entries.forEach(([k, v]) => actionPrevStatusMap.set(k, v));
    }
  } catch(e) {}
  // Ensure all done items have status "Done" in memory
  actionDoneSet.forEach(idx => {
    if (DATA.actions[idx] && DATA.actions[idx].status !== 'Done') {
      if (!actionPrevStatusMap.has(idx)) {
        actionPrevStatusMap.set(idx, DATA.actions[idx].status || 'Pending');
      }
      DATA.actions[idx].status = 'Done';
    }
  });

  // Populate owner filter from data
  const ownerSelect = document.getElementById('actionFilterOwner');
  if (ownerSelect) {
    const owners = new Set();
    (DATA.actions || []).forEach(a => { if (a.owner) a.owner.split(/[\/,&]+/).map(s => s.trim()).filter(Boolean).forEach(o => owners.add(o)); });
    ownerSelect.innerHTML = '<option value="">All Owners</option>' + [...owners].sort().map(o => `<option>${o}</option>`).join('');
  }

  // Populate facility filter from data
  const facilitySelect = document.getElementById('actionFilterFacility');
  if (facilitySelect) {
    const facilities = new Set();
    (DATA.actions || []).forEach(a => { if (a.facility) facilities.add(a.facility.trim()); });
    facilitySelect.innerHTML = '<option value="">All Facilities</option>' + [...facilities].sort().map(f => `<option>${f}</option>`).join('');
  }

  // Wire toolbar controls
  ['actionFilterPriority', 'actionFilterStatus', 'actionFilterOwner', 'actionFilterFacility', 'actionSort', 'actionGroupBy'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('change', renderActionItems);
  });

  // Show done toggle
  const showDoneBtn = document.getElementById('actionShowDone');
  if (showDoneBtn) {
    showDoneBtn.addEventListener('click', () => {
      actionShowDone = !actionShowDone;
      showDoneBtn.classList.toggle('active', actionShowDone);
      renderActionItems();
    });
  }

  // New action item button
  const newBtn = document.getElementById('actionNewBtn');
  if (newBtn) {
    newBtn.addEventListener('click', () => openCreateActionPopover(null, newBtn));
  }
}

function renderActionItems() {
  const grid = document.getElementById('actionItemsGrid');
  if (!DATA.actions || DATA.actions.length === 0) {
    grid.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted)">No action items</div>';
    document.getElementById('actionItemCount').textContent = '(0)';
    return;
  }

  // Build indexed list
  let items = DATA.actions.map((a, i) => ({ ...a, _idx: i, _done: actionDoneSet.has(i) }));

  // Filter
  const fPriority = document.getElementById('actionFilterPriority')?.value || '';
  const fStatus = document.getElementById('actionFilterStatus')?.value || '';
  const fOwner = document.getElementById('actionFilterOwner')?.value || '';
  const fFacility = document.getElementById('actionFilterFacility')?.value || '';

  if (fPriority) items = items.filter(a => a.priority === fPriority);
  if (fStatus) items = items.filter(a => a.status === fStatus);
  if (fOwner) items = items.filter(a => (a.owner || '').includes(fOwner));
  if (fFacility) items = items.filter(a => (a.facility || '').trim() === fFacility);

  // Hide done unless toggled
  if (!actionShowDone) items = items.filter(a => !a._done);

  // Sort
  const sortKey = document.getElementById('actionSort')?.value || 'priority';
  const priorityOrder = { 'URGENT': 0, 'HIGH': 1, 'MEDIUM': 2, 'LOW': 3 };
  const statusOrder = { 'Overdue': 0, 'Pending': 1, 'Not Started': 2, 'Waiting': 3, 'Scheduled': 4, 'Planning': 5, 'Stalled': 6 };

  items.sort((a, b) => {
    // Done items always at bottom
    if (a._done !== b._done) return a._done ? 1 : -1;
    if (sortKey === 'priority') return (priorityOrder[a.priority] ?? 9) - (priorityOrder[b.priority] ?? 9);
    if (sortKey === 'status') return (statusOrder[a.status] ?? 9) - (statusOrder[b.status] ?? 9);
    if (sortKey === 'owner') return (a.owner || '').localeCompare(b.owner || '');
    if (sortKey === 'facility') return (a.facility || '').localeCompare(b.facility || '');
    if (sortKey === 'deadline') return (a.deadline || 'zzz').localeCompare(b.deadline || 'zzz');
    return 0;
  });

  // Group
  const groupBy = document.getElementById('actionGroupBy')?.value || '';
  let html = '';

  // Column header
  html += `<div class="action-items-header">
    <span></span><span>Priority</span><span>Action</span><span>Facility</span><span>Owner</span><span>Deadline</span><span>Status</span><span></span>
  </div>`;

  const statusMap = { 'overdue': 'overdue', 'pending': 'pending', 'scheduled': 'scheduled', 'planning': 'planning', 'stalled': 'stalled', 'not-started': 'pending', 'waiting': 'pending' };

  function renderRow(a) {
    const pCls = (a.priority || '').toLowerCase();
    const sCls = (a.status || '').toLowerCase().replace(/\s+/g, '-');
    const sClass = statusMap[sCls] || 'pending';
    return `
      <div class="action-item-row ${a._done ? 'done' : ''}" data-action-idx="${a._idx}">
        <button class="action-done-btn" data-idx="${a._idx}" title="${a._done ? 'Mark undone' : 'Mark done'}">&#10003;</button>
        <span class="action-priority-badge ${pCls}">${a.priority}</span>
        <div>
          <div style="font-weight:600;color:var(--text-primary)">${a.action}</div>
          ${a.notes ? `<div style="font-size:10px;color:var(--text-muted);margin-top:2px">${a.notes}</div>` : ''}
        </div>
        <div style="color:var(--text-secondary);font-size:11px">${a.facility}</div>
        <div style="color:var(--text-muted)">${a.owner}</div>
        <div style="color:var(--text-secondary);font-size:11px">${a.deadline}</div>
        <span class="action-status-badge ${sClass}">${a.status}</span>
        <button class="action-edit-btn" data-idx="${a._idx}" title="Edit">&#8942;</button>
      </div>`;
  }

  if (groupBy) {
    const groups = {};
    items.forEach(a => {
      const key = a[groupBy] || 'Other';
      if (!groups[key]) groups[key] = [];
      groups[key].push(a);
    });
    // Sort group keys
    const groupKeys = Object.keys(groups).sort((a, b) => {
      if (groupBy === 'priority') return (priorityOrder[a] ?? 9) - (priorityOrder[b] ?? 9);
      if (groupBy === 'status') return (statusOrder[a] ?? 9) - (statusOrder[b] ?? 9);
      return a.localeCompare(b);
    });
    groupKeys.forEach(key => {
      html += `<div class="action-group-header">${key} <span style="font-weight:400;opacity:0.5">(${groups[key].length})</span></div>`;
      groups[key].forEach(a => { html += renderRow(a); });
    });
  } else {
    items.forEach(a => { html += renderRow(a); });
  }

  grid.innerHTML = html;

  // Update counts
  const totalVisible = items.length;
  const totalDone = DATA.actions.filter((_, i) => actionDoneSet.has(i)).length;
  document.getElementById('actionItemCount').textContent = `(${totalVisible}${totalDone > 0 ? ` / ${totalDone} done` : ''})`;
  document.getElementById('tabActionsCount').textContent = DATA.actions.length - totalDone;

  // Wire done buttons
  grid.querySelectorAll('.action-done-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      const idx = parseInt(this.dataset.idx);
      const row = this.closest('.action-item-row');
      const isDone = !actionDoneSet.has(idx);

      if (isDone) {
        actionDoneSet.add(idx);
        // Save previous status and set to Done
        if (DATA.actions[idx].status && DATA.actions[idx].status !== 'Done') {
          actionPrevStatusMap.set(idx, DATA.actions[idx].status);
        }
        DATA.actions[idx].status = 'Done';
        row.classList.add('done');
        if (!actionShowDone) {
          row.classList.add('hiding');
          setTimeout(() => { renderActionItems(); refreshPipelineCardActions(); }, 350);
          writeActionDoneToSheet(DATA.actions[idx], true);
          try { localStorage.setItem('actionDoneSet', JSON.stringify([...actionDoneSet])); } catch(e) {}
          try { localStorage.setItem('actionPrevStatusMap', JSON.stringify([...actionPrevStatusMap])); } catch(e) {}
          return;
        }
      } else {
        actionDoneSet.delete(idx);
        // Restore previous status
        const prevStatus = actionPrevStatusMap.get(idx) || 'Pending';
        DATA.actions[idx].status = prevStatus;
        actionPrevStatusMap.delete(idx);
        row.classList.remove('done');
      }
      // Save to localStorage + sheet
      try { localStorage.setItem('actionDoneSet', JSON.stringify([...actionDoneSet])); } catch(e) {}
      try { localStorage.setItem('actionPrevStatusMap', JSON.stringify([...actionPrevStatusMap])); } catch(e) {}
      writeActionDoneToSheet(DATA.actions[idx], isDone);
      renderActionItems();
      refreshPipelineCardActions();
    });
  });

  // Wire edit buttons
  grid.querySelectorAll('.action-edit-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      const idx = parseInt(this.dataset.idx);
      const action = DATA.actions[idx];
      if (action) openActionEditPopover(action, idx, this.closest('.action-item-row'));
    });
  });
}

// ============================================================
// ACTION ITEM EDIT POPOVER (reuses deal edit popover UI)
// ============================================================
const ACTION_EDIT_FIELDS = [
  { key: 'priority', label: 'Priority', type: 'single-select',
    options: ['URGENT', 'HIGH', 'MEDIUM', 'LOW'],
    chipClass: k => k === 'URGENT' ? 'chip-high' : k === 'HIGH' ? 'chip-medium' : k === 'MEDIUM' ? 'chip-sent' : 'chip-low' },
  { key: 'action', label: 'Action Item', type: 'textarea' },
  { key: 'facility', label: 'Facility', type: 'search-select',
    optionsFn: () => DATA.pipeline.map(d => d.name).sort() },
  { key: 'owner', label: 'Owner', type: 'text' },
  { key: 'deadline', label: 'Deadline', type: 'date' },
  { key: 'status', label: 'Status', type: 'single-select',
    options: ['Overdue', 'Pending', 'Not Started', 'Waiting', 'Scheduled', 'Planning', 'Stalled'],
    chipClass: k => k === 'Overdue' ? 'chip-high' : k === 'Scheduled' ? 'chip-signed' : k === 'Planning' ? 'chip-loi' : k === 'Stalled' ? 'chip-low' : '' },
  { key: 'notes', label: 'Notes', type: 'textarea' },
];

let editingAction = null;
let editingActionIdx = null;
let editActionFormValues = {};

function openActionEditPopover(action, idx, rowEl) {
  editingAction = action;
  editingActionIdx = idx;
  editActionFormValues = {};

  document.getElementById('dealEditTitle').textContent = 'Edit Action Item';

  const container = document.getElementById('dealEditFields');
  container.innerHTML = ACTION_EDIT_FIELDS.map(field => {
    const currentVal = action[field.key] || '';
    editActionFormValues[field.key] = currentVal;

    if (field.type === 'single-select') {
      const chips = field.options.map(opt => {
        const isSelected = currentVal === opt;
        const cls = field.chipClass ? field.chipClass(opt) : '';
        return `<button class="deal-edit-chip ${cls} ${isSelected ? 'selected' : ''}" data-field="${field.key}" data-value="${opt}">${opt}</button>`;
      }).join('');
      return `<div class="deal-edit-field"><div class="deal-edit-label">${field.label}</div><div class="deal-edit-chips" data-field="${field.key}" data-mode="single">${chips}</div></div>`;
    }

    if (field.type === 'textarea') {
      return `<div class="deal-edit-field"><div class="deal-edit-label">${field.label}</div><textarea class="deal-edit-input deal-edit-textarea" data-field="${field.key}">${currentVal}</textarea></div>`;
    }

    if (field.type === 'search-select') {
      const fieldId = `search-select-${field.key}`;
      return `<div class="deal-edit-field"><div class="deal-edit-label">${field.label}</div>
        <div class="search-select-wrapper" data-field="${field.key}">
          <input class="deal-edit-input search-select-input" type="text" data-field="${field.key}" id="${fieldId}"
            value="${currentVal.replace(/"/g, '&quot;')}" placeholder="Search pipeline deals..." autocomplete="off">
          <div class="search-select-dropdown" id="${fieldId}-dropdown"></div>
        </div></div>`;
    }

    if (field.type === 'date') {
      const dateVal = toDateInputValue(currentVal);
      return `<div class="deal-edit-field"><div class="deal-edit-label">${field.label}</div><input class="deal-edit-input deal-edit-date" type="date" data-field="${field.key}" value="${dateVal}"></div>`;
    }

    return `<div class="deal-edit-field"><div class="deal-edit-label">${field.label}</div><input class="deal-edit-input" type="text" data-field="${field.key}" value="${currentVal.replace(/"/g, '&quot;')}"></div>`;
  }).join('');

  // Wire chips
  container.querySelectorAll('.deal-edit-chip').forEach(chip => {
    chip.addEventListener('click', function() {
      const fieldKey = this.dataset.field;
      this.closest('.deal-edit-chips').querySelectorAll('.deal-edit-chip').forEach(c => c.classList.remove('selected'));
      this.classList.add('selected');
      editActionFormValues[fieldKey] = this.dataset.value;
    });
  });

  // Wire date inputs — convert back to display format on change
  container.querySelectorAll('.deal-edit-date').forEach(input => {
    input.addEventListener('change', function() {
      editActionFormValues[this.dataset.field] = fromDateInputValue(this.value);
    });
  });

  // Wire text inputs (exclude search-select and date inputs - they have their own handlers)
  container.querySelectorAll('.deal-edit-input:not(.search-select-input):not(.deal-edit-date)').forEach(input => {
    input.addEventListener('input', function() {
      editActionFormValues[this.dataset.field] = this.value;
    });
  });

  // Wire search-select inputs
  container.querySelectorAll('.search-select-input').forEach(input => {
    const fieldKey = input.dataset.field;
    const dropdown = input.nextElementSibling;
    const fieldDef = ACTION_EDIT_FIELDS.find(f => f.key === fieldKey);
    const allOptions = fieldDef && fieldDef.optionsFn ? fieldDef.optionsFn() : [];

    function highlightMatch(text, query) {
      if (!query) return text;
      const idx = text.toLowerCase().indexOf(query);
      if (idx === -1) return text;
      return text.substring(0, idx) + '<strong>' + text.substring(idx, idx + query.length) + '</strong>' + text.substring(idx + query.length);
    }

    function showDropdown(filter) {
      const query = (filter || '').toLowerCase();
      const matches = query ? allOptions.filter(opt => opt.toLowerCase().includes(query)) : allOptions;
      if (matches.length === 0) {
        dropdown.innerHTML = '<div class="search-select-no-results">No matching deals</div>';
      } else {
        dropdown.innerHTML = matches.map(opt =>
          `<div class="search-select-option" data-value="${opt.replace(/"/g, '&quot;')}">${highlightMatch(opt, query)}</div>`
        ).join('');
      }
      dropdown.classList.add('visible');
    }

    function hideDropdown() {
      setTimeout(() => dropdown.classList.remove('visible'), 150);
    }

    input.addEventListener('focus', () => showDropdown(input.value));
    input.addEventListener('input', function() {
      editActionFormValues[fieldKey] = this.value;
      showDropdown(this.value);
    });
    input.addEventListener('blur', hideDropdown);

    dropdown.addEventListener('mousedown', function(e) {
      const option = e.target.closest('.search-select-option');
      if (option) {
        const val = option.dataset.value;
        input.value = val;
        editActionFormValues[fieldKey] = val;
        dropdown.classList.remove('visible');
      }
    });
  });

  // Swap save handler temporarily
  const saveBtn = document.getElementById('dealEditSave');
  const newSave = saveBtn.cloneNode(true);
  saveBtn.parentNode.replaceChild(newSave, saveBtn);
  newSave.addEventListener('click', saveActionEdits);

  positionPopover(rowEl);
  document.getElementById('dealEditPopover').classList.add('open');
  document.getElementById('dealEditBackdrop').classList.add('open');
}

async function saveActionEdits() {
  if (editingAction === null) return;

  const saveBtn = document.getElementById('dealEditSave');
  saveBtn.disabled = true;
  saveBtn.textContent = 'Saving...';

  const changes = {};
  ACTION_EDIT_FIELDS.forEach(field => {
    const newVal = editActionFormValues[field.key];
    if (newVal !== undefined && newVal !== (editingAction[field.key] || '')) {
      changes[field.key] = newVal;
    }
  });

  if (Object.keys(changes).length === 0) {
    showToast('No changes to save', 'pending');
    saveBtn.disabled = false;
    saveBtn.textContent = 'Save Changes';
    closeDealEditPopover();
    editingAction = null;
    editingActionIdx = null;
    return;
  }

  // Apply in memory
  Object.assign(editingAction, changes);

  // Write to Google Sheet action items tab
  writeActionFieldsToSheet(editingAction, changes);

  showToast(`Updated action item`, 'success');
  saveBtn.disabled = false;
  saveBtn.textContent = 'Save Changes';
  closeDealEditPopover();
  editingAction = null;
  editingActionIdx = null;
  renderActionItems();
  refreshPipelineCardActions();
}

function openCreateActionPopover(prefillFacility, anchorEl) {
  editingAction = null;
  editingActionIdx = null;
  editActionFormValues = {};

  document.getElementById('dealEditTitle').textContent = 'New Action Item';

  const container = document.getElementById('dealEditFields');
  container.innerHTML = ACTION_EDIT_FIELDS.map(field => {
    const currentVal = field.key === 'facility' && prefillFacility ? prefillFacility
      : field.key === 'priority' ? 'MEDIUM'
      : field.key === 'status' ? 'Not Started' : '';
    editActionFormValues[field.key] = currentVal;

    if (field.type === 'single-select') {
      const chips = field.options.map(opt => {
        const isSelected = currentVal === opt;
        const cls = field.chipClass ? field.chipClass(opt) : '';
        return `<button class="deal-edit-chip ${cls} ${isSelected ? 'selected' : ''}" data-field="${field.key}" data-value="${opt}">${opt}</button>`;
      }).join('');
      return `<div class="deal-edit-field"><div class="deal-edit-label">${field.label}</div><div class="deal-edit-chips" data-field="${field.key}" data-mode="single">${chips}</div></div>`;
    }

    if (field.type === 'textarea') {
      return `<div class="deal-edit-field"><div class="deal-edit-label">${field.label}</div><textarea class="deal-edit-input deal-edit-textarea" data-field="${field.key}">${currentVal}</textarea></div>`;
    }

    if (field.type === 'search-select') {
      const fieldId = `search-select-${field.key}`;
      return `<div class="deal-edit-field"><div class="deal-edit-label">${field.label}</div>
        <div class="search-select-wrapper" data-field="${field.key}">
          <input class="deal-edit-input search-select-input" type="text" data-field="${field.key}" id="${fieldId}"
            value="${currentVal.replace(/"/g, '&quot;')}" placeholder="Search pipeline deals..." autocomplete="off">
          <div class="search-select-dropdown" id="${fieldId}-dropdown"></div>
        </div></div>`;
    }

    if (field.type === 'date') {
      const dateVal = toDateInputValue(currentVal);
      return `<div class="deal-edit-field"><div class="deal-edit-label">${field.label}</div><input class="deal-edit-input deal-edit-date" type="date" data-field="${field.key}" value="${dateVal}"></div>`;
    }

    return `<div class="deal-edit-field"><div class="deal-edit-label">${field.label}</div><input class="deal-edit-input" type="text" data-field="${field.key}" value="${currentVal.replace(/"/g, '&quot;')}"></div>`;
  }).join('');

  // Wire chips
  container.querySelectorAll('.deal-edit-chip').forEach(chip => {
    chip.addEventListener('click', function() {
      const fieldKey = this.dataset.field;
      this.closest('.deal-edit-chips').querySelectorAll('.deal-edit-chip').forEach(c => c.classList.remove('selected'));
      this.classList.add('selected');
      editActionFormValues[fieldKey] = this.dataset.value;
    });
  });

  // Wire date inputs
  container.querySelectorAll('.deal-edit-date').forEach(input => {
    input.addEventListener('change', function() {
      editActionFormValues[this.dataset.field] = fromDateInputValue(this.value);
    });
  });

  // Wire text inputs (exclude search-select and date)
  container.querySelectorAll('.deal-edit-input:not(.search-select-input):not(.deal-edit-date)').forEach(input => {
    input.addEventListener('input', function() {
      editActionFormValues[this.dataset.field] = this.value;
    });
  });

  // Wire search-select inputs
  container.querySelectorAll('.search-select-input').forEach(input => {
    const fieldKey = input.dataset.field;
    const dropdown = input.nextElementSibling;
    const fieldDef = ACTION_EDIT_FIELDS.find(f => f.key === fieldKey);
    const allOptions = fieldDef && fieldDef.optionsFn ? fieldDef.optionsFn() : [];

    function highlightMatch(text, query) {
      if (!query) return text;
      const idx = text.toLowerCase().indexOf(query);
      if (idx === -1) return text;
      return text.substring(0, idx) + '<strong>' + text.substring(idx, idx + query.length) + '</strong>' + text.substring(idx + query.length);
    }

    function showDropdown(filter) {
      const query = (filter || '').toLowerCase();
      const matches = query ? allOptions.filter(opt => opt.toLowerCase().includes(query)) : allOptions;
      if (matches.length === 0) {
        dropdown.innerHTML = '<div class="search-select-no-results">No matching deals</div>';
      } else {
        dropdown.innerHTML = matches.map(opt =>
          `<div class="search-select-option" data-value="${opt.replace(/"/g, '&quot;')}">${highlightMatch(opt, query)}</div>`
        ).join('');
      }
      dropdown.classList.add('visible');
    }

    function hideDropdown() { setTimeout(() => dropdown.classList.remove('visible'), 150); }

    input.addEventListener('focus', () => showDropdown(input.value));
    input.addEventListener('input', function() {
      editActionFormValues[fieldKey] = this.value;
      showDropdown(this.value);
    });
    input.addEventListener('blur', hideDropdown);

    dropdown.addEventListener('mousedown', function(e) {
      const option = e.target.closest('.search-select-option');
      if (option) {
        const val = option.dataset.value;
        input.value = val;
        editActionFormValues[fieldKey] = val;
        dropdown.classList.remove('visible');
      }
    });
  });

  // Swap save handler to saveNewAction
  const saveBtn = document.getElementById('dealEditSave');
  const newSave = saveBtn.cloneNode(true);
  saveBtn.parentNode.replaceChild(newSave, saveBtn);
  newSave.textContent = 'Create Action';
  newSave.addEventListener('click', saveNewAction);

  const anchor = anchorEl || document.getElementById('actionNewBtn');
  positionPopover(anchor);
  document.getElementById('dealEditPopover').classList.add('open');
  document.getElementById('dealEditBackdrop').classList.add('open');
}

async function saveNewAction() {
  const saveBtn = document.getElementById('dealEditSave');
  saveBtn.disabled = true;
  saveBtn.textContent = 'Creating...';

  // Require at least an action description
  if (!editActionFormValues.action || !editActionFormValues.action.trim()) {
    showToast('Action item description is required', 'pending');
    saveBtn.disabled = false;
    saveBtn.textContent = 'Create Action';
    return;
  }

  // Build new action object
  const newAction = {};
  ACTION_EDIT_FIELDS.forEach(field => {
    newAction[field.key] = editActionFormValues[field.key] || '';
  });

  // Add to in-memory data
  DATA.actions.push(newAction);

  // Write to Google Sheet
  writeNewActionToSheet(newAction);

  showToast('Action item created', 'success');
  saveBtn.disabled = false;
  saveBtn.textContent = 'Create Action';
  closeDealEditPopover();
  editingAction = null;
  editingActionIdx = null;
  renderActionItems();
  refreshPipelineCardActions();
}

async function writeNewActionToSheet(action) {
  if (!APPS_SCRIPT_URL) return;
  try {
    await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ newAction: action })
    });
  } catch (err) {
    console.warn('New action write-back error:', err.message);
  }
}

async function writeActionFieldsToSheet(action, changes) {
  if (!APPS_SCRIPT_URL) return;
  try {
    await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ actionItem: action.action, actionFields: changes })
    });
  } catch (err) {
    console.warn('Action write-back error:', err.message);
  }
}

async function writeActionDoneToSheet(action, isDone) {
  if (!APPS_SCRIPT_URL || !action) return;
  try {
    await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ actionDone: action.action, done: isDone })
    });
  } catch (err) {
    console.warn('Action done write-back error:', err.message);
  }
}

// ============================================================
// GOOGLE SHEETS LIVE FETCH (Pipeline + Action Items)
// ============================================================
const GSHEET_ID = '19w2nLn7VrNEWQSRaEIgPQuZwPi88ABNKWnl8Bh7pqVk';
const PIPELINE_GID = '1109153656';
const ACTIONS_GID = '2003109190';

function parseCSV(text) {
  const rows = [];
  let current = '', inQuote = false, row = [];
  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    if (inQuote) {
      if (ch === '"') {
        if (i + 1 < text.length && text[i + 1] === '"') { current += '"'; i++; }
        else inQuote = false;
      } else current += ch;
    } else {
      if (ch === '"') inQuote = true;
      else if (ch === ',') { row.push(current.trim()); current = ''; }
      else if (ch === '\n' || (ch === '\r' && text[i + 1] === '\n')) {
        if (ch === '\r') i++;
        row.push(current.trim()); current = '';
        if (row.some(c => c)) rows.push(row);
        row = [];
      } else current += ch;
    }
  }
  row.push(current.trim());
  if (row.some(c => c)) rows.push(row);
  return rows;
}

async function fetchGoogleSheetCSV(gid) {
  const url = `https://docs.google.com/spreadsheets/d/${GSHEET_ID}/export?format=csv&gid=${gid}`;
  const resp = await fetch(url);
  if (!resp.ok) throw new Error(`Sheet fetch failed: ${resp.status}`);
  return await resp.text();
}

function parsePipelineCSV(csvText) {
  const rows = parseCSV(csvText);
  // Find header row containing "Facility Name"
  let headerIdx = -1;
  for (let i = 0; i < Math.min(rows.length, 10); i++) {
    if (rows[i].some(c => c === 'Facility Name')) { headerIdx = i; break; }
  }
  if (headerIdx < 0) throw new Error('Pipeline header not found');
  const headers = rows[headerIdx];
  const colIdx = {};
  headers.forEach((h, i) => { colIdx[h] = i; });
  const g = (row, key) => (row[colIdx[key]] || '').trim();
  const deals = [];
  for (let r = headerIdx + 1; r < rows.length; r++) {
    const row = rows[r];
    const name = g(row, 'Facility Name');
    if (!name) continue;
    deals.push({
      name, status: g(row, 'Status'), type: g(row, 'Type'),
      priority: g(row, 'Priority'), states: g(row, 'State(s)'),
      ebitda: g(row, 'EBITDA / Financials'), askingPrice: g(row, 'Asking Price'),
      ndaStatus: g(row, 'NDA Status'), dataRoom: g(row, 'Data Room'),
      siteVisit: g(row, 'Site Visit'), keyContact: g(row, 'Key Contact'),
      nextAction: g(row, 'Next Action'), actionOwner: g(row, 'Action Owner'),
      deadline: g(row, 'Deadline'), lastUpdate: g(row, 'Last Update'),
      daysSinceUpdate: g(row, 'Days Since Update'), notes: g(row, 'Notes'),
      dealNumber: g(row, '#'),
    });
  }
  return deals;
}

function parseActionsCSV(csvText) {
  const rows = parseCSV(csvText);
  let headerIdx = -1;
  for (let i = 0; i < Math.min(rows.length, 10); i++) {
    if (rows[i].some(c => c === 'Action Item') && rows[i].some(c => c === 'Priority')) {
      headerIdx = i; break;
    }
  }
  if (headerIdx < 0) throw new Error('Actions header not found');
  const headers = rows[headerIdx];
  const colIdx = {};
  headers.forEach((h, i) => { colIdx[h] = i; });
  const g = (row, key) => (row[colIdx[key]] || '').trim();
  const items = [];
  for (let r = headerIdx + 1; r < rows.length; r++) {
    const row = rows[r];
    const action = g(row, 'Action Item');
    if (!action) continue;
    items.push({
      priority: g(row, 'Priority'), action,
      facility: g(row, 'Facility'), owner: g(row, 'Owner'),
      deadline: g(row, 'Deadline'), status: g(row, 'Status'),
      notes: g(row, 'Notes'), pipelineStatus: g(row, 'Pipeline Status'),
    });
  }
  return items;
}

// ============================================================
// DRAG-AND-DROP + GOOGLE SHEETS WRITEBACK
// ============================================================
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz66k7t5J6zyHlllDgohhLig9WICX0KWf8oHNt8pqAz7Hse247geqHMlfJzZLQ-kGR0/exec';

function initSortable() {
  document.querySelectorAll('.pipeline-col-cards').forEach(container => {
    new Sortable(container, {
      group: 'pipeline',
      animation: 200,
      ghostClass: 'sortable-ghost',
      chosenClass: 'sortable-chosen',
      dragClass: 'sortable-drag',
      filter: '.pipeline-card-edit-btn',
      preventOnFilter: false,
      easing: 'cubic-bezier(0.22, 1, 0.36, 1)',
      onEnd: function (evt) {
        isDragging = Date.now();

        const card = evt.item;
        const dealName = card.getAttribute('data-deal-name');
        const targetCol = evt.to.getAttribute('data-status');
        const sourceCol = evt.from.getAttribute('data-status');

        if (targetCol === sourceCol) return;

        // Check if this is a multi-card move (only if all selected are in same column)
        if (selectedCards.has(dealName) && selectedCards.size > 1 && selectedColumn === sourceCol) {
          const targetContainer = evt.to;
          let moveCount = 0;

          selectedCards.forEach(selectedDealName => {
            let cardEl, origStatus;
            if (selectedDealName === dealName) {
              cardEl = card;
              origStatus = card.getAttribute('data-original-status');
            } else {
              cardEl = document.querySelector(`.pipeline-card[data-deal-name="${CSS.escape(selectedDealName)}"]`);
              if (!cardEl) return;
              origStatus = cardEl.getAttribute('data-original-status');
              targetContainer.appendChild(cardEl);
            }
            const newSt = resolveNewStatus(targetCol, origStatus);
            cardEl.setAttribute('data-original-status', newSt);
            const deal = DATA.pipeline.find(d => d.name === selectedDealName);
            if (deal) deal.status = newSt;
            writeStatusToSheet(selectedDealName, newSt);
            moveCount++;
          });

          showToast(`Moved ${moveCount} deals → ${targetCol}`, 'success');
          clearCardSelection();
          updateMapHighlights();
        } else {
          // Single card drag
          const originalStatus = card.getAttribute('data-original-status');
          const newStatus = resolveNewStatus(targetCol, originalStatus);
          card.setAttribute('data-original-status', newStatus);
          const deal = DATA.pipeline.find(d => d.name === dealName);
          if (deal) deal.status = newStatus;
          writeStatusToSheet(dealName, newStatus);
        }

        updateColumnCounts();
      }
    });
  });
}

// ============================================================
// CARD SELECTION + MAP HIGHLIGHTING
// ============================================================
function initCardSelection() {
  document.querySelectorAll('.pipeline-card').forEach(card => {
    card.addEventListener('click', function(e) {
      // Skip if a drag just ended (within 200ms)
      if (typeof isDragging === 'number' && Date.now() - isDragging < 200) return;

      const dealName = card.getAttribute('data-deal-name');
      const cardColumn = card.closest('.pipeline-col-cards').getAttribute('data-status');

      // Toggle this card (allow cross-column selection for map viewing)
      if (selectedCards.has(dealName)) {
        selectedCards.delete(dealName);
        card.classList.remove('selected');
        if (selectedCards.size === 0) selectedColumn = null;
        else recalcSelectedColumn();
      } else {
        selectedCards.add(dealName);
        card.classList.add('selected');
        recalcSelectedColumn();
      }

      updateMapHighlights();
    });
  });
}

// Determine if all selected cards are in the same column (enables drag-move)
function recalcSelectedColumn() {
  const cols = new Set();
  document.querySelectorAll('.pipeline-card.selected').forEach(c => {
    cols.add(c.closest('.pipeline-col-cards').getAttribute('data-status'));
  });
  selectedColumn = cols.size === 1 ? [...cols][0] : null;
}

function clearCardSelection() {
  selectedCards.clear();
  selectedColumn = null;
  document.querySelectorAll('.pipeline-card.selected').forEach(c => c.classList.remove('selected'));
  // Restore all marker opacity
  if (markersLayer) markersLayer.eachLayer(m => {
    const el = m.getElement();
    if (el) el.style.opacity = '1';
  });
}

// Pipeline deal name → company name aliases (mirrors fetch_airtable.py)
const DEAL_NAME_ALIASES = {
  'nola detox & recovery center': 'nola detox',
  'second chances': 'second chances addiction recovery center',
  'serenity treatment centers': 'serenity treatment center',
  'sanctuary': 'sanctuary louisiana',
  'asheville detox (healthcare alliance)': 'asheville detox center',
  'recovery now / longbranch': 'longbranch healthcare',
  'dreamlife / crestview': 'dreamlife recovery pa',
  'new waters': 'new waters recovery',
  'the grove recovery': 'the grove recovery centers',
  'sycamour': 'sycamore behavioral health',
  'new vista / ethan crossing': 'ethan crossing addiction treatment',
  'southeast detox / addiction ctr': 'southeast detox',
  'cardinal': 'cardinal recovery',
  'ghr': 'ghr center for addiction recovery and treatment',
  'peachtree detox (evoraa)': 'peachtree detox',
  'revive recover': 'gateway to sobriety (revive recover)',
  'southern sky': 'southern sky recovery',
  'the wave': 'the wave international',
  'woodlake center': 'woodlake addiction recovery',
  'the sylvia brafman mh center': 'the sylvia brafman mental health center',
  'turning leaf behavioral health': 'turning leaf behavioral health services',
  'centric': 'reign residential treatment center',
};

function findCompanyForDeal(dealName) {
  const dn = dealName.toLowerCase().trim();

  // 1. Check alias table first (most reliable)
  const aliased = DEAL_NAME_ALIASES[dn];
  if (aliased) {
    const m = DATA.companies.find(c => c.name && c.lat && c.lng && c.name.toLowerCase() === aliased);
    if (m) return m;
  }

  // 2. Exact match
  let match = DATA.companies.find(c => c.name && c.lat && c.lng && c.name.toLowerCase() === dn);
  if (match) return match;

  // 3. Starts-with (either direction)
  match = DATA.companies.find(c => c.name && c.lat && c.lng && (c.name.toLowerCase().startsWith(dn) || dn.startsWith(c.name.toLowerCase())));
  if (match) return match;

  // 4. Contains (either direction)
  match = DATA.companies.find(c => c.name && c.lat && c.lng && (c.name.toLowerCase().includes(dn) || dn.includes(c.name.toLowerCase())));
  if (match) return match;

  // 5. First two words match
  const dealWords = dn.split(/\s+/).slice(0, 2).join(' ');
  if (dealWords.length > 3) {
    match = DATA.companies.find(c => c.name && c.lat && c.lng && c.name.toLowerCase().startsWith(dealWords));
    if (match) return match;
  }

  // 6. Slash-split: try each part
  if (dn.includes('/')) {
    for (const part of dn.split('/')) {
      const p = part.trim();
      if (p.length < 3) continue;
      match = DATA.companies.find(c => c.name && c.lat && c.lng && (c.name.toLowerCase().includes(p) || p.includes(c.name.toLowerCase())));
      if (match) return match;
    }
  }

  return null;
}

function updateMapHighlights() {
  if (highlightLayer) highlightLayer.clearLayers();

  // Clear KPI highlight when pipeline cards are being used
  if (selectedCards.size > 0 && activeKPI) {
    activeKPI = null;
    document.querySelectorAll('.kpi-card[data-kpi]').forEach(c => c.classList.remove('selected','dimmed'));
  }

  // If nothing selected, restore all markers to full opacity (respecting KPI highlight)
  if (selectedCards.size === 0) {
    markersLayer.eachLayer(m => {
      const el = m.getElement();
      if (el) el.style.opacity = '1';
    });
    return;
  }

  // Collect airtableIds from selected card DOM elements
  const selectedAirtableIds = new Set();
  const selectedDealNames = new Set();
  document.querySelectorAll('.pipeline-card.selected').forEach(card => {
    const aid = card.getAttribute('data-airtable-id');
    if (aid) selectedAirtableIds.add(aid);
    selectedDealNames.add(card.getAttribute('data-deal-name'));
  });

  // Find matching companies
  const matchedIds = new Set();
  const bounds = [];

  // Match by airtableId first (reliable), then fuzzy name fallback
  selectedDealNames.forEach(dealName => {
    let company = null;

    // Try airtableId from the card
    const cardEl = document.querySelector(`.pipeline-card.selected[data-deal-name="${CSS.escape(dealName)}"]`);
    const aid = cardEl ? cardEl.getAttribute('data-airtable-id') : '';
    if (aid) {
      company = DATA.companies.find(c => c.airtableId === aid && c.lat && c.lng);
    }

    // Fallback to fuzzy name matching
    if (!company) {
      company = findCompanyForDeal(dealName);
    }

    if (!company || !company.lat || !company.lng) return;

    matchedIds.add(company.airtableId || company.name);
    const color = OWNERSHIP_COLORS[company.ownership] || '#06b6d4';

    const highlightIcon = L.divIcon({
      className: 'highlight-marker',
      html: `<div style="
        width:22px;height:22px;border:2px solid ${color};border-radius:50%;
        box-shadow:0 0 12px ${color}88, 0 0 24px ${color}33;
        background:${color}11;
      "></div>`,
      iconSize: [22, 22], iconAnchor: [11, 11]
    });

    const hlMarker = L.marker([company.lat, company.lng], { icon: highlightIcon }).addTo(highlightLayer);
    hlMarker.bindTooltip(company.name, {
      permanent: true, direction: 'top', offset: [0, -16],
      className: 'highlight-tooltip'
    });

    bounds.push([company.lat, company.lng]);
  });

  // Dim all non-matched markers, brighten matched ones
  markersLayer.eachLayer(m => {
    const el = m.getElement();
    if (!el) return;
    const isMatch = (m._airtableId && matchedIds.has(m._airtableId)) || matchedIds.has(m._companyName);
    el.style.opacity = isMatch ? '1' : '0.12';
  });

  if (bounds.length > 0) {
    if (bounds.length === 1) {
      map.setView(bounds[0], 8, { animate: true, duration: 0.5 });
    } else {
      map.fitBounds(bounds, { padding: [60, 60], maxZoom: 10, animate: true, duration: 0.5 });
    }
  }
}

function resolveNewStatus(targetColKey, originalStatus) {
  const statusMap = {
    'Active': 'Active', 'New Lead': 'New Lead', 'Stand By': 'Stand By',
    'Stalled': 'Stalled', 'Due Diligence': 'Due Diligence'
  };
  return statusMap[targetColKey] || targetColKey;
}

function updateColumnCounts() {
  const pipe = DATA.pipeline;
  document.querySelectorAll('.pipeline-col').forEach(col => {
    const cardsInCol = col.querySelectorAll('.pipeline-col-cards .pipeline-card').length;
    const countEl = col.querySelector('.pipeline-col-count');
    if (countEl) countEl.textContent = cardsInCol;
  });

  const active = pipe.filter(p => p.status.startsWith('Active')).length;
  const standby = pipe.filter(p => p.status === 'Stand By').length;
  const stalled = pipe.filter(p => p.status === 'Stalled').length;
  const newLeads = pipe.filter(p => p.status === 'New Lead').length;

  document.getElementById('pipelineStats').innerHTML = `
    <div class="pipeline-stat"><strong>${pipe.length}</strong> Total Deals</div>
    <div class="pipeline-stat"><strong>${active}</strong> Active</div>
    <div class="pipeline-stat"><strong>${standby}</strong> Stand By</div>
    <div class="pipeline-stat"><strong>${newLeads}</strong> New Leads</div>
    <div class="pipeline-stat"><strong>${stalled}</strong> Stalled</div>
  `;
}

async function writeStatusToSheet(dealName, newStatus) {
  if (!APPS_SCRIPT_URL) {
    showToast('⚙️ Apps Script URL not configured — drag saved locally only', 'pending');
    return;
  }

  showToast(`Updating "${dealName}" → ${newStatus}...`, 'pending');

  try {
    const resp = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ dealName, newStatus })
    });
    const result = await resp.json();
    if (result.success) {
      showToast(`✅ "${dealName}" moved to ${newStatus}`, 'success');
    } else {
      showToast(`❌ Failed: ${result.error || 'Unknown error'}`, 'error');
    }
  } catch (err) {
    showToast(`❌ Network error: ${err.message}`, 'error');
  }
}

function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = 'toast show ' + type;
  clearTimeout(toast._timeout);
  toast._timeout = setTimeout(() => { toast.className = 'toast'; }, 4000);
}

// ============================================================
// DEAL EDIT POPOVER
// ============================================================
const DEAL_EDIT_FIELDS = [
  { key: 'status', label: 'Status', type: 'single-select',
    options: ['Active', 'New Lead', 'Stand By', 'Stalled', 'Due Diligence'],
    chipClass: k => 'chip-' + k.toLowerCase().replace(/\s+/g, '-') },
  { key: 'priority', label: 'Priority', type: 'single-select',
    options: ['1 - High', '2 - Medium', '3 - Low'],
    chipClass: k => k.includes('High') ? 'chip-high' : k.includes('Medium') ? 'chip-medium' : 'chip-low' },
  { key: 'type', label: 'Type', type: 'text' },
  { key: 'states', label: 'States', type: 'text' },
  { key: 'keyContact', label: 'Key Contact', type: 'text' },
  { key: 'ebitda', label: 'EBITDA / Financials', type: 'text' },
  { key: 'askingPrice', label: 'Asking Price', type: 'text' },
  { key: 'ndaStatus', label: 'NDA Status', type: 'single-select',
    options: ['Signed', 'Sent', 'LOI', 'N/A'],
    chipClass: k => k === 'Signed' ? 'chip-signed' : k === 'Sent' ? 'chip-sent' : k === 'LOI' ? 'chip-loi' : '' },
  { key: 'dataRoom', label: 'Data Room', type: 'text' },
  { key: 'siteVisit', label: 'Site Visit', type: 'text' },
  { key: 'nextAction', label: 'Action Items', type: 'linked-actions' },
  { key: 'actionOwner', label: 'Action Owner', type: 'multi-select',
    optionsFn: () => {
      const owners = new Set();
      DATA.pipeline.forEach(d => {
        if (d.actionOwner) d.actionOwner.split(/[\/,&]+/).map(s => s.trim()).filter(Boolean).forEach(o => owners.add(o));
      });
      return [...owners].sort();
    },
    chipClass: () => '' },
  { key: 'deadline', label: 'Deadline', type: 'date' },
  { key: 'notes', label: 'Notes', type: 'textarea' },
];

let editingDeal = null;
let editingCardEl = null;
let editFormValues = {};

function openDealEditPopover(dealName, cardElement) {
  const deal = DATA.pipeline.find(d => d.name === dealName);
  if (!deal) return;

  editingDeal = deal;
  editingCardEl = cardElement;
  editFormValues = {};

  document.getElementById('dealEditTitle').textContent = deal.name;

  const container = document.getElementById('dealEditFields');
  container.innerHTML = DEAL_EDIT_FIELDS.map(field => {
    const currentVal = deal[field.key] || '';
    editFormValues[field.key] = currentVal;

    if (field.type === 'single-select') {
      const chips = field.options.map(opt => {
        const isSelected = currentVal === opt;
        const cls = field.chipClass ? field.chipClass(opt) : '';
        return `<button class="deal-edit-chip ${cls} ${isSelected ? 'selected' : ''}" data-field="${field.key}" data-value="${opt}">${opt}</button>`;
      }).join('');
      return `<div class="deal-edit-field"><div class="deal-edit-label">${field.label}</div><div class="deal-edit-chips" data-field="${field.key}" data-mode="single">${chips}</div></div>`;
    }

    if (field.type === 'multi-select') {
      const options = field.optionsFn ? field.optionsFn() : (field.options || []);
      const currentParts = currentVal.split(/[\/,&]+/).map(s => s.trim()).filter(Boolean);
      const chips = options.map(opt => {
        const isSelected = currentParts.some(p => p.toLowerCase() === opt.toLowerCase());
        const cls = field.chipClass ? field.chipClass(opt) : '';
        return `<button class="deal-edit-chip ${cls} ${isSelected ? 'selected' : ''}" data-field="${field.key}" data-value="${opt}">${opt}</button>`;
      }).join('');
      return `<div class="deal-edit-field"><div class="deal-edit-label">${field.label} <span style="font-weight:400;opacity:0.5">(multi)</span></div><div class="deal-edit-chips" data-field="${field.key}" data-mode="multi">${chips}</div></div>`;
    }

    if (field.type === 'textarea') {
      return `<div class="deal-edit-field"><div class="deal-edit-label">${field.label}</div><textarea class="deal-edit-input deal-edit-textarea" data-field="${field.key}">${currentVal}</textarea></div>`;
    }

    if (field.type === 'linked-actions') {
      const actions = getAllActionsForDeal(deal.name);
      let html = `<div class="deal-edit-field"><div class="deal-edit-label">${field.label} <span style="font-weight:400;opacity:0.5">(${actions.filter(a => !actionDoneSet.has(a._idx)).length} pending)</span></div>`;
      if (actions.length > 0) {
        html += '<div class="linked-actions-list" id="linkedActionsList">';
        html += actions.map(a => {
          const isDone = actionDoneSet.has(a._idx);
          const pCls = (a.priority || '').toLowerCase();
          return `<div class="linked-action-item ${isDone ? 'is-done' : ''}" data-action-idx="${a._idx}">
            <button class="linked-action-done-btn ${isDone ? 'checked' : ''}" data-idx="${a._idx}" title="${isDone ? 'Mark undone' : 'Mark done'}">&#10003;</button>
            <span class="linked-action-priority ${pCls}">${a.priority || '—'}</span>
            <div class="linked-action-body">
              <div class="linked-action-text">${a.action}</div>
              <div class="linked-action-meta">${a.owner || ''}${a.deadline ? ' · ' + a.deadline : ''}${a.status ? ' · ' + a.status : ''}</div>
            </div>
            <button class="linked-action-edit-btn" data-idx="${a._idx}" title="Edit action item">&#8942;</button>
          </div>`;
        }).join('');
        html += '</div>';
      } else {
        html += '<div class="linked-actions-empty">No action items linked to this deal</div>';
      }
      html += `<button class="action-new-btn linked-action-new-btn" id="linkedActionNewBtn" style="margin-top:8px;width:100%">+ New Action Item</button>`;
      html += '</div>';
      return html;
    }

    if (field.type === 'date') {
      const dateVal = toDateInputValue(currentVal);
      return `<div class="deal-edit-field"><div class="deal-edit-label">${field.label}</div><input class="deal-edit-input deal-edit-date" type="date" data-field="${field.key}" value="${dateVal}"></div>`;
    }

    return `<div class="deal-edit-field"><div class="deal-edit-label">${field.label}</div><input class="deal-edit-input" type="text" data-field="${field.key}" value="${currentVal.replace(/"/g, '&quot;')}"></div>`;
  }).join('');

  // Wire chip click handlers
  container.querySelectorAll('.deal-edit-chip').forEach(chip => {
    chip.addEventListener('click', function() {
      const fieldKey = this.dataset.field;
      const value = this.dataset.value;
      const chipsContainer = this.closest('.deal-edit-chips');
      const mode = chipsContainer.dataset.mode;

      if (mode === 'multi') {
        this.classList.toggle('selected');
        const selected = [...chipsContainer.querySelectorAll('.deal-edit-chip.selected')].map(c => c.dataset.value);
        editFormValues[fieldKey] = selected.join(' / ');
      } else {
        chipsContainer.querySelectorAll('.deal-edit-chip').forEach(c => c.classList.remove('selected'));
        this.classList.add('selected');
        editFormValues[fieldKey] = value;
      }
    });
  });

  // Wire date inputs
  container.querySelectorAll('.deal-edit-date').forEach(input => {
    input.addEventListener('change', function() {
      editFormValues[this.dataset.field] = fromDateInputValue(this.value);
    });
  });

  // Wire text input handlers (exclude date inputs)
  container.querySelectorAll('.deal-edit-input:not(.deal-edit-date)').forEach(input => {
    input.addEventListener('input', function() {
      editFormValues[this.dataset.field] = this.value;
    });
  });

  // Wire linked action item done buttons
  container.querySelectorAll('.linked-action-done-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      const idx = parseInt(this.dataset.idx);
      const item = this.closest('.linked-action-item');
      const isDone = !actionDoneSet.has(idx);
      if (isDone) {
        actionDoneSet.add(idx);
        // Save previous status and set to Done
        if (DATA.actions[idx].status && DATA.actions[idx].status !== 'Done') {
          actionPrevStatusMap.set(idx, DATA.actions[idx].status);
        }
        DATA.actions[idx].status = 'Done';
        this.classList.add('checked');
        item.classList.add('is-done');
      } else {
        actionDoneSet.delete(idx);
        // Restore previous status
        const prevStatus = actionPrevStatusMap.get(idx) || 'Pending';
        DATA.actions[idx].status = prevStatus;
        actionPrevStatusMap.delete(idx);
        this.classList.remove('checked');
        item.classList.remove('is-done');
      }
      try { localStorage.setItem('actionDoneSet', JSON.stringify([...actionDoneSet])); } catch(e) {}
      try { localStorage.setItem('actionPrevStatusMap', JSON.stringify([...actionPrevStatusMap])); } catch(e) {}
      writeActionDoneToSheet(DATA.actions[idx], isDone);
      // Update the pending count label
      const label = container.querySelector('.deal-edit-label span');
      if (label) {
        const actions = getAllActionsForDeal(deal.name);
        label.textContent = `(${actions.filter(a => !actionDoneSet.has(a._idx)).length} pending)`;
      }
    });
  });

  // Wire linked action item edit buttons — open action edit popover
  container.querySelectorAll('.linked-action-edit-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      const idx = parseInt(this.dataset.idx);
      const action = DATA.actions[idx];
      if (!action) return;
      const cardEl = editingCardEl;
      const dealRef = editingDeal;
      closeDealEditPopover();
      setTimeout(() => {
        openActionEditPopover(action, idx, cardEl || document.querySelector(`.pipeline-card[data-deal-name="${dealRef.name}"]`));
      }, 100);
    });
  });

  // Wire "New Action Item" button inside deal popover
  const linkedNewBtn = document.getElementById('linkedActionNewBtn');
  if (linkedNewBtn) {
    linkedNewBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      const dealName = deal.name;
      const cardEl = editingCardEl;
      closeDealEditPopover();
      setTimeout(() => {
        openCreateActionPopover(dealName, cardEl || document.querySelector(`.pipeline-card[data-deal-name="${dealName}"]`));
      }, 100);
    });
  }

  positionPopover(cardElement);
  document.getElementById('dealEditPopover').classList.add('open');
  document.getElementById('dealEditBackdrop').classList.add('open');
}

function positionPopover(cardElement) {
  const popover = document.getElementById('dealEditPopover');
  const rect = cardElement.getBoundingClientRect();
  const popoverWidth = 380;
  const margin = 12;

  let left = rect.right + margin;
  let top = rect.top;

  if (left + popoverWidth > window.innerWidth - 20) {
    left = rect.left - popoverWidth - margin;
  }
  if (left < 20) {
    left = Math.max(20, (window.innerWidth - popoverWidth) / 2);
  }
  const maxTop = window.innerHeight - 500;
  if (top > maxTop) top = Math.max(20, maxTop);
  if (top < 20) top = 20;

  popover.style.left = left + 'px';
  popover.style.top = top + 'px';
}

function closeDealEditPopover() {
  document.getElementById('dealEditPopover').classList.remove('open');
  document.getElementById('dealEditBackdrop').classList.remove('open');
  editingDeal = null;
  editingCardEl = null;
  editFormValues = {};
  // Refresh pipeline cards in case action done states changed
  refreshPipelineCardActions();
  renderActionItems();
}

async function saveDealEdits() {
  if (!editingDeal) return;

  const saveBtn = document.getElementById('dealEditSave');
  saveBtn.disabled = true;
  saveBtn.textContent = 'Saving...';

  const changes = {};
  DEAL_EDIT_FIELDS.forEach(field => {
    const newVal = editFormValues[field.key];
    if (newVal !== undefined && newVal !== (editingDeal[field.key] || '')) {
      changes[field.key] = newVal;
    }
  });

  if (Object.keys(changes).length === 0) {
    showToast('No changes to save', 'pending');
    saveBtn.disabled = false;
    saveBtn.textContent = 'Save Changes';
    closeDealEditPopover();
    return;
  }

  // Apply to in-memory data
  Object.assign(editingDeal, changes);

  // If status changed, move card to new column
  if (changes.status) {
    writeStatusToSheet(editingDeal.name, changes.status);

    const targetColCards = document.querySelector(`.pipeline-col-cards[data-status="${changes.status}"]`);
    if (targetColCards && editingCardEl) {
      targetColCards.appendChild(editingCardEl);
      editingCardEl.setAttribute('data-original-status', changes.status);
    }
    updateColumnCounts();
  }

  // Write non-status fields to sheet
  const nonStatusChanges = Object.fromEntries(Object.entries(changes).filter(([k]) => k !== 'status'));
  if (Object.keys(nonStatusChanges).length > 0) {
    writeDealFieldsToSheet(editingDeal.name, nonStatusChanges);
  }

  // Update card visually
  if (editingCardEl) {
    updateCardContent(editingCardEl, editingDeal);
  }

  showToast(`Updated "${editingDeal.name}"`, 'success');
  saveBtn.disabled = false;
  saveBtn.textContent = 'Save Changes';
  closeDealEditPopover();
}

function updateCardContent(cardEl, deal) {
  const pc = PRIORITY_COLORS[deal.priority] || PRIORITY_COLORS['3 - Low'];
  const ndaCls = (deal.ndaStatus||'').toLowerCase().includes('signed') ? 'nda-signed'
    : (deal.ndaStatus||'').toLowerCase().includes('sent') ? 'nda-sent'
    : (deal.ndaStatus||'').toLowerCase().includes('loi') ? 'nda-loi' : '';
  const hasDR = deal.dataRoom && deal.dataRoom !== 'No' && deal.dataRoom !== 'N/A';
  const hasSV = deal.siteVisit && deal.siteVisit !== 'Visit TBD' && deal.siteVisit !== 'N/A';

  const colKey = cardEl.closest('.pipeline-col-cards')?.getAttribute('data-status') || '';
  const col = PIPELINE_COLUMNS.find(c => c.key === colKey) || PIPELINE_COLUMNS[0];

  cardEl.innerHTML = `
    <button class="pipeline-card-edit-btn" title="Edit deal">&#8942;</button>
    <div class="pipeline-card-name">${deal.name}</div>
    <div class="pipeline-card-detail"><strong>${deal.states || '\u2014'}</strong> \u00b7 ${deal.type || 'TBD'}</div>
    ${deal.keyContact ? `<div class="pipeline-card-detail">\ud83d\udc64 ${deal.keyContact}</div>` : ''}
    ${deal.ebitda && deal.ebitda !== 'TBD' ? `<div class="pipeline-card-detail" style="color:var(--accent-green)">\ud83d\udcb0 ${deal.ebitda}</div>` : ''}
    ${(() => { const la = getNextActionForDeal(deal.name); if (la) { const pc2 = la.priority === 'URGENT' ? 'var(--accent-red)' : la.priority === 'HIGH' ? 'var(--accent-orange)' : 'var(--text-secondary)'; const at = la.action.substring(0,100) + (la.action.length > 100 ? '...' : ''); return `<div class="pipeline-card-detail" style="color:${pc2};margin-top:4px">\u2192 ${at}</div>`; } return ''; })()}
    <div class="pipeline-card-badges">
      <span class="pipeline-card-priority" style="background:${pc.bg};color:${pc.color}">${deal.priority || '\u2014'}</span>
      ${deal.status !== col.key ? `<span class="pipeline-card-priority" style="background:${col.bg};color:${col.color}">${deal.status}</span>` : ''}
      ${ndaCls ? `<span class="pipeline-card-badge ${ndaCls}">NDA: ${deal.ndaStatus}</span>` : ''}
      ${hasDR ? `<span class="pipeline-card-badge data-room">\ud83d\udcc1 ${deal.dataRoom}</span>` : ''}
      ${hasSV ? `<span class="pipeline-card-badge site-visited">\ud83d\udccd ${deal.siteVisit}</span>` : ''}
    </div>
    ${deal.actionOwner || deal.deadline ? `<div class="pipeline-card-meta"><span>${deal.actionOwner ? '\ud83c\udfaf ' + deal.actionOwner : ''}</span><span>${deal.deadline && deal.deadline !== 'TBD' ? '\ud83d\udcc5 ' + deal.deadline : ''}</span></div>` : ''}
    ${deal.notes ? `<div class="pipeline-card-notes">${deal.notes}</div>` : ''}
  `;

  wireEditButton(cardEl);
}

function refreshPipelineCardActions() {
  document.querySelectorAll('.pipeline-card').forEach(cardEl => {
    const dealName = cardEl.getAttribute('data-deal-name');
    const deal = DATA.pipeline.find(d => d.name === dealName);
    if (deal) updateCardContent(cardEl, deal);
  });
}

async function writeDealFieldsToSheet(dealName, changes) {
  if (!APPS_SCRIPT_URL) {
    showToast('Apps Script not configured \u2014 changes saved locally only', 'pending');
    return;
  }

  try {
    const resp = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ dealName, fields: changes })
    });
    const result = await resp.json();
    if (!result.success) {
      console.warn('Field write-back failed:', result.error);
    }
  } catch (err) {
    console.warn('Field write-back network error:', err.message);
  }
}

function wireEditButton(cardEl) {
  const btn = cardEl.querySelector('.pipeline-card-edit-btn');
  if (!btn) return;
  btn.addEventListener('click', function(e) {
    e.stopPropagation();
    e.preventDefault();
    const dealName = cardEl.getAttribute('data-deal-name');
    openDealEditPopover(dealName, cardEl);
  });
  btn.addEventListener('mousedown', function(e) {
    e.stopPropagation();
  });
}

function wireAllEditButtons() {
  document.querySelectorAll('.pipeline-card').forEach(wireEditButton);
}

function initDealEditPopover() {
  document.getElementById('dealEditClose').addEventListener('click', closeDealEditPopover);
  document.getElementById('dealEditCancel').addEventListener('click', closeDealEditPopover);
  document.getElementById('dealEditBackdrop').addEventListener('click', closeDealEditPopover);
  document.getElementById('dealEditSave').addEventListener('click', saveDealEdits);
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('dealEditPopover').classList.contains('open')) {
      closeDealEditPopover();
    }
  });

  // Draggable popover via header
  const popover = document.getElementById('dealEditPopover');
  const header = document.getElementById('dealEditHeader');
  let dragOffsetX = 0, dragOffsetY = 0, isDraggingPopover = false;

  header.addEventListener('mousedown', function(e) {
    if (e.target.closest('.deal-edit-close')) return; // don't drag on close button
    isDraggingPopover = true;
    dragOffsetX = e.clientX - popover.getBoundingClientRect().left;
    dragOffsetY = e.clientY - popover.getBoundingClientRect().top;
    popover.style.transition = 'none';
    e.preventDefault();
  });

  document.addEventListener('mousemove', function(e) {
    if (!isDraggingPopover) return;
    let newLeft = e.clientX - dragOffsetX;
    let newTop = e.clientY - dragOffsetY;
    // Clamp to viewport
    newLeft = Math.max(0, Math.min(newLeft, window.innerWidth - 60));
    newTop = Math.max(0, Math.min(newTop, window.innerHeight - 60));
    popover.style.left = newLeft + 'px';
    popover.style.top = newTop + 'px';
  });

  document.addEventListener('mouseup', function() {
    if (isDraggingPopover) {
      isDraggingPopover = false;
      popover.style.transition = '';
    }
  });
}

// ============================================================
// CHARTS
// ============================================================
function updateCharts() {
  updateFunnel();
  updateOwnershipDonut();
  updateStateChart();
  updateMediumChart();
  updateAccountChart();
  updateTierDonut();
  updateActivityChart();
  initDailyOutreachChart();
}

let funnelSelectedStep = null; // track which step is selected
let funnelDateFrom = '';
let funnelDateTo = '';
let channelDateFrom = '';
let channelDateTo = '';

function filterCompaniesByDateRange(companies, dateFrom, dateTo) {
  if (!dateFrom && !dateTo) return companies;
  const from = dateFrom ? new Date(dateFrom + 'T00:00:00') : null;
  const to = dateTo ? new Date(dateTo + 'T23:59:59') : null;
  return companies.filter(c => {
    // A company matches if any of its outreach dates fall within range
    // Use lastMsg as primary (most recent activity), firstMsg as fallback
    const dateStr = c.lastMsg || c.firstMsg;
    if (!dateStr) return false;
    const d = parseDateStr(dateStr);
    if (isNaN(d.getTime())) return false;
    if (from && d < from) return false;
    if (to && d > to) return false;
    return true;
  });
}

function filterMessagesByDateRange(messages, dateFrom, dateTo) {
  if (!dateFrom && !dateTo) return messages;
  const from = dateFrom ? new Date(dateFrom + 'T00:00:00') : null;
  const to = dateTo ? new Date(dateTo + 'T23:59:59') : null;
  return messages.filter(m => {
    if (!m.date) return false;
    const d = parseDateStr(m.date);
    if (isNaN(d.getTime())) return false;
    if (from && d < from) return false;
    if (to && d > to) return false;
    return true;
  });
}

function initFunnelDateRange() {
  const fromInput = document.getElementById('funnelDateFrom');
  const toInput = document.getElementById('funnelDateTo');
  const clearBtn = document.getElementById('funnelDateClear');

  function onChange() {
    funnelDateFrom = fromInput.value || '';
    funnelDateTo = toInput.value || '';
    fromInput.classList.toggle('active', !!funnelDateFrom);
    toInput.classList.toggle('active', !!funnelDateTo);
    clearBtn.classList.toggle('visible', !!(funnelDateFrom || funnelDateTo));
    updateFunnel();
  }
  fromInput.addEventListener('change', onChange);
  toInput.addEventListener('change', onChange);
  clearBtn.addEventListener('click', () => {
    funnelDateFrom = ''; funnelDateTo = '';
    fromInput.value = ''; toInput.value = '';
    fromInput.classList.remove('active'); toInput.classList.remove('active');
    clearBtn.classList.remove('visible');
    updateFunnel();
  });
}

function initChannelDateRange() {
  const fromInput = document.getElementById('channelDateFrom');
  const toInput = document.getElementById('channelDateTo');
  const clearBtn = document.getElementById('channelDateClear');

  function onChange() {
    channelDateFrom = fromInput.value || '';
    channelDateTo = toInput.value || '';
    fromInput.classList.toggle('active', !!channelDateFrom);
    toInput.classList.toggle('active', !!channelDateTo);
    clearBtn.classList.toggle('visible', !!(channelDateFrom || channelDateTo));
    updateMediumChart();
  }
  fromInput.addEventListener('change', onChange);
  toInput.addEventListener('change', onChange);
  clearBtn.addEventListener('click', () => {
    channelDateFrom = ''; channelDateTo = '';
    fromInput.value = ''; toInput.value = '';
    fromInput.classList.remove('active'); toInput.classList.remove('active');
    clearBtn.classList.remove('visible');
    updateMediumChart();
  });
}

function updateFunnel() {
  const d = filterCompaniesByDateRange(filteredData, funnelDateFrom, funnelDateTo);
  const total = d.length;
  const contacted = d.filter(c => c.msgsSent > 0);
  const responded = d.filter(c => c.responded);
  const scheduled = d.filter(c => c.scheduledIntro);
  const assisted = d.filter(c => c.assistedMeeting);
  const pipeline = d.filter(c => c.inPipeline);

  const steps = [
    { key: 'total', label: 'Total Companies', companies: d, color: 'var(--accent-blue)', pct: '100%' },
    { key: 'contacted', label: 'Contacted', companies: contacted, color: 'var(--accent-cyan)', pct: total > 0 ? ((contacted.length/total)*100).toFixed(1)+'%' : '0%' },
    { key: 'responded', label: 'Responded', companies: responded, color: 'var(--accent-green)', pct: contacted.length > 0 ? ((responded.length/contacted.length)*100).toFixed(1)+'% of contacted' : '0%' },
    { key: 'scheduled', label: 'Intro Scheduled', companies: scheduled, color: 'var(--accent-purple)', pct: responded.length > 0 ? ((scheduled.length/responded.length)*100).toFixed(1)+'% of responded' : '0%' },
    { key: 'assisted', label: 'Assisted Meeting', companies: assisted, color: 'var(--accent-orange)', pct: scheduled.length > 0 ? ((assisted.length/scheduled.length)*100).toFixed(1)+'% of scheduled' : '0%' },
    { key: 'pipeline', label: 'In Pipeline', companies: pipeline, color: 'var(--accent-pink)', pct: assisted.length > 0 ? ((pipeline.length/assisted.length)*100).toFixed(1)+'% of meetings' : '0%' },
  ];

  // Store for drilldown access
  window._funnelSteps = steps;

  const baseVal = Math.max(total, 1);
  document.getElementById('funnelChart').innerHTML = steps.map((s, i) => {
    const proportional = (s.companies.length / baseVal) * 100;
    const maxForTier = 100 - i * 6;
    const width = Math.max(Math.min(proportional, maxForTier), 8);
    const selectedClass = funnelSelectedStep === s.key ? ' selected' : (funnelSelectedStep ? ' dimmed' : '');
    return `
    <div class="funnel-step${selectedClass}" data-step="${s.key}">
      <div class="funnel-bar" style="width:${width}%;background:${s.color}">${s.companies.length}</div>
      <div class="funnel-info"><div class="funnel-label">${s.label}</div><div class="funnel-pct">${s.pct}</div></div>
    </div>
  `}).join('');

  // Wire click handlers
  document.querySelectorAll('#funnelChart .funnel-step').forEach(el => {
    el.addEventListener('click', function() {
      const stepKey = this.dataset.step;
      const step = steps.find(s => s.key === stepKey);
      if (!step || step.companies.length === 0) return;

      if (funnelSelectedStep === stepKey) {
        // Deselect
        funnelSelectedStep = null;
        document.getElementById('funnelDrilldown').innerHTML = '';
        chartHighlightCompanies = null;
        chartHighlightMax = 0;
        updateMap();
        document.getElementById('chartMapIndicator').innerHTML = '';
      } else {
        // Clear any active chart bar selections first
        document.querySelectorAll('#dailyOutreachChart .daily-chart-bar-wrap.selected').forEach(b => b.classList.remove('selected'));
        document.getElementById('dailyDrilldown').innerHTML = '';

        funnelSelectedStep = stepKey;

        // Highlight on map — count messages per company
        const companyCounts = new Map();
        step.companies.forEach(c => {
          companyCounts.set(c.name, c.msgsSent || 0);
        });
        chartHighlightCompanies = companyCounts.size > 0 ? companyCounts : null;
        chartHighlightMax = 0;
        companyCounts.forEach(v => { if (v > chartHighlightMax) chartHighlightMax = v; });
        updateMap();

        // Fit map to highlighted companies
        const highlightedLatLngs = step.companies.filter(c => c.lat && c.lng).map(c => [c.lat, c.lng]);
        if (highlightedLatLngs.length === 1) {
          map.setView(highlightedLatLngs[0], 8, { animate: true, duration: 0.5 });
        } else if (highlightedLatLngs.length > 1) {
          map.fitBounds(highlightedLatLngs, { padding: [60, 60], maxZoom: 10, animate: true, duration: 0.5 });
        }

        // Show map indicator
        const compCount = companyCounts.size;
        document.getElementById('chartMapIndicator').innerHTML = `
          <div class="chart-map-indicator">
            <span class="map-dot"></span>
            Showing ${compCount} compan${compCount !== 1 ? 'ies' : 'y'} on map — ${step.label}
            <button class="chart-map-clear" onclick="funnelSelectedStep=null;document.getElementById('funnelDrilldown').innerHTML='';chartHighlightCompanies=null;chartHighlightMax=0;updateMap();updateFunnelStepStates();document.getElementById('chartMapIndicator').innerHTML='';">Clear</button>
          </div>
        `;

        // Render drilldown
        renderFunnelDrilldown(step);
      }

      // Re-render funnel bars to update selected/dimmed states
      updateFunnelStepStates();
    });
  });

  // Restore drilldown if step was previously selected
  if (funnelSelectedStep) {
    const step = steps.find(s => s.key === funnelSelectedStep);
    if (step && step.companies.length > 0) {
      renderFunnelDrilldown(step);
    } else {
      funnelSelectedStep = null;
      document.getElementById('funnelDrilldown').innerHTML = '';
    }
  }
}

function updateFunnelStepStates() {
  document.querySelectorAll('#funnelChart .funnel-step').forEach(el => {
    el.classList.remove('selected', 'dimmed');
    if (funnelSelectedStep) {
      if (el.dataset.step === funnelSelectedStep) {
        el.classList.add('selected');
      } else {
        el.classList.add('dimmed');
      }
    }
  });
}

// ── Drilldown sorting utility ──
function wireDrilldownSort(tableEl, data, columns, renderRowFn) {
  let sortCol = columns[0].key;
  let sortDir = columns[0].defaultDir || 'asc';

  function doSort() {
    const col = columns.find(c => c.key === sortCol);
    const sorted = [...data].sort((a, b) => {
      const va = col.valueFn(a);
      const vb = col.valueFn(b);
      if (typeof va === 'number' && typeof vb === 'number') return sortDir === 'asc' ? va - vb : vb - va;
      const sa = String(va || '').toLowerCase(), sb = String(vb || '').toLowerCase();
      return sortDir === 'asc' ? sa.localeCompare(sb) : sb.localeCompare(sa);
    });
    tableEl.querySelector('tbody').innerHTML = sorted.map(renderRowFn).join('');
    // Update header arrows
    tableEl.querySelectorAll('th').forEach(th => {
      th.classList.toggle('sort-active', th.dataset.sortKey === sortCol);
      const arrow = th.querySelector('.sort-arrow');
      if (arrow) arrow.textContent = th.dataset.sortKey === sortCol ? (sortDir === 'asc' ? '▲' : '▼') : '▲';
    });
  }

  // Render headers
  tableEl.querySelector('thead tr').innerHTML = columns.map(col =>
    `<th data-sort-key="${col.key}">${col.label} <span class="sort-arrow">▲</span></th>`
  ).join('');

  // Wire click
  tableEl.querySelectorAll('th').forEach(th => {
    th.addEventListener('click', function() {
      const key = this.dataset.sortKey;
      if (sortCol === key) { sortDir = sortDir === 'asc' ? 'desc' : 'asc'; }
      else { sortCol = key; sortDir = columns.find(c => c.key === key)?.defaultDir || 'asc'; }
      doSort();
    });
  });

  doSort();
}

function getFunnelStatusLabel(c) {
  if (c.inPipeline) return `<span class="drilldown-medium drilldown-medium-email">${c.pipelineStatus || 'Pipeline'}</span>`;
  if (c.assistedMeeting) return '<span class="drilldown-medium drilldown-medium-vm">Meeting</span>';
  if (c.scheduledIntro) return '<span class="drilldown-medium drilldown-medium-linkedin">Intro Scheduled</span>';
  if (c.responded) return '<span class="drilldown-medium drilldown-medium-text">Responded</span>';
  if (c.msgsSent > 0) return '<span class="drilldown-medium drilldown-medium-call">Contacted</span>';
  return '<span class="drilldown-medium drilldown-medium-default">Not Contacted</span>';
}
function getFunnelStatusRank(c) {
  if (c.inPipeline) return 5;
  if (c.assistedMeeting) return 4;
  if (c.scheduledIntro) return 3;
  if (c.responded) return 2;
  if (c.msgsSent > 0) return 1;
  return 0;
}

function renderFunnelDrilldown(step) {
  document.getElementById('funnelDrilldown').innerHTML = `
    <div class="drilldown-panel">
      <div class="drilldown-header">
        <span class="drilldown-title">${step.label}<span class="drilldown-count">${step.companies.length} compan${step.companies.length !== 1 ? 'ies' : 'y'}</span></span>
        <button class="drilldown-close" onclick="funnelSelectedStep=null;document.getElementById('funnelDrilldown').innerHTML='';chartHighlightCompanies=null;chartHighlightMax=0;updateMap();updateFunnelStepStates();document.getElementById('chartMapIndicator').innerHTML='';">✕</button>
      </div>
      <div class="drilldown-table-wrap">
        <table class="drilldown-table">
          <thead><tr></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  `;

  const tableEl = document.querySelector('#funnelDrilldown .drilldown-table');
  const columns = [
    { key: 'company', label: 'Company', valueFn: c => c.name || '', defaultDir: 'asc' },
    { key: 'state', label: 'State', valueFn: c => c.fullState || c.state || '', defaultDir: 'asc' },
    { key: 'ownership', label: 'Ownership', valueFn: c => c.ownership || '', defaultDir: 'asc' },
    { key: 'msgs', label: 'Msgs Sent', valueFn: c => c.msgsSent || 0, defaultDir: 'desc' },
    { key: 'status', label: 'Status', valueFn: c => getFunnelStatusRank(c), defaultDir: 'desc' },
  ];
  const renderRow = c => `<tr>
    <td>${c.name || '-'}</td>
    <td>${c.fullState || c.state || '-'}</td>
    <td>${c.ownership || '-'}</td>
    <td>${c.msgsSent || 0}</td>
    <td>${getFunnelStatusLabel(c)}</td>
  </tr>`;

  wireDrilldownSort(tableEl, step.companies, columns, renderRow);
}

function makeDonut(containerId, data, colors, opts = {}) {
  const total = data.reduce((a, b) => a + b[1], 0) || 1;
  let cumAngle = 0;
  const segments = data.map(([key, val], i) => {
    const angle = (val / total) * 360;
    const s = { key, val, color: colors[i % colors.length], startAngle: cumAngle, angle };
    cumAngle += angle;
    return s;
  });

  const clickable = opts.clickable || false;
  const activeKeys = opts.activeKeys || new Set();
  const hasActive = activeKeys.size > 0;

  const svgPaths = segments.map(s => {
    if (s.angle <= 0) return '';
    const r = 65, cx = 80, cy = 80;
    const startRad = (s.startAngle - 90) * Math.PI / 180;
    const endRad = (s.startAngle + s.angle - 90) * Math.PI / 180;
    const x1 = cx + r * Math.cos(startRad), y1 = cy + r * Math.sin(startRad);
    const x2 = cx + r * Math.cos(endRad), y2 = cy + r * Math.sin(endRad);
    const dimmed = hasActive && !activeKeys.has(s.key);
    const opacity = dimmed ? 0.2 : 0.85;
    const cursor = clickable ? 'cursor:pointer;' : '';
    return `<path data-key="${s.key}" d="M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${s.angle > 180 ? 1 : 0} 1 ${x2} ${y2} Z" fill="${s.color}" opacity="${opacity}" style="${cursor}"/>`;
  }).join('');

  const legend = data.map(([key, val], i) => {
    const dimmed = hasActive && !activeKeys.has(key);
    const cursor = clickable ? 'cursor:pointer;' : '';
    return `<div class="donut-legend-item${dimmed ? ' dimmed' : ''}" data-key="${key}" style="${cursor}"><span class="donut-legend-dot" style="background:${colors[i % colors.length]}"></span>${key || 'Unknown'}<span class="donut-legend-value">${val}</span></div>`;
  }).join('');

  document.getElementById(containerId).innerHTML = `
    <svg class="donut-svg" viewBox="0 0 160 160">
      ${svgPaths}
      <circle cx="80" cy="80" r="40" fill="#111827"/>
      <text x="80" y="76" text-anchor="middle" fill="white" font-size="18" font-weight="800">${total}</text>
      <text x="80" y="92" text-anchor="middle" fill="#94a3b8" font-size="10" font-weight="500">Total</text>
    </svg>
    <div class="donut-legend">${legend}</div>
  `;
}

function updateOwnershipDonut() {
  const counts = {};
  // Use ALL companies (not filteredData) so the donut shows everything, with active ones highlighted
  DATA.companies.forEach(c => { const k = c.ownership || 'Unknown'; counts[k] = (counts[k] || 0) + 1; });
  const entries = Object.entries(counts).sort((a, b) => b[1] - a[1]);
  const colors = entries.map(([k]) => OWNERSHIP_COLORS[k] || '#64748b');
  makeDonut('ownershipDonut', entries, colors, {
    clickable: true,
    activeKeys: activeFilters.ownership,
  });

  // Wire click handlers on donut segments and legend items
  const container = document.getElementById('ownershipDonut');
  container.querySelectorAll('[data-key]').forEach(el => {
    el.addEventListener('click', function() {
      const key = this.dataset.key;
      if (activeFilters.ownership.has(key)) {
        activeFilters.ownership.delete(key);
      } else {
        activeFilters.ownership.add(key);
      }
      // Sync the ownership filter bar buttons
      syncOwnershipFilterBar();
      updateSoloFilter('ownership');
      applyFilters();
    });
  });
}

function syncOwnershipFilterBar() {
  document.querySelectorAll('#ownershipFilters .filter-btn').forEach(btn => {
    const key = btn.dataset.filterKey;
    btn.classList.toggle('active', activeFilters.ownership.has(key));
  });
}

function updateTierDonut() {
  const counts = {};
  filteredData.forEach(c => { const k = c.stateTier || 'Unknown'; counts[k] = (counts[k] || 0) + 1; });
  const entries = Object.entries(counts).sort((a, b) => b[1] - a[1]);
  const colors = ['#3b82f6', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#ec4899', '#64748b'];
  makeDonut('tierDonut', entries, colors);
}

function makeBarChart(containerId, data, colors) {
  const maxVal = data.length > 0 ? Math.max(...data.map(d => d[1])) : 1;
  document.getElementById(containerId).innerHTML = data.map(([label, count], i) => `
    <div class="bar-row">
      <div class="bar-label" title="${label}">${label}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${(count/maxVal)*100}%;background:${colors[i % colors.length]}">${count > maxVal * 0.15 ? count : ''}</div></div>
      <div class="bar-value">${count}</div>
    </div>
  `).join('');
}

let stateSelectedBar = null; // track which state bar is selected for drilldown

function updateStateChart() {
  // Use filteredData so state chart responds to ownership, sidebar, and all other filters
  const counts = {};
  const companiesByState = {};
  filteredData.forEach(c => {
    const st = c.fullState || c.state;
    if (st && st !== '#ERROR!') {
      counts[st] = (counts[st] || 0) + 1;
      if (!companiesByState[st]) companiesByState[st] = [];
      companiesByState[st].push(c);
    }
  });
  const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 15);
  const maxVal = sorted.length > 0 ? Math.max(...sorted.map(d => d[1])) : 1;
  const colors = ['#3b82f6', '#06b6d4', '#8b5cf6', '#10b981', '#f59e0b', '#ec4899', '#6366f1', '#14b8a6', '#a855f7', '#f43f5e', '#0ea5e9', '#84cc16', '#f97316', '#64748b', '#e879f9'];

  window._stateCompanies = companiesByState;

  document.getElementById('stateBarChart').innerHTML = sorted.map(([label, count], i) => {
    const isSelected = stateSelectedBar === label;
    return `
      <div class="bar-row clickable ${isSelected ? 'active' : ''}" data-state="${label.replace(/"/g, '&quot;')}">
        <div class="bar-label" title="${label}">${label}</div>
        <div class="bar-track"><div class="bar-fill" style="width:${(count/maxVal)*100}%;background:${colors[i % colors.length]}"></div></div>
        <div class="bar-value">${count}</div>
      </div>
    `;
  }).join('');

  // Wire click handlers for drilldown
  document.querySelectorAll('#stateBarChart .bar-row').forEach(row => {
    row.addEventListener('click', function() {
      const stateName = this.dataset.state;
      if (stateSelectedBar === stateName) {
        // Deselect
        stateSelectedBar = null;
        document.getElementById('stateDrilldown').innerHTML = '';
        document.querySelectorAll('#stateBarChart .bar-row').forEach(r => r.classList.remove('active'));
      } else {
        stateSelectedBar = stateName;
        document.querySelectorAll('#stateBarChart .bar-row').forEach(r => r.classList.toggle('active', r.dataset.state === stateName));
        renderStateDrilldown(stateName, companiesByState[stateName] || []);
      }
    });
  });

  // Badge for map-based state filter (still works from map clicks)
  const badge = document.getElementById('stateFilterBadge');
  if (activeFilters.state.size > 0) {
    const names = Array.from(activeFilters.state).join(', ');
    badge.innerHTML = `<span class="state-filter-badge" onclick="clearStateFilter()">
      ${names} <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg>
    </span>`;
  } else {
    badge.innerHTML = '';
  }

  // Update map state boundaries highlighting + overlay badge
  renderStateBoundaries();
  updateStateFilterOverlay();

  // Restore drilldown if a state was selected
  if (stateSelectedBar && companiesByState[stateSelectedBar]) {
    renderStateDrilldown(stateSelectedBar, companiesByState[stateSelectedBar]);
  } else if (stateSelectedBar) {
    stateSelectedBar = null;
    document.getElementById('stateDrilldown').innerHTML = '';
  }
}

function getCompanyStatusLabel(c) {
  if (c.inPipeline) return `<span class="drilldown-medium drilldown-medium-email">${c.pipelineStatus || 'Pipeline'}</span>`;
  if (c.assistedMeeting) return '<span class="drilldown-medium drilldown-medium-vm">Meeting</span>';
  if (c.scheduledIntro) return '<span class="drilldown-medium drilldown-medium-linkedin">Intro Scheduled</span>';
  if (c.responded) return '<span class="drilldown-medium drilldown-medium-text">Responded</span>';
  if (c.msgsSent > 0) return '<span class="drilldown-medium drilldown-medium-call">Contacted</span>';
  return '<span class="drilldown-medium drilldown-medium-default">Not Contacted</span>';
}
function getCompanyStatusRank(c) {
  if (c.inPipeline) return 5;
  if (c.assistedMeeting) return 4;
  if (c.scheduledIntro) return 3;
  if (c.responded) return 2;
  if (c.msgsSent > 0) return 1;
  return 0;
}

function renderStateDrilldown(stateName, companies) {
  document.getElementById('stateDrilldown').innerHTML = `
    <div class="drilldown-panel">
      <div class="drilldown-header">
        <span class="drilldown-title">${stateName}<span class="drilldown-count">${companies.length} compan${companies.length !== 1 ? 'ies' : 'y'}</span></span>
        <button class="drilldown-close" onclick="stateSelectedBar=null;document.getElementById('stateDrilldown').innerHTML='';document.querySelectorAll('#stateBarChart .bar-row').forEach(r=>r.classList.remove('active'));">✕</button>
      </div>
      <div class="drilldown-table-wrap">
        <table class="drilldown-table">
          <thead><tr></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  `;

  const tableEl = document.querySelector('#stateDrilldown .drilldown-table');
  const columns = [
    { key: 'company', label: 'Company', valueFn: c => c.name || '', defaultDir: 'asc' },
    { key: 'ownership', label: 'Ownership', valueFn: c => c.ownership || '', defaultDir: 'asc' },
    { key: 'msgs', label: 'Msgs Sent', valueFn: c => c.msgsSent || 0, defaultDir: 'desc' },
    { key: 'status', label: 'Status', valueFn: c => getCompanyStatusRank(c), defaultDir: 'desc' },
  ];
  const renderRow = c => `<tr>
    <td>${c.name || '-'}</td>
    <td>${c.ownership || '-'}</td>
    <td>${c.msgsSent || 0}</td>
    <td>${getCompanyStatusLabel(c)}</td>
  </tr>`;

  wireDrilldownSort(tableEl, companies, columns, renderRow);
}

function toggleStateFilter(state) {
  if (activeFilters.state.has(state)) {
    activeFilters.state.delete(state);
  } else {
    activeFilters.state.add(state);
  }
  applyFilters();
}

function clearStateFilter() {
  activeFilters.state.clear();
  applyFilters();
}

function updateMediumChart() {
  const counts = {};
  if (channelDateFrom || channelDateTo) {
    // Use per-message data filtered by date range
    const allMsgs = getDailyOutreachData();
    const filtered = filterMessagesByDateRange(allMsgs, channelDateFrom, channelDateTo);
    filtered.forEach(m => { if (m.medium) counts[m.medium] = (counts[m.medium] || 0) + 1; });
  } else {
    // Default: use company-level aggregated data
    filteredData.forEach(c => {
      if (c.byMedium) Object.entries(c.byMedium).forEach(([k, v]) => { counts[k] = (counts[k] || 0) + v; });
    });
  }
  const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
  const colors = ['#06b6d4', '#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ec4899', '#f43f5e'];
  makeBarChart('mediumBarChart', sorted, colors);
}

function updateAccountChart() {
  const counts = {};
  filteredData.forEach(c => {
    if (c.byAccount) Object.entries(c.byAccount).forEach(([k, v]) => { counts[k] = (counts[k] || 0) + v; });
  });
  const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
  const colors = ['#8b5cf6', '#3b82f6', '#06b6d4', '#10b981', '#f59e0b'];
  makeBarChart('accountBarChart', sorted, colors);
}

function updateActivityChart() {
  const monthly = DATA.meta.monthlyCounts || {};
  const entries = Object.entries(monthly).sort((a, b) => a[0].localeCompare(b[0]));
  if (entries.length === 0) { document.getElementById('activityChart').innerHTML = '<div style="color:var(--text-muted);font-size:13px">No monthly data available</div>'; return; }
  const maxVal = Math.max(...entries.map(e => e[1]), 1);

  const monthNames = { '01': 'Jan', '02': 'Feb', '03': 'Mar', '04': 'Apr', '05': 'May', '06': 'Jun', '07': 'Jul', '08': 'Aug', '09': 'Sep', '10': 'Oct', '11': 'Nov', '12': 'Dec' };

  document.getElementById('activityChart').innerHTML = `
    <div class="activity-bars">
      ${entries.map(([key, val]) => {
        const [year, month] = key.split('-');
        const label = `${monthNames[month]} '${year.slice(2)}`;
        const height = Math.max((val / maxVal) * 140, 4);
        return `
          <div class="activity-bar-wrap" title="${label}: ${val} messages">
            <div class="activity-bar-val">${val}</div>
            <div class="activity-bar" style="height:${height}px"></div>
            <div class="activity-bar-label">${label}</div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

// ============================================================
// DAILY OUTREACH CHART
// ============================================================
let dailyRange = 'monthly';
let dailyChannels = new Set(); // empty = all channels
let chartHighlightCompanies = null; // Map of company name → msg count, null = no filter
let chartHighlightMax = 0; // max msg count across highlighted companies
let customDateFrom = ''; // YYYY-MM-DD, empty = use default range
let customDateTo = '';   // YYYY-MM-DD, empty = use default range

function getDailyOutreachData() {
  // Build per-message list from DATA.messages (new) or reconstruct from companies (legacy)
  let messages = [];
  if (DATA.messages && DATA.messages.length > 0) {
    messages = DATA.messages.filter(m => m.date);
  } else {
    // Fallback: reconstruct from company-level data (no per-day granularity, only counts)
    // We can at least use firstMsg/lastMsg dates + medium counts per company
    // This is very approximate — better data comes once fetch_airtable.py re-runs
    filteredData.forEach(c => {
      if (c.byMedium) {
        Object.entries(c.byMedium).forEach(([med, count]) => {
          for (let i = 0; i < count; i++) {
            messages.push({ date: c.lastMsg || c.firstMsg || '', medium: med, account: '', company: c.name || '', contact: '' });
          }
        });
      }
    });
  }
  return messages;
}

function parseDateStr(dateStr) {
  // Handle MM/DD/YYYY format
  const mdy = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (mdy) return new Date(parseInt(mdy[3]), parseInt(mdy[1]) - 1, parseInt(mdy[2]));
  return new Date(dateStr);
}

function updateDailyOutreachChart() {
  const messages = getDailyOutreachData();
  if (messages.length === 0) {
    document.getElementById('dailyOutreachChart').innerHTML = '<div class="daily-chart-empty">No outreach data available</div>';
    document.getElementById('dailyOutreachSummary').innerHTML = '';
    return;
  }

  // Determine available channels and build filter buttons
  const allChannels = new Set();
  messages.forEach(m => { if (m.medium) allChannels.add(m.medium); });
  const channelContainer = document.getElementById('dailyChannelFilters');
  const channelArr = [...allChannels].sort();
  channelContainer.innerHTML = channelArr.map(ch =>
    `<button class="daily-filter-btn channel-btn ${dailyChannels.size === 0 || dailyChannels.has(ch) ? 'active' : ''}" data-channel="${ch}">${ch}</button>`
  ).join('');

  // Wire channel filter clicks — click to toggle individual channels
  channelContainer.querySelectorAll('.channel-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const ch = this.dataset.channel;
      if (dailyChannels.size === 0) {
        // All active — clicking one means "show only this one"
        dailyChannels = new Set([ch]);
      } else if (dailyChannels.has(ch) && dailyChannels.size === 1) {
        // Only one active and clicking it — reset to all
        dailyChannels = new Set();
      } else if (dailyChannels.has(ch)) {
        dailyChannels.delete(ch);
      } else {
        dailyChannels.add(ch);
        if (dailyChannels.size === channelArr.length) dailyChannels = new Set(); // all = reset
      }
      updateDailyOutreachChart();
    });
  });

  // Filter by channel
  let filtered = messages;
  if (dailyChannels.size > 0) {
    filtered = messages.filter(m => dailyChannels.has(m.medium));
  }

  // Parse all message dates upfront, keeping the original message reference
  const now = new Date();
  const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const parsed = [];
  filtered.forEach(m => {
    if (!m.date) return;
    const d = parseDateStr(m.date);
    if (!isNaN(d.getTime())) parsed.push({ d, msg: m });
  });

  // Bucket helper: get the Monday of a date's week
  function getMonday(d) {
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
    const mon = new Date(d);
    mon.setDate(diff);
    return mon.toISOString().split('T')[0];
  }
  // Bucket helper: get quarter key like "Q1 2025"
  function getQuarter(d) {
    const q = Math.floor(d.getMonth() / 3) + 1;
    return `Q${q} ${d.getFullYear()}`;
  }

  // Determine date range and bucket function
  let startDate, endDate;
  let bucketFn, bucketMode;
  switch (dailyRange) {
    case 'daily':
      startDate = new Date(now); startDate.setDate(startDate.getDate() - 30);
      bucketFn = d => d.toISOString().split('T')[0];
      bucketMode = 'day';
      break;
    case 'weekly':
      startDate = new Date(now); startDate.setMonth(startDate.getMonth() - 3);
      bucketFn = d => getMonday(d);
      bucketMode = 'week';
      break;
    case 'monthly':
      startDate = new Date(now); startDate.setFullYear(startDate.getFullYear() - 1);
      bucketFn = d => d.toISOString().split('T')[0].slice(0, 7); // YYYY-MM
      bucketMode = 'month';
      break;
    case 'quarterly':
      startDate = null; // all time
      bucketFn = d => getQuarter(d);
      bucketMode = 'quarter';
      break;
  }

  // Override with custom date range if set
  if (customDateFrom) {
    startDate = new Date(customDateFrom + 'T00:00:00');
  }
  if (customDateTo) {
    endDate = new Date(customDateTo + 'T23:59:59');
  } else {
    endDate = now;
  }

  // Aggregate into buckets — track counts and messages
  const bucketMap = {};
  const bucketMsgs = {};
  const bucketOrder = [];
  let totalInRange = 0;
  parsed.forEach(({ d, msg }) => {
    if (startDate && d < startDate) return;
    if (endDate && d > endDate) return;
    const key = bucketFn(d);
    if (!bucketMap[key]) { bucketMap[key] = 0; bucketMsgs[key] = []; bucketOrder.push(key); }
    bucketMap[key]++;
    bucketMsgs[key].push(msg);
    totalInRange++;
  });

  // Fill gaps for continuous axes
  let entries = [];
  if (bucketMode === 'day') {
    const cursor = new Date(startDate); cursor.setHours(0,0,0,0);
    while (cursor <= endDate) {
      const k = cursor.toISOString().split('T')[0];
      entries.push({ key: k, val: bucketMap[k] || 0 });
      cursor.setDate(cursor.getDate() + 1);
    }
  } else if (bucketMode === 'week') {
    const cursor = new Date(startDate); cursor.setHours(0,0,0,0);
    // Advance to Monday
    const day = cursor.getDay();
    cursor.setDate(cursor.getDate() - day + (day === 0 ? -6 : 1));
    while (cursor <= endDate) {
      const k = cursor.toISOString().split('T')[0];
      entries.push({ key: k, val: bucketMap[k] || 0 });
      cursor.setDate(cursor.getDate() + 7);
    }
  } else if (bucketMode === 'month') {
    const cursor = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
    const endMonth = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
    while (cursor <= endMonth) {
      const k = cursor.toISOString().split('T')[0].slice(0, 7);
      entries.push({ key: k, val: bucketMap[k] || 0 });
      cursor.setMonth(cursor.getMonth() + 1);
    }
  } else {
    // quarter — fill from earliest to latest
    if (bucketOrder.length > 0) {
      const firstD = parsed.map(p => p.d).filter(d => (!startDate || d >= startDate) && (!endDate || d <= endDate)).sort((a,b) => a - b)[0];
      const startQ = Math.floor(firstD.getMonth() / 3);
      const startY = firstD.getFullYear();
      const endQ = Math.floor(endDate.getMonth() / 3);
      const endY = endDate.getFullYear();
      let cy = startY, cq = startQ;
      while (cy < endY || (cy === endY && cq <= endQ)) {
        const k = `Q${cq + 1} ${cy}`;
        entries.push({ key: k, val: bucketMap[k] || 0 });
        cq++;
        if (cq > 3) { cq = 0; cy++; }
      }
    }
  }

  // Summary stats
  const avgVal = entries.length > 0 ? (totalInRange / entries.length).toFixed(bucketMode === 'day' ? 1 : 0) : '0';
  const maxEntry = entries.reduce((mx, e) => e.val > mx.val ? e : mx, { key: '', val: 0 });
  const activeCount = entries.filter(e => e.val > 0).length;
  const unitLabel = bucketMode === 'day' ? 'Day' : bucketMode === 'week' ? 'Week' : bucketMode === 'month' ? 'Month' : 'Quarter';
  const unitLabelPlural = bucketMode === 'day' ? 'Days' : bucketMode === 'week' ? 'Weeks' : bucketMode === 'month' ? 'Months' : 'Quarters';

  function formatBucketLabel(key) {
    if (bucketMode === 'day') return formatDayLabel(key, 'short');
    if (bucketMode === 'week') return 'Wk of ' + formatDayLabel(key, 'short');
    if (bucketMode === 'month') {
      const [y, m] = key.split('-');
      return `${MONTHS[parseInt(m) - 1]} ${y}`;
    }
    return key; // Q1 2025
  }

  const peakLabel = maxEntry.key ? formatBucketLabel(maxEntry.key) : '-';

  document.getElementById('dailyOutreachSummary').innerHTML = `
    <div class="daily-summary-stat"><span class="daily-summary-val">${totalInRange}</span><span class="daily-summary-label">Total in Period</span></div>
    <div class="daily-summary-stat"><span class="daily-summary-val">${avgVal}</span><span class="daily-summary-label">Avg / ${unitLabel}</span></div>
    <div class="daily-summary-stat"><span class="daily-summary-val">${activeCount}</span><span class="daily-summary-label">Active ${unitLabelPlural}</span></div>
    <div class="daily-summary-stat"><span class="daily-summary-val">${maxEntry.val}</span><span class="daily-summary-label">Peak (${peakLabel})</span></div>
  `;

  // Render bars — clear any previous selection/drill-down/map highlight
  document.getElementById('dailyDrilldown').innerHTML = '';
  document.getElementById('chartMapIndicator').innerHTML = '';
  if (chartHighlightCompanies) { chartHighlightCompanies = null; updateMap(); }
  if (entries.length === 0) {
    document.getElementById('dailyOutreachChart').innerHTML = '<div class="daily-chart-empty">No data in selected range</div>';
    return;
  }

  const maxVal = Math.max(...entries.map(e => e.val), 1);

  document.getElementById('dailyOutreachChart').innerHTML = `
    <div class="daily-chart-bars">
      ${entries.map((e, i) => {
        const height = Math.max((e.val / maxVal) * 160, e.val > 0 ? 3 : 1);
        let label = '';
        if (bucketMode === 'day') {
          // Always show day-of-week; on Sundays show the date
          const dt = new Date(e.key + 'T12:00:00');
          const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
          const dayOfWeek = dt.getDay();
          if (dayOfWeek === 0) {
            label = `${parseInt(e.key.split('-')[1])}/${parseInt(e.key.split('-')[2])}`;
          } else {
            label = days[dayOfWeek];
          }
        } else if (bucketMode === 'week') {
          label = formatDayLabel(e.key, 'short');
        } else if (bucketMode === 'month') {
          const [y, m] = e.key.split('-');
          label = MONTHS[parseInt(m) - 1];
        } else {
          label = e.key; // Q1 2025
        }
        const tooltip = `${formatBucketLabel(e.key)}: ${e.val} messages — click to drill down`;
        const barColor = e.val === 0 ? 'rgba(100,116,139,0.2)' : '';
        return `
          <div class="daily-chart-bar-wrap" data-key="${e.key}" title="${tooltip}">
            <div class="daily-chart-bar-val">${e.val > 0 ? e.val : ''}</div>
            <div class="daily-chart-bar" style="height:${height}px;${barColor ? 'background:' + barColor : ''}"></div>
            <div class="daily-chart-bar-label">${label}</div>
          </div>
        `;
      }).join('')}
    </div>
  `;

  // Wire bar click → multi-select drill-down + map highlight
  document.querySelectorAll('#dailyOutreachChart .daily-chart-bar-wrap').forEach(bar => {
    bar.addEventListener('click', function() {
      const key = this.dataset.key;
      const msgs = bucketMsgs[key] || [];
      if (msgs.length === 0) return;

      // Toggle this bar's selection
      this.classList.toggle('selected');

      // Collect all messages from all selected bars
      const selectedBars = document.querySelectorAll('#dailyOutreachChart .daily-chart-bar-wrap.selected');
      const allSelectedMsgs = [];
      const allSelectedKeys = [];
      selectedBars.forEach(b => {
        const k = b.dataset.key;
        allSelectedKeys.push(k);
        (bucketMsgs[k] || []).forEach(m => allSelectedMsgs.push(m));
      });

      if (allSelectedMsgs.length === 0) {
        // Nothing selected — clear everything
        clearChartMapHighlight();
        document.getElementById('dailyDrilldown').innerHTML = '';
        return;
      }

      // Update map highlighting — count messages per company
      const companyCounts = new Map();
      allSelectedMsgs.forEach(m => {
        if (m.company) m.company.split(', ').forEach(c => {
          if (c) companyCounts.set(c, (companyCounts.get(c) || 0) + 1);
        });
      });
      chartHighlightCompanies = companyCounts.size > 0 ? companyCounts : null;
      chartHighlightMax = 0;
      if (companyCounts.size > 0) {
        companyCounts.forEach(v => { if (v > chartHighlightMax) chartHighlightMax = v; });
      }
      updateMap();

      // Show map indicator
      const compCount = companyCounts.size;
      document.getElementById('chartMapIndicator').innerHTML = `
        <div class="chart-map-indicator">
          <span class="map-dot"></span>
          Showing ${compCount} compan${compCount !== 1 ? 'ies' : 'y'} on map from ${allSelectedKeys.length} selected bar${allSelectedKeys.length !== 1 ? 's' : ''}
          <button class="chart-map-clear" onclick="clearChartSelection()">Clear</button>
        </div>
      `;

      // Render combined drill-down
      const title = allSelectedKeys.length === 1
        ? formatBucketLabel(allSelectedKeys[0])
        : `${allSelectedKeys.length} periods selected`;
      renderDrilldown(title, allSelectedMsgs, formatBucketLabel, true);
    });
  });
}

function clearChartMapHighlight() {
  chartHighlightCompanies = null;
  chartHighlightMax = 0;
  updateMap();
  document.getElementById('chartMapIndicator').innerHTML = '';
}

function clearChartSelection() {
  document.querySelectorAll('#dailyOutreachChart .daily-chart-bar-wrap.selected').forEach(b => b.classList.remove('selected'));
  clearChartMapHighlight();
  document.getElementById('dailyDrilldown').innerHTML = '';
}

function getMediumClass(medium) {
  const m = (medium || '').toLowerCase();
  if (m.includes('call')) return 'drilldown-medium-call';
  if (m.includes('text') || m.includes('sms')) return 'drilldown-medium-text';
  if (m.includes('vm') || m.includes('voicemail')) return 'drilldown-medium-vm';
  if (m.includes('linkedin')) return 'drilldown-medium-linkedin';
  if (m.includes('email')) return 'drilldown-medium-email';
  return 'drilldown-medium-default';
}

function renderDrilldown(title, msgs, formatBucketLabel, isPreformatted) {
  if (!isPreformatted) title = formatBucketLabel(title);

  document.getElementById('dailyDrilldown').innerHTML = `
    <div class="drilldown-panel">
      <div class="drilldown-header">
        <span class="drilldown-title">${title}<span class="drilldown-count">${msgs.length} message${msgs.length !== 1 ? 's' : ''}</span></span>
        <button class="drilldown-close" onclick="clearChartSelection()">✕</button>
      </div>
      <div class="drilldown-table-wrap">
        <table class="drilldown-table">
          <thead><tr></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  `;

  const tableEl = document.querySelector('#dailyDrilldown .drilldown-table');
  const columns = [
    { key: 'date', label: 'Date', valueFn: m => m.date ? parseDateStr(m.date).getTime() : 0, defaultDir: 'desc' },
    { key: 'contact', label: 'Contact', valueFn: m => m.contact || '', defaultDir: 'asc' },
    { key: 'company', label: 'Company', valueFn: m => m.company || '', defaultDir: 'asc' },
    { key: 'method', label: 'Method', valueFn: m => m.medium || '', defaultDir: 'asc' },
    { key: 'account', label: 'Account', valueFn: m => m.account || '', defaultDir: 'asc' },
  ];
  const renderRow = m => {
    const medClass = getMediumClass(m.medium);
    return `<tr>
      <td>${m.date || '-'}</td>
      <td>${m.contact || '-'}</td>
      <td>${m.company || '-'}</td>
      <td><span class="drilldown-medium ${medClass}">${m.medium || '-'}</span></td>
      <td>${m.account || '-'}</td>
    </tr>`;
  };

  wireDrilldownSort(tableEl, msgs, columns, renderRow);
}

function formatDayLabel(isoKey, mode) {
  const d = new Date(isoKey + 'T12:00:00');
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  if (mode === 'day') return days[d.getDay()];
  if (mode === 'short') return `${months[d.getMonth()]} ${d.getDate()}`;
  return `${months[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
}

function initDailyOutreachChart() {
  // Wire range filter buttons
  document.querySelectorAll('#dailyRangeFilters .daily-filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('#dailyRangeFilters .daily-filter-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      dailyRange = this.dataset.range;
      clearChartMapHighlight();
      updateDailyOutreachChart();
    });
  });

  // Wire custom date range inputs
  const fromInput = document.getElementById('dailyDateFrom');
  const toInput = document.getElementById('dailyDateTo');
  const clearBtn = document.getElementById('dailyDateClear');

  function onDateChange() {
    customDateFrom = fromInput.value || '';
    customDateTo = toInput.value || '';
    fromInput.classList.toggle('active', !!customDateFrom);
    toInput.classList.toggle('active', !!customDateTo);
    clearBtn.classList.toggle('visible', !!(customDateFrom || customDateTo));
    clearChartMapHighlight();
    updateDailyOutreachChart();
  }

  fromInput.addEventListener('change', onDateChange);
  toInput.addEventListener('change', onDateChange);

  clearBtn.addEventListener('click', function() {
    customDateFrom = '';
    customDateTo = '';
    fromInput.value = '';
    toInput.value = '';
    fromInput.classList.remove('active');
    toInput.classList.remove('active');
    clearBtn.classList.remove('visible');
    clearChartMapHighlight();
    updateDailyOutreachChart();
  });

  updateDailyOutreachChart();
}

function setMapColorMode(mode) {
  mapColorMode = mode;
  // Update toggle button states
  document.querySelectorAll('.color-mode-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.colorMode === mode);
  });
  // Clear solo filter (don't trigger extra updateMap)
  if (soloFilter) {
    soloFilter = null;
    document.querySelectorAll('.filter-section.has-solo').forEach(s => s.classList.remove('has-solo'));
    document.querySelectorAll('.filter-btn.solo').forEach(b => b.classList.remove('solo'));
  }
  // Re-evaluate solo filter for the new mode's section
  const modeToType = { status: 'status', pipeline: 'pipeline', ownership: 'ownership' };
  const filterType = modeToType[mode];
  if (filterType) {
    const activeInSection = [...activeFilters[filterType]];
    if (activeInSection.length === 1) {
      const key = activeInSection[0];
      const def = filterDefs[filterType + ':' + key];
      if (def) {
        soloFilter = { type: filterType, key: key, color: def.color, fn: def.fn };
        const containerId = getSectionContainerId(filterType);
        const section = document.getElementById(containerId).closest('.filter-section');
        if (section) section.classList.add('has-solo');
        document.querySelectorAll(`.filter-btn[data-filter-type="${filterType}"]`).forEach(btn => {
          btn.classList.toggle('solo', btn.dataset.filterKey === key);
          if (btn.dataset.filterKey === key) btn.style.setProperty('--solo-color', def.color);
        });
      }
    }
  }
  updateMap();
  updateLegend();
}

function updateLegend() {
  let items = '';

  // If solo filter is active, show only that filter in the legend
  if (soloFilter) {
    const def = filterDefs[soloFilter.type + ':' + soloFilter.key];
    const label = def ? (document.querySelector(`.filter-btn[data-filter-type="${soloFilter.type}"][data-filter-key="${soloFilter.key}"]`)?.textContent?.replace(/\d+$/, '').trim() || soloFilter.key) : soloFilter.key;
    items = `<div class="legend-item"><span class="legend-dot" style="border-color:${soloFilter.color};background:${soloFilter.color}40"></span>${label}</div>` +
            `<div class="legend-item"><span class="legend-dot" style="border-color:#64748b;background:#64748b40"></span>Other</div>`;
    document.getElementById('mapLegend').innerHTML = items;
    return;
  }

  if (mapColorMode === 'ownership') {
    // Build legend from DOM order of ownership filter buttons
    const container = document.getElementById('ownershipFilters');
    if (container) {
      const buttons = container.querySelectorAll('.filter-btn[data-filter-type="ownership"]');
      buttons.forEach(btn => {
        const color = btn.dataset.filterColor;
        const label = btn.textContent.replace(/\d+$/, '').trim();
        if (btn.dataset.filterKey === 'bradford_facility' || btn.dataset.filterKey === 'bradford_op') {
          items += `<div class="legend-item"><svg viewBox="0 0 24 24" width="10" height="10" style="margin-right:4px;flex-shrink:0"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26" fill="${color}" stroke="rgba(255,255,255,0.6)" stroke-width="1.5"/></svg>${label}</div>`;
        } else {
          items += `<div class="legend-item"><span class="legend-dot" style="border-color:${color};background:${color}40"></span>${label}</div>`;
        }
      });
    } else {
      items = Object.entries(OWNERSHIP_COLORS)
        .filter(([k]) => filteredData.some(c => c.ownership === k))
        .map(([key, color]) => `<div class="legend-item"><span class="legend-dot" style="border-color:${color};background:${color}40"></span>${key}</div>`).join('');
    }
  } else if (mapColorMode === 'status') {
    // Build legend from DOM order of outreach filter buttons
    const container = document.getElementById('outreachFilters');
    if (container) {
      const buttons = container.querySelectorAll('.filter-btn[data-filter-type="status"]');
      buttons.forEach(btn => {
        const color = btn.dataset.filterColor;
        const label = btn.textContent.replace(/\d+$/, '').trim();
        items += `<div class="legend-item"><span class="legend-dot" style="border-color:${color};background:${color}40"></span>${label}</div>`;
      });
      items += `<div class="legend-item"><span class="legend-dot" style="border-color:#64748b;background:#64748b40"></span>Not Contacted</div>`;
    }
  } else if (mapColorMode === 'pipeline') {
    // Build legend from DOM order of pipeline filter buttons
    const container = document.getElementById('pipelineFilters');
    if (container) {
      const buttons = container.querySelectorAll('.filter-btn[data-filter-type="pipeline"]');
      buttons.forEach(btn => {
        const color = btn.dataset.filterColor;
        const label = btn.textContent.replace(/\d+$/, '').trim();
        items += `<div class="legend-item"><span class="legend-dot" style="border-color:${color};background:${color}40"></span>${label}</div>`;
      });
      items += `<div class="legend-item"><span class="legend-dot" style="border-color:#64748b;background:#64748b40"></span>Not in Pipeline</div>`;
    }
  }
  document.getElementById('mapLegend').innerHTML = items;
}

// ============================================================
// TABLE
// ============================================================
function getDisplayData() {
  if (!activeKPI) return filteredData;
  const kpiDef = KPI_DEFS.find(k => k.key === activeKPI);
  if (!kpiDef) return filteredData;
  return filteredData.filter(kpiDef.fn);
}

let tableSortKey = 'name';
let tableSortDir = 'asc'; // 'asc' or 'desc'

const TABLE_COLUMNS = [
  { key: 'name',       label: 'Company' },
  { key: 'state',      label: 'State' },
  { key: 'ownership',  label: 'Ownership' },
  { key: 'msgsSent',   label: 'Msgs' },
  { key: 'responded',  label: 'Responded' },
  { key: 'intro',      label: 'Intro' },
  { key: 'meeting',    label: 'Meeting' },
  { key: 'pipeline',   label: 'Pipeline' },
  { key: 'status',     label: 'Status' },
];

function getStatusRank(c) {
  if (c.notInterested) return 6;
  if (c.inPipeline) return 0;
  if (c.assistedMeeting) return 1;
  if (c.scheduledIntro) return 2;
  if (c.responded) return 3;
  if (c.msgsSent > 0) return 4;
  return 5;
}

function sortTableData(data) {
  const dir = tableSortDir === 'asc' ? 1 : -1;
  return [...data].sort((a, b) => {
    let va, vb;
    switch (tableSortKey) {
      case 'name':      va = a.name.toLowerCase(); vb = b.name.toLowerCase(); break;
      case 'state':     va = (a.fullState || a.state || '').toLowerCase(); vb = (b.fullState || b.state || '').toLowerCase(); break;
      case 'ownership': va = (a.ownership || '').toLowerCase(); vb = (b.ownership || '').toLowerCase(); break;
      case 'msgsSent':  return (a.msgsSent - b.msgsSent) * dir;
      case 'responded': return ((a.responded ? a.respondedCount : 0) - (b.responded ? b.respondedCount : 0)) * dir;
      case 'intro':     return ((a.scheduledIntro ? 1 : 0) - (b.scheduledIntro ? 1 : 0)) * dir;
      case 'meeting':   return ((a.assistedMeeting ? 1 : 0) - (b.assistedMeeting ? 1 : 0)) * dir;
      case 'pipeline':  va = (a.pipelineStatus || '').toLowerCase(); vb = (b.pipelineStatus || '').toLowerCase(); break;
      case 'status':    return (getStatusRank(a) - getStatusRank(b)) * dir;
      default:          va = ''; vb = '';
    }
    return va < vb ? -dir : va > vb ? dir : 0;
  });
}

function updateTable() {
  const displayData = sortTableData(getDisplayData());
  const arrow = tableSortDir === 'asc' ? '▲' : '▼';
  document.getElementById('tableContainer').innerHTML = `
    <table class="data-table"><thead><tr>
      ${TABLE_COLUMNS.map(col =>
        `<th class="${tableSortKey === col.key ? 'sorted' : ''}" data-sort="${col.key}">${col.label}<span class="sort-arrow">${tableSortKey === col.key ? arrow : '▲'}</span></th>`
      ).join('')}
    </tr></thead><tbody>
      ${displayData.map(c => {
        const sc = c.inPipeline ? '#ec4899' : c.assistedMeeting ? '#10b981' : c.scheduledIntro ? '#8b5cf6' : c.responded ? '#3b82f6' : c.msgsSent > 0 ? '#f59e0b' : '#64748b';
        const sl = c.notInterested ? 'Not Interested' : c.inPipeline ? 'Pipeline' : c.assistedMeeting ? 'Meeting' : c.scheduledIntro ? 'Intro' : c.responded ? 'Responded' : c.msgsSent > 0 ? 'Contacted' : 'None';
        return `<tr>
          <td style="font-weight:600;color:var(--text-primary)">${c.bradfordFacility === 'Bradford OP Office' ? '<span style="color:#a855f7;margin-right:4px" title="Bradford OP Office">⭐</span>' : c.bradfordFacility ? '<span style="color:#fbbf24;margin-right:4px" title="Bradford Facility">⭐</span>' : ''}${c.website ? `<a href="${c.website}" target="_blank" style="color:var(--accent-blue);text-decoration:none">${c.name}</a>` : c.name}</td>
          <td>${c.fullState || c.state}</td>
          <td><span style="color:${OWNERSHIP_COLORS[c.ownership] || '#94a3b8'}">${c.ownership || '-'}</span></td>
          <td>${c.msgsSent}</td>
          <td>${c.responded ? c.respondedCount : '-'}</td>
          <td>${c.scheduledIntro ? 'Yes' : '-'}</td>
          <td>${c.assistedMeeting ? 'Yes' : '-'}</td>
          <td>${c.pipelineStatus || '-'}</td>
          <td><span class="status-dot" style="background:${sc}"></span>${sl}</td>
        </tr>`;
      }).join('')}
    </tbody></table>
  `;

  // Wire sort click handlers
  document.querySelectorAll('.data-table th[data-sort]').forEach(th => {
    th.addEventListener('click', function() {
      const key = this.dataset.sort;
      if (tableSortKey === key) {
        tableSortDir = tableSortDir === 'asc' ? 'desc' : 'asc';
      } else {
        tableSortKey = key;
        tableSortDir = 'asc';
      }
      updateTable();
    });
  });
}

// ============================================================
// VIEW TOGGLE
// ============================================================
function setView(view) {
  document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
  document.querySelector(`.view-btn[onclick="setView('${view}')"]`).classList.add('active');
  const mapWrap = document.getElementById('mapWrapper');
  const tableEl = document.getElementById('tableContainer');
  if (view === 'map') { mapWrap.style.display = 'block'; tableEl.style.display = 'none'; setTimeout(() => map.invalidateSize(), 100); }
  else { mapWrap.style.display = 'none'; tableEl.style.display = 'block'; updateTable(); }
}

// ============================================================
// SECTION TAB SWITCHING
// ============================================================
function switchTab(tabName) {
  // Update tab buttons
  document.querySelectorAll('.section-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.section-tab[data-tab="${tabName}"]`).classList.add('active');

  // Update panels
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  const panelMap = { pipeline: 'panelPipeline', actions: 'panelActions', reporting: 'panelReporting' };
  document.getElementById(panelMap[tabName]).classList.add('active');
}

// ============================================================


const STATE_COORDS_JS = {"AL":[32.81,-86.79],"AK":[61.37,-152.40],"AZ":[33.73,-111.43],"AR":[34.97,-92.37],"CA":[36.12,-119.68],"CO":[39.06,-105.31],"CT":[41.60,-72.76],"DE":[39.32,-75.51],"FL":[27.77,-81.69],"GA":[33.04,-83.64],"HI":[21.09,-157.50],"ID":[44.24,-114.48],"IL":[40.35,-88.99],"IN":[39.85,-86.26],"IA":[42.01,-93.21],"KS":[38.53,-96.73],"KY":[37.67,-84.67],"LA":[31.17,-91.87],"ME":[44.69,-69.38],"MD":[39.06,-76.80],"MA":[42.23,-71.53],"MI":[43.33,-84.54],"MN":[45.69,-93.90],"MS":[32.74,-89.68],"MO":[38.46,-92.29],"MT":[46.92,-110.45],"NE":[41.13,-98.27],"NV":[38.31,-117.06],"NH":[43.45,-71.56],"NJ":[40.30,-74.52],"NM":[34.84,-106.25],"NY":[42.17,-74.95],"NC":[35.63,-79.81],"ND":[47.53,-99.78],"OH":[40.39,-82.76],"OK":[35.57,-96.93],"OR":[44.57,-122.07],"PA":[40.59,-77.21],"RI":[41.68,-71.51],"SC":[33.86,-80.95],"SD":[44.30,-99.44],"TN":[35.75,-86.69],"TX":[31.05,-97.56],"UT":[40.15,-111.86],"VT":[44.05,-72.71],"VA":[37.77,-78.17],"WA":[47.40,-121.49],"WV":[38.49,-80.95],"WI":[44.27,-89.62],"WY":[42.76,-107.30],"DC":[38.90,-77.03]};
const STATE_ABBREV_JS = {"Alabama":"AL","Alaska":"AK","Arizona":"AZ","Arkansas":"AR","California":"CA","Colorado":"CO","Connecticut":"CT","Delaware":"DE","Florida":"FL","Georgia":"GA","Hawaii":"HI","Idaho":"ID","Illinois":"IL","Indiana":"IN","Iowa":"IA","Kansas":"KS","Kentucky":"KY","Louisiana":"LA","Maine":"ME","Maryland":"MD","Massachusetts":"MA","Michigan":"MI","Minnesota":"MN","Mississippi":"MS","Missouri":"MO","Montana":"MT","Nebraska":"NE","Nevada":"NV","New Hampshire":"NH","New Jersey":"NJ","New Mexico":"NM","New York":"NY","North Carolina":"NC","North Dakota":"ND","Ohio":"OH","Oklahoma":"OK","Oregon":"OR","Pennsylvania":"PA","Rhode Island":"RI","South Carolina":"SC","South Dakota":"SD","Tennessee":"TN","Texas":"TX","Utah":"UT","Vermont":"VT","Virginia":"VA","Washington":"WA","West Virginia":"WV","Wisconsin":"WI","Wyoming":"WY"};

// Full state name -> abbreviation for label display
const STATE_NAME_TO_ABBR = {};
Object.entries(STATE_ABBREV_JS).forEach(([full, abbr]) => { STATE_NAME_TO_ABBR[full] = abbr; });

function hashCode(s) { let h = 0; for (let i = 0; i < s.length; i++) { h = ((h << 5) - h) + s.charCodeAt(i); h |= 0; } return Math.abs(h); }

function getCoords(state, name) {
  let abbr = state;
  if (state.length > 2) abbr = STATE_ABBREV_JS[state] || state;
  if (!STATE_COORDS_JS[abbr]) return [null, null];
  let [lat, lng] = STATE_COORDS_JS[abbr];
  const h = hashCode(name);
  lat += ((h % 1000) / 1000 - 0.5) * 0.8;
  lng += (((h >> 10) % 1000) / 1000 - 0.5) * 0.8;
  return [lat, lng];
}


// ============================================================
init();
</script>
<div id="toast" class="toast"></div>
</body>
</html>
